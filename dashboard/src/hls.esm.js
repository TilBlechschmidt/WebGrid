function e(e,t){return t.forEach((function(t){Object.keys(t).forEach((function(r){if("default"!==r&&!(r in e)){var i=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,i.get?i:{enumerable:!0,get:function(){return t[r]}})}}))})),Object.freeze(e)}function t(e,t,r){return e(r={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&r.path)}},r.exports),r.exports}var r,i,a,s=t((function(e,t){var r,i,a,s,n;r=/^((?:[a-zA-Z0-9+\-.]+:)?)(\/\/[^\/?#]*)?((?:[^\/?#]*\/)*[^;?#]*)?(;[^?#]*)?(\?[^#]*)?(#[^]*)?$/,i=/^([^\/?#]*)([^]*)$/,a=/(?:\/|^)\.(?=\/)/g,s=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,n={buildAbsoluteURL:function(e,t,r){if(r=r||{},e=e.trim(),!(t=t.trim())){if(!r.alwaysNormalize)return e;var a=n.parseURL(e);if(!a)throw new Error("Error trying to parse base URL.");return a.path=n.normalizePath(a.path),n.buildURLFromParts(a)}var s=n.parseURL(t);if(!s)throw new Error("Error trying to parse relative URL.");if(s.scheme)return r.alwaysNormalize?(s.path=n.normalizePath(s.path),n.buildURLFromParts(s)):t;var o=n.parseURL(e);if(!o)throw new Error("Error trying to parse base URL.");if(!o.netLoc&&o.path&&"/"!==o.path[0]){var l=i.exec(o.path);o.netLoc=l[1],o.path=l[2]}o.netLoc&&!o.path&&(o.path="/");var h={scheme:o.scheme,netLoc:s.netLoc,path:null,params:s.params,query:s.query,fragment:s.fragment};if(!s.netLoc&&(h.netLoc=o.netLoc,"/"!==s.path[0]))if(s.path){var d=o.path,u=d.substring(0,d.lastIndexOf("/")+1)+s.path;h.path=n.normalizePath(u)}else h.path=o.path,s.params||(h.params=o.params,s.query||(h.query=o.query));return null===h.path&&(h.path=r.alwaysNormalize?n.normalizePath(s.path):s.path),n.buildURLFromParts(h)},parseURL:function(e){var t=r.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(a,"");e.length!==(e=e.replace(s,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}},e.exports=n}));!function(e){e.MEDIA_ATTACHING="hlsMediaAttaching",e.MEDIA_ATTACHED="hlsMediaAttached",e.MEDIA_DETACHING="hlsMediaDetaching",e.MEDIA_DETACHED="hlsMediaDetached",e.BUFFER_RESET="hlsBufferReset",e.BUFFER_CODECS="hlsBufferCodecs",e.BUFFER_CREATED="hlsBufferCreated",e.BUFFER_APPENDING="hlsBufferAppending",e.BUFFER_APPENDED="hlsBufferAppended",e.BUFFER_EOS="hlsBufferEos",e.BUFFER_FLUSHING="hlsBufferFlushing",e.BUFFER_FLUSHED="hlsBufferFlushed",e.MANIFEST_LOADING="hlsManifestLoading",e.MANIFEST_LOADED="hlsManifestLoaded",e.MANIFEST_PARSED="hlsManifestParsed",e.LEVEL_SWITCHING="hlsLevelSwitching",e.LEVEL_SWITCHED="hlsLevelSwitched",e.LEVEL_LOADING="hlsLevelLoading",e.LEVEL_LOADED="hlsLevelLoaded",e.LEVEL_UPDATED="hlsLevelUpdated",e.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",e.LEVELS_UPDATED="hlsLevelsUpdated",e.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",e.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",e.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",e.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",e.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",e.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",e.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",e.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",e.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",e.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",e.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",e.CUES_PARSED="hlsCuesParsed",e.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",e.INIT_PTS_FOUND="hlsInitPtsFound",e.FRAG_LOADING="hlsFragLoading",e.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",e.FRAG_LOADED="hlsFragLoaded",e.FRAG_DECRYPTED="hlsFragDecrypted",e.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",e.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",e.FRAG_PARSING_METADATA="hlsFragParsingMetadata",e.FRAG_PARSED="hlsFragParsed",e.FRAG_BUFFERED="hlsFragBuffered",e.FRAG_CHANGED="hlsFragChanged",e.FPS_DROP="hlsFpsDrop",e.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",e.ERROR="hlsError",e.DESTROYING="hlsDestroying",e.KEY_LOADING="hlsKeyLoading",e.KEY_LOADED="hlsKeyLoaded",e.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",e.BACK_BUFFER_REACHED="hlsBackBufferReached"}(r||(r={})),function(e){e.NETWORK_ERROR="networkError",e.MEDIA_ERROR="mediaError",e.KEY_SYSTEM_ERROR="keySystemError",e.MUX_ERROR="muxError",e.OTHER_ERROR="otherError"}(i||(i={})),function(e){e.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",e.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",e.KEY_SYSTEM_NO_SESSION="keySystemNoSession",e.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",e.KEY_SYSTEM_NO_INIT_DATA="keySystemNoInitData",e.MANIFEST_LOAD_ERROR="manifestLoadError",e.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",e.MANIFEST_PARSING_ERROR="manifestParsingError",e.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",e.LEVEL_EMPTY_ERROR="levelEmptyError",e.LEVEL_LOAD_ERROR="levelLoadError",e.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",e.LEVEL_SWITCH_ERROR="levelSwitchError",e.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",e.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",e.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",e.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",e.FRAG_LOAD_ERROR="fragLoadError",e.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",e.FRAG_DECRYPT_ERROR="fragDecryptError",e.FRAG_PARSING_ERROR="fragParsingError",e.REMUX_ALLOC_ERROR="remuxAllocError",e.KEY_LOAD_ERROR="keyLoadError",e.KEY_LOAD_TIMEOUT="keyLoadTimeOut",e.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",e.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",e.BUFFER_APPEND_ERROR="bufferAppendError",e.BUFFER_APPENDING_ERROR="bufferAppendingError",e.BUFFER_STALLED_ERROR="bufferStalledError",e.BUFFER_FULL_ERROR="bufferFullError",e.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",e.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",e.INTERNAL_EXCEPTION="internalException",e.INTERNAL_ABORTED="aborted",e.UNKNOWN="unknown"}(a||(a={}));var n=function(){},o={trace:n,debug:n,log:n,warn:n,info:n,error:n},l=o;function h(e){var t=self.console[e];return t?t.bind(self.console,"["+e+"] >"):n}function d(e){if(self.console&&!0===e||"object"==typeof e){!function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];r.forEach((function(t){l[t]=e[t]?e[t].bind(e):h(t)}))}(e,"debug","log","info","warn","error");try{l.log()}catch(e){l=o}}else l=o}var u,c=l;function f(e,t,r){return Uint8Array.prototype.slice?e.slice(t,r):new Uint8Array(Array.prototype.slice.call(e,t,r))}class g{static fromURL(e,t){return new g(e,t)}static fromURI(e){return new g(e)}constructor(e,t){this._uri=null,this.method=null,this.keyFormat=null,this.keyFormatVersions=null,this.keyID=null,this.key=null,this.iv=null,this._uri=t?s.buildAbsoluteURL(e,t,{alwaysNormalize:!0}):e}get uri(){return this._uri}}class v{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}!function(e){e.AUDIO="audio",e.VIDEO="video",e.AUDIOVIDEO="audiovideo"}(u||(u={}));class m{constructor(e){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[u.AUDIO]:null,[u.VIDEO]:null,[u.AUDIOVIDEO]:null},this.baseurl=e}setByteRange(e,t){var r=e.split("@",2),i=[];1===r.length?i[0]=t?t.byteRangeEndOffset:0:i[0]=parseInt(r[1]),i[1]=parseInt(r[0])+i[0],this._byteRange=i}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=s.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}}class p extends m{constructor(e,t){super(t),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkey=void 0,this.type=void 0,this.loader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.appendedPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new v,this.urlId=0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.type=e}get decryptdata(){if(!this.levelkey&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkey){var e=this.sn;"number"!=typeof e&&(this.levelkey&&"AES-128"===this.levelkey.method&&!this.levelkey.iv&&c.warn('missing IV for initialization segment with method="'+this.levelkey.method+'" - compliance issue'),e=0),this._decryptdata=this.setDecryptDataFromLevelKey(this.levelkey,e)}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime)return null;if(!Number.isFinite(this.programDateTime))return null;var e=Number.isFinite(this.duration)?this.duration:0;return this.programDateTime+1e3*e}get encrypted(){var e;return!(null===(e=this.decryptdata)||void 0===e||!e.keyFormat||!this.decryptdata.uri)}createInitializationVector(e){for(var t=new Uint8Array(16),r=12;r<16;r++)t[r]=e>>8*(15-r)&255;return t}setDecryptDataFromLevelKey(e,t){var r=e;return"AES-128"===(null==e?void 0:e.method)&&e.uri&&!e.iv&&((r=g.fromURI(e.uri)).method=e.method,r.iv=this.createInitializationVector(t),r.keyFormat="identity"),r}setElementaryStreamInfo(e,t,r,i,a,s){void 0===s&&(s=!1);var{elementaryStreams:n}=this,o=n[e];o?(o.startPTS=Math.min(o.startPTS,t),o.endPTS=Math.max(o.endPTS,r),o.startDTS=Math.min(o.startDTS,i),o.endDTS=Math.max(o.endDTS,a)):n[e]={startPTS:t,endPTS:r,startDTS:i,endDTS:a,partial:s}}clearElementaryStreamInfo(){var{elementaryStreams:e}=this;e[u.AUDIO]=null,e[u.VIDEO]=null,e[u.AUDIOVIDEO]=null}}class T extends m{constructor(e,t,r,i,a){super(r),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new v,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=i;var s=e.enumeratedString("BYTERANGE");s&&this.setByteRange(s,a),a&&(this.fragOffset=a.fragOffset+a.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){var{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}var y=Math.pow(2,32)-1,E=[].push;function S(e){return String.fromCharCode.apply(null,e)}function L(e,t){"data"in e&&(t+=e.start,e=e.data);var r=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3];return r<0?4294967296+r:r}function b(e,t,r){"data"in e&&(t+=e.start,e=e.data),e[t]=r>>24,e[t+1]=r>>16&255,e[t+2]=r>>8&255,e[t+3]=255&r}function A(e,t){var r,i,a,s=[];if(!t.length)return s;"data"in e?(r=e.data,i=e.start,a=e.end):(i=0,a=(r=e).byteLength);for(var n=i;n<a;){var o=L(r,n),l=o>1?n+o:a;if(S(r.subarray(n+4,n+8))===t[0])if(1===t.length)s.push({data:r,start:n+8,end:l});else{var h=A({data:r,start:n+8,end:l},t.slice(1));h.length&&E.apply(s,h)}n=l}return s}function R(e){var t=A(e,["moov"])[0],r=t?t.end:null,i=A(e,["sidx"]);if(!i||!i[0])return null;var a=[],s=i[0],n=s.data[0],o=0===n?8:16,l=L(s,o);o+=4;o+=0===n?8:16,o+=2;var h=s.end+0,d=function(e,t){"data"in e&&(t+=e.start,e=e.data);var r=e[t]<<8|e[t+1];return r<0?65536+r:r}(s,o);o+=2;for(var u=0;u<d;u++){var c=o,f=L(s,c);c+=4;var g=2147483647&f;if(1===(2147483648&f)>>>31)return console.warn("SIDX has hierarchical references (not supported)"),null;var v=L(s,c);c+=4,a.push({referenceSize:g,subsegmentDuration:v,info:{duration:v/l,start:h,end:h+g-1}}),h+=g,o=c+=4}return{earliestPresentationTime:0,timescale:l,version:n,referencesCount:d,references:a,moovEndOffset:r}}function D(e){var t=L(e,0),r=8;1&t&&(r+=4),4&t&&(r+=4);for(var i=0,a=L(e,4),s=0;s<a;s++){if(256&t)i+=L(e,r),r+=4;512&t&&(r+=4),1024&t&&(r+=4),2048&t&&(r+=4)}return i}function k(e,t){var r=new Uint8Array(e.length+t.length);return r.set(e),r.set(t,e.length),r}class C{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.needSidxRanges=!1,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.fragments=[],this.url=e}reloaded(e){if(!e)return this.advanced=!0,void(this.updated=!0);var t=this.lastPartSn-e.lastPartSn,r=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!r||!!t,this.advanced=this.endSN>e.endSN||t>0||0===t&&r>0,this.updated||this.advanced?this.misses=Math.floor(.6*e.misses):this.misses=e.misses+1,this.availabilityDelay=e.availabilityDelay}get hasProgramDateTime(){return!!this.fragments.length&&Number.isFinite(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||10}get drift(){var e=this.driftEndTime-this.driftStartTime;return e>0?1e3*(this.driftEnd-this.driftStart)/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return null!==(e=this.partList)&&void 0!==e&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return null!==(e=this.fragments)&&void 0!==e&&e.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return null!==(e=this.partList)&&void 0!==e&&e.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var e;return null!==(e=this.partList)&&void 0!==e&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}var _=/^(\d+)x(\d+)$/,I=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g;class w{constructor(e){for(var t in"string"==typeof e&&(e=w.parseAttrList(e)),e)e.hasOwnProperty(t)&&(this[t]=e[t])}decimalInteger(e){var t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){var t=(this[e]||"0x").slice(2);t=(1&t.length?"0":"")+t;for(var r=new Uint8Array(t.length/2),i=0;i<t.length/2;i++)r[i]=parseInt(t.slice(2*i,2*i+2),16);return r}return null}hexadecimalIntegerAsNumber(e){var t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){var r=this[e];return r?parseFloat(r):t}enumeratedString(e){return this[e]}bool(e){return"YES"===this[e]}decimalResolution(e){var t=_.exec(this[e]);if(null!==t)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e){var t,r={};for(I.lastIndex=0;null!==(t=I.exec(e));){var i=t[2];0===i.indexOf('"')&&i.lastIndexOf('"')===i.length-1&&(i=i.slice(1,-1)),r[t[1]]=i}return r}}var x={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,av01:!0,drac:!0,dvav:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0},text:{stpp:!0,wvtt:!0}};function O(e,t){return MediaSource.isTypeSupported((t||"video")+'/mp4;codecs="'+e+'"')}var P,F,M=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-SESSION-DATA:([^\r\n]*)[\r\n]+/g,N=/#EXT-X-MEDIA:(.*)/g,U=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),B=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(PLAYLIST-TYPE):(.+)/.source,/#EXT-X-(MEDIA-SEQUENCE): *(\d+)/.source,/#EXT-X-(SKIP):(.+)/.source,/#EXT-X-(TARGETDURATION): *(\d+)/.source,/#EXT-X-(KEY):(.+)/.source,/#EXT-X-(START):(.+)/.source,/#EXT-X-(ENDLIST)/.source,/#EXT-X-(DISCONTINUITY-SEQ)UENCE: *(\d+)/.source,/#EXT-X-(DIS)CONTINUITY/.source,/#EXT-X-(VERSION):(\d+)/.source,/#EXT-X-(MAP):(.+)/.source,/#EXT-X-(SERVER-CONTROL):(.+)/.source,/#EXT-X-(PART-INF):(.+)/.source,/#EXT-X-(GAP)/.source,/#EXT-X-(BITRATE):\s*(\d+)/.source,/#EXT-X-(PART):(.+)/.source,/#EXT-X-(PRELOAD-HINT):(.+)/.source,/#EXT-X-(RENDITION-REPORT):(.+)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|")),G=/\.(mp4|m4s|m4v|m4a)$/i;class H{static findGroup(e,t){for(var r=0;r<e.length;r++){var i=e[r];if(i.id===t)return i}}static convertAVC1ToAVCOTI(e){var t=e.split(".");if(t.length>2){var r=t.shift()+".";return r+=parseInt(t.shift()).toString(16),r+=("000"+parseInt(t.shift()).toString(16)).substr(-4)}return e}static resolve(e,t){return s.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static parseMasterPlaylist(e,t){var r,i=[],a={},s=!1;for(M.lastIndex=0;null!=(r=M.exec(e));)if(r[1]){var n=new w(r[1]),o={attrs:n,bitrate:n.decimalInteger("AVERAGE-BANDWIDTH")||n.decimalInteger("BANDWIDTH"),name:n.NAME,url:H.resolve(r[2],t)},l=n.decimalResolution("RESOLUTION");l&&(o.width=l.width,o.height=l.height),K((n.CODECS||"").split(/[ ,]+/).filter((e=>e)),o),o.videoCodec&&-1!==o.videoCodec.indexOf("avc1")&&(o.videoCodec=H.convertAVC1ToAVCOTI(o.videoCodec)),i.push(o)}else if(r[3]){var h=new w(r[3]);h["DATA-ID"]&&(s=!0,a[h["DATA-ID"]]=h)}return{levels:i,sessionData:s?a:null}}static parseMasterPlaylistMedia(e,t,r,i){var a;void 0===i&&(i=[]);var s=[],n=0;for(N.lastIndex=0;null!==(a=N.exec(e));){var o=new w(a[1]);if(o.TYPE===r){var l={attrs:o,bitrate:0,id:n++,groupId:o["GROUP-ID"],instreamId:o["INSTREAM-ID"],name:o.NAME||o.LANGUAGE||"",type:r,default:o.bool("DEFAULT"),autoselect:o.bool("AUTOSELECT"),forced:o.bool("FORCED"),lang:o.LANGUAGE,url:o.URI?H.resolve(o.URI,t):""};if(i.length){var h=H.findGroup(i,l.groupId)||i[0];V(l,h,"audioCodec"),V(l,h,"textCodec")}s.push(l)}}return s}static parseLevelPlaylist(e,t,r,i,a){var n,o,l,h=new C(t),d=h.fragments,u=null,f=0,v=0,m=0,y=0,E=null,S=new p(i,t),L=-1,b=!1;for(U.lastIndex=0,h.m3u8=e;null!==(n=U.exec(e));){b&&(b=!1,(S=new p(i,t)).start=m,S.sn=f,S.cc=y,S.level=r,u&&(S.initSegment=u,S.rawProgramDateTime=u.rawProgramDateTime));var A=n[1];if(A){S.duration=parseFloat(A);var R=(" "+n[2]).slice(1);S.title=R||null,S.tagList.push(R?["INF",A,R]:["INF",A])}else if(n[3])Number.isFinite(S.duration)&&(S.start=m,l&&(S.levelkey=l),S.sn=f,S.level=r,S.cc=y,S.urlId=a,d.push(S),S.relurl=(" "+n[3]).slice(1),j(S,E),E=S,m+=S.duration,f++,v=0,b=!0);else if(n[4]){var D=(" "+n[4]).slice(1);E?S.setByteRange(D,E):S.setByteRange(D)}else if(n[5])S.rawProgramDateTime=(" "+n[5]).slice(1),S.tagList.push(["PROGRAM-DATE-TIME",S.rawProgramDateTime]),-1===L&&(L=d.length);else{if(!(n=n[0].match(B))){c.warn("No matches on slow regex match for level playlist!");continue}for(o=1;o<n.length&&void 0===n[o];o++);var k=(" "+n[o]).slice(1),_=(" "+n[o+1]).slice(1),I=n[o+2]?(" "+n[o+2]).slice(1):"";switch(k){case"PLAYLIST-TYPE":h.type=_.toUpperCase();break;case"MEDIA-SEQUENCE":f=h.startSN=parseInt(_);break;case"SKIP":var x=new w(_),O=x.decimalInteger("SKIPPED-SEGMENTS");if(Number.isFinite(O)){h.skippedSegments=O;for(var P=O;P--;)d.unshift(null);f+=O}var F=x.enumeratedString("RECENTLY-REMOVED-DATERANGES");F&&(h.recentlyRemovedDateranges=F.split("\t"));break;case"TARGETDURATION":h.targetduration=parseFloat(_);break;case"VERSION":h.version=parseInt(_);break;case"EXTM3U":break;case"ENDLIST":h.live=!1;break;case"#":(_||I)&&S.tagList.push(I?[_,I]:[_]);break;case"DIS":y++;case"GAP":S.tagList.push([k]);break;case"BITRATE":S.tagList.push([k,_]);break;case"DISCONTINUITY-SEQ":y=parseInt(_);break;case"KEY":var M,N=new w(_),H=N.enumeratedString("METHOD"),K=N.URI,V=N.hexadecimalInteger("IV"),W=N.enumeratedString("KEYFORMATVERSIONS"),q=N.enumeratedString("KEYID"),X=null!=(M=N.enumeratedString("KEYFORMAT"))?M:"identity";if(["com.apple.streamingkeydelivery","com.microsoft.playready","urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed","com.widevine"].indexOf(X)>-1){c.warn("Keyformat "+X+" is not supported from the manifest");continue}if("identity"!==X)continue;H&&(l=g.fromURL(t,K),K&&["AES-128","SAMPLE-AES","SAMPLE-AES-CENC"].indexOf(H)>=0&&(l.method=H,l.keyFormat=X,q&&(l.keyID=q),W&&(l.keyFormatVersions=W),l.iv=V));break;case"START":var Y=new w(_).decimalFloatingPoint("TIME-OFFSET");Number.isFinite(Y)&&(h.startTimeOffset=Y);break;case"MAP":var z=new w(_);S.relurl=z.URI,z.BYTERANGE&&S.setByteRange(z.BYTERANGE),S.level=r,S.sn="initSegment",l&&(S.levelkey=l),S.initSegment=null,u=S,b=!0;break;case"SERVER-CONTROL":var Q=new w(_);h.canBlockReload=Q.bool("CAN-BLOCK-RELOAD"),h.canSkipUntil=Q.optionalFloat("CAN-SKIP-UNTIL",0),h.canSkipDateRanges=h.canSkipUntil>0&&Q.bool("CAN-SKIP-DATERANGES"),h.partHoldBack=Q.optionalFloat("PART-HOLD-BACK",0),h.holdBack=Q.optionalFloat("HOLD-BACK",0);break;case"PART-INF":var $=new w(_);h.partTarget=$.decimalFloatingPoint("PART-TARGET");break;case"PART":var Z=h.partList;Z||(Z=h.partList=[]);var J=v>0?Z[Z.length-1]:void 0,ee=v++,te=new T(new w(_),S,t,ee,J);Z.push(te),S.duration+=te.duration;break;case"PRELOAD-HINT":var re=new w(_);h.preloadHint=re;break;case"RENDITION-REPORT":var ie=new w(_);h.renditionReports=h.renditionReports||[],h.renditionReports.push(ie);break;default:c.warn("line parsed but not handled: "+n)}}}E&&!E.relurl?(d.pop(),m-=E.duration,h.partList&&(h.fragmentHint=E)):h.partList&&(j(S,E),S.cc=y,h.fragmentHint=S);var ae=d.length,se=d[0],ne=d[ae-1];if((m+=h.skippedSegments*h.targetduration)>0&&ae&&ne){h.averagetargetduration=m/ae;var oe=ne.sn;h.endSN="initSegment"!==oe?oe:0,se&&(h.startCC=se.cc,se.initSegment||h.fragments.every((e=>{return e.relurl&&(t=e.relurl,G.test(null!=(r=null===(i=s.parseURL(t))||void 0===i?void 0:i.path)?r:""));var t,r,i}))&&(c.warn("MP4 fragments found but no init segment (probably no MAP, incomplete M3U8), trying to fetch SIDX"),(S=new p(i,t)).relurl=ne.relurl,S.level=r,S.sn="initSegment",se.initSegment=S,h.needSidxRanges=!0))}else h.endSN=0,h.startCC=0;return h.fragmentHint&&(m+=h.fragmentHint.duration),h.totalduration=m,h.endCC=y,L>0&&function(e,t){for(var r=e[t],i=t;i--;){var a=e[i];if(!a)return;a.programDateTime=r.programDateTime-1e3*a.duration,r=a}}(d,L),h}}function K(e,t){["video","audio","text"].forEach((r=>{var i=e.filter((e=>function(e,t){var r=x[t];return!!r&&!0===r[e.slice(0,4)]}(e,r)));if(i.length){var a=i.filter((e=>0===e.lastIndexOf("avc1",0)||0===e.lastIndexOf("mp4a",0)));t[r+"Codec"]=a.length>0?a[0]:i[0],e=e.filter((e=>-1===i.indexOf(e)))}})),t.unknownCodecs=e}function V(e,t,r){var i=t[r];i&&(e[r]=i)}function j(e,t){e.rawProgramDateTime?e.programDateTime=Date.parse(e.rawProgramDateTime):null!=t&&t.programDateTime&&(e.programDateTime=t.endProgramDateTime),Number.isFinite(e.programDateTime)||(e.programDateTime=null,e.rawProgramDateTime=null)}function W(e,t){var r=e.url;return void 0!==r&&0!==r.indexOf("data:")||(r=t.url),r}!function(e){e.MANIFEST="manifest",e.LEVEL="level",e.AUDIO_TRACK="audioTrack",e.SUBTITLE_TRACK="subtitleTrack"}(P||(P={})),function(e){e.MAIN="main",e.AUDIO="audio",e.SUBTITLE="subtitle"}(F||(F={}));class q{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.hls=e,this.registerListeners()}registerListeners(){var{hls:e}=this;e.on(r.MANIFEST_LOADING,this.onManifestLoading,this),e.on(r.LEVEL_LOADING,this.onLevelLoading,this),e.on(r.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(r.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){var{hls:e}=this;e.off(r.MANIFEST_LOADING,this.onManifestLoading,this),e.off(r.LEVEL_LOADING,this.onLevelLoading,this),e.off(r.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(r.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(e){var t=this.hls.config,r=t.pLoader,i=t.loader,a=new(r||i)(t);return e.loader=a,this.loaders[e.type]=a,a}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(var e in this.loaders){var t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){var{url:r}=t;this.load({id:null,groupId:null,level:0,responseType:"text",type:P.MANIFEST,url:r,deliveryDirectives:null})}onLevelLoading(e,t){var{id:r,level:i,url:a,deliveryDirectives:s}=t;this.load({id:r,groupId:null,level:i,responseType:"text",type:P.LEVEL,url:a,deliveryDirectives:s})}onAudioTrackLoading(e,t){var{id:r,groupId:i,url:a,deliveryDirectives:s}=t;this.load({id:r,groupId:i,level:null,responseType:"text",type:P.AUDIO_TRACK,url:a,deliveryDirectives:s})}onSubtitleTrackLoading(e,t){var{id:r,groupId:i,url:a,deliveryDirectives:s}=t;this.load({id:r,groupId:i,level:null,responseType:"text",type:P.SUBTITLE_TRACK,url:a,deliveryDirectives:s})}load(e){var t,r,i,a,s,n,o=this.hls.config,l=this.getInternalLoader(e);if(l){var h=l.context;if(h&&h.url===e.url)return void c.trace("[playlist-loader]: playlist request ongoing");c.log("[playlist-loader]: aborting previous loader for type: "+e.type),l.abort()}switch(e.type){case P.MANIFEST:r=o.manifestLoadingMaxRetry,i=o.manifestLoadingTimeOut,a=o.manifestLoadingRetryDelay,s=o.manifestLoadingMaxRetryTimeout;break;case P.LEVEL:case P.AUDIO_TRACK:case P.SUBTITLE_TRACK:r=0,i=o.levelLoadingTimeOut;break;default:r=o.levelLoadingMaxRetry,i=o.levelLoadingTimeOut,a=o.levelLoadingRetryDelay,s=o.levelLoadingMaxRetryTimeout}if((l=this.createInternalLoader(e),null!==(t=e.deliveryDirectives)&&void 0!==t&&t.part)&&(e.type===P.LEVEL&&null!==e.level?n=this.hls.levels[e.level].details:e.type===P.AUDIO_TRACK&&null!==e.id?n=this.hls.audioTracks[e.id].details:e.type===P.SUBTITLE_TRACK&&null!==e.id&&(n=this.hls.subtitleTracks[e.id].details),n)){var d=n.partTarget,u=n.targetduration;d&&u&&(i=Math.min(1e3*Math.max(3*d,.8*u),i))}var f={timeout:i,maxRetry:r,retryDelay:a,maxRetryDelay:s,highWaterMark:0},g={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};l.load(e,f,g)}loadsuccess(e,t,r,i){if(void 0===i&&(i=null),r.isSidxRequest)return this.handleSidxRequest(e,r),void this.handlePlaylistLoaded(e,t,r,i);this.resetInternalLoader(r.type);var a=e.data;0===a.indexOf("#EXTM3U")?(t.parsing.start=performance.now(),a.indexOf("#EXTINF:")>0||a.indexOf("#EXT-X-TARGETDURATION:")>0?this.handleTrackOrLevelPlaylist(e,t,r,i):this.handleMasterPlaylist(e,t,r,i)):this.handleManifestParsingError(e,r,"no EXTM3U delimiter",i)}loaderror(e,t,r){void 0===r&&(r=null),this.handleNetworkError(t,r,!1,e)}loadtimeout(e,t,r){void 0===r&&(r=null),this.handleNetworkError(t,r,!0)}handleMasterPlaylist(e,t,i,a){var s=this.hls,n=e.data,o=W(e,i),{levels:l,sessionData:h}=H.parseMasterPlaylist(n,o);if(l.length){var d=l.map((e=>({id:e.attrs.AUDIO,audioCodec:e.audioCodec}))),u=l.map((e=>({id:e.attrs.SUBTITLES,textCodec:e.textCodec}))),f=H.parseMasterPlaylistMedia(n,o,"AUDIO",d),g=H.parseMasterPlaylistMedia(n,o,"SUBTITLES",u),v=H.parseMasterPlaylistMedia(n,o,"CLOSED-CAPTIONS");if(f.length)f.some((e=>!e.url))||!l[0].audioCodec||l[0].attrs.AUDIO||(c.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),f.unshift({type:"main",name:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new w({}),bitrate:0,url:""}));s.trigger(r.MANIFEST_LOADED,{levels:l,audioTracks:f,subtitles:g,captions:v,url:o,stats:t,networkDetails:a,sessionData:h})}else this.handleManifestParsingError(e,i,"no level found in manifest",a)}handleTrackOrLevelPlaylist(e,t,s,n){var o=this.hls,{id:l,level:h,type:d}=s,u=W(e,s),c=Number.isFinite(l)?l:0,f=Number.isFinite(h)?h:c,g=function(e){var{type:t}=e;switch(t){case P.AUDIO_TRACK:return F.AUDIO;case P.SUBTITLE_TRACK:return F.SUBTITLE;default:return F.MAIN}}(s),v=H.parseLevelPlaylist(e.data,u,f,g,c);if(v.fragments.length){if(d===P.MANIFEST){var m={attrs:new w({}),bitrate:0,details:v,name:"",url:u};o.trigger(r.MANIFEST_LOADED,{levels:[m],audioTracks:[],url:u,stats:t,networkDetails:n,sessionData:null})}if(t.parsing.end=performance.now(),v.needSidxRanges){var p,T=null===(p=v.fragments[0].initSegment)||void 0===p?void 0:p.url;this.load({url:T,isSidxRequest:!0,type:d,level:h,levelDetails:v,id:l,groupId:null,rangeStart:0,rangeEnd:2048,responseType:"arraybuffer",deliveryDirectives:null})}else s.levelDetails=v,this.handlePlaylistLoaded(e,t,s,n)}else o.trigger(r.ERROR,{type:i.NETWORK_ERROR,details:a.LEVEL_EMPTY_ERROR,fatal:!1,url:u,reason:"no fragments found in level",level:"number"==typeof s.level?s.level:void 0})}handleSidxRequest(e,t){var r=R(new Uint8Array(e.data));if(r){var i=r.references,a=t.levelDetails;i.forEach(((e,t)=>{var i=e.info,s=a.fragments[t];0===s.byteRange.length&&s.setByteRange(String(1+i.end-i.start)+"@"+String(i.start)),s.initSegment&&s.initSegment.setByteRange(String(r.moovEndOffset)+"@0")}))}}handleManifestParsingError(e,t,s,n){this.hls.trigger(r.ERROR,{type:i.NETWORK_ERROR,details:a.MANIFEST_PARSING_ERROR,fatal:t.type===P.MANIFEST,url:e.url,reason:s,response:e,context:t,networkDetails:n})}handleNetworkError(e,t,s,n){void 0===s&&(s=!1),c.warn("[playlist-loader]: A network "+(s?"timeout":"error")+" occurred while loading "+e.type+" level: "+e.level+" id: "+e.id+' group-id: "'+e.groupId+'"');var o=a.UNKNOWN,l=!1,h=this.getInternalLoader(e);switch(e.type){case P.MANIFEST:o=s?a.MANIFEST_LOAD_TIMEOUT:a.MANIFEST_LOAD_ERROR,l=!0;break;case P.LEVEL:o=s?a.LEVEL_LOAD_TIMEOUT:a.LEVEL_LOAD_ERROR,l=!1;break;case P.AUDIO_TRACK:o=s?a.AUDIO_TRACK_LOAD_TIMEOUT:a.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case P.SUBTITLE_TRACK:o=s?a.SUBTITLE_TRACK_LOAD_TIMEOUT:a.SUBTITLE_LOAD_ERROR,l=!1}h&&this.resetInternalLoader(e.type);var d={type:i.NETWORK_ERROR,details:o,fatal:l,url:e.url,loader:h,context:e,networkDetails:t};n&&(d.response=n),this.hls.trigger(r.ERROR,d)}handlePlaylistLoaded(e,t,i,a){var{type:s,level:n,id:o,groupId:l,loader:h,levelDetails:d,deliveryDirectives:u}=i;if(null!=d&&d.targetduration){if(h)switch(d.live&&(h.getCacheAge&&(d.ageHeader=h.getCacheAge()||0),h.getCacheAge&&!isNaN(d.ageHeader)||(d.ageHeader=0)),s){case P.MANIFEST:case P.LEVEL:this.hls.trigger(r.LEVEL_LOADED,{details:d,level:n||0,id:o||0,stats:t,networkDetails:a,deliveryDirectives:u});break;case P.AUDIO_TRACK:this.hls.trigger(r.AUDIO_TRACK_LOADED,{details:d,id:o||0,groupId:l||"",stats:t,networkDetails:a,deliveryDirectives:u});break;case P.SUBTITLE_TRACK:this.hls.trigger(r.SUBTITLE_TRACK_LOADED,{details:d,id:o||0,groupId:l||"",stats:t,networkDetails:a,deliveryDirectives:u})}}else this.handleManifestParsingError(e,i,"invalid target duration",a)}}class X{constructor(e){this.hls=void 0,this.loaders={},this.decryptkey=null,this.decrypturl=null,this.hls=e,this._registerListeners()}_registerListeners(){this.hls.on(r.KEY_LOADING,this.onKeyLoading,this)}_unregisterListeners(){this.hls.off(r.KEY_LOADING,this.onKeyLoading)}destroy(){for(var e in this._unregisterListeners(),this.loaders){var t=this.loaders[e];t&&t.destroy()}this.loaders={}}onKeyLoading(e,t){var{frag:i}=t,a=i.type,s=this.loaders[a];if(i.decryptdata){var n=i.decryptdata.uri;if(n!==this.decrypturl||null===this.decryptkey){var o=this.hls.config;if(s&&(c.warn("abort previous key loader for type:"+a),s.abort()),!n)return void c.warn("key uri is falsy");var l=o.loader,h=i.loader=this.loaders[a]=new l(o);this.decrypturl=n,this.decryptkey=null;var d={url:n,frag:i,responseType:"arraybuffer"},u={timeout:o.fragLoadingTimeOut,maxRetry:0,retryDelay:o.fragLoadingRetryDelay,maxRetryDelay:o.fragLoadingMaxRetryTimeout,highWaterMark:0},f={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};h.load(d,u,f)}else this.decryptkey&&(i.decryptdata.key=this.decryptkey,this.hls.trigger(r.KEY_LOADED,{frag:i}))}else c.warn("Missing decryption data on fragment in onKeyLoading")}loadsuccess(e,t,i){var a=i.frag;a.decryptdata?(this.decryptkey=a.decryptdata.key=new Uint8Array(e.data),a.loader=null,delete this.loaders[a.type],this.hls.trigger(r.KEY_LOADED,{frag:a})):c.error("after key load, decryptdata unset")}loaderror(e,t){var s=t.frag,n=s.loader;n&&n.abort(),delete this.loaders[s.type],this.hls.trigger(r.ERROR,{type:i.NETWORK_ERROR,details:a.KEY_LOAD_ERROR,fatal:!1,frag:s,response:e})}loadtimeout(e,t){var s=t.frag,n=s.loader;n&&n.abort(),delete this.loaders[s.type],this.hls.trigger(r.ERROR,{type:i.NETWORK_ERROR,details:a.KEY_LOAD_TIMEOUT,fatal:!1,frag:s})}}function Y(e,t){var r;try{r=new Event("addtrack")}catch(e){(r=document.createEvent("Event")).initEvent("addtrack",!1,!1)}r.track=e,t.dispatchEvent(r)}function z(e,t){var r=e.mode;if("disabled"===r&&(e.mode="hidden"),e.cues&&!e.cues.getCueById(t.id))try{if(e.addCue(t),!e.cues.getCueById(t.id))throw new Error("addCue is failed for: "+t)}catch(r){c.debug("[texttrack-utils]: "+r);var i=new self.TextTrackCue(t.startTime,t.endTime,t.text);i.id=t.id,e.addCue(i)}"disabled"===r&&(e.mode=r)}function Q(e){var t=e.mode;if("disabled"===t&&(e.mode="hidden"),e.cues)for(var r=e.cues.length;r--;)e.removeCue(e.cues[r]);"disabled"===t&&(e.mode=t)}function $(e,t,r){var i=e.mode;if("disabled"===i&&(e.mode="hidden"),e.cues&&e.cues.length>0)for(var a=function(e,t,r){var i=[],a=function(e,t){if(t<e[0].startTime)return 0;var r=e.length-1;if(t>e[r].endTime)return-1;var i=0,a=r;for(;i<=a;){var s=Math.floor((a+i)/2);if(t<e[s].startTime)a=s-1;else{if(!(t>e[s].startTime&&i<r))return s;i=s+1}}return e[i].startTime-t<t-e[a].startTime?i:a}(e,t);if(a>-1)for(var s=a,n=e.length;s<n;s++){var o=e[s];if(o.startTime>=t&&o.endTime<=r)i.push(o);else if(o.startTime>r)return i}return i}(e.cues,t,r),s=0;s<a.length;s++)e.removeCue(a[s]);"disabled"===i&&(e.mode=i)}var Z,J=(e,t)=>t+10<=e.length&&73===e[t]&&68===e[t+1]&&51===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128,ee=(e,t)=>t+10<=e.length&&51===e[t]&&68===e[t+1]&&73===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128,te=(e,t)=>{for(var r=t,i=0;J(e,t);){i+=10,i+=re(e,t+6),ee(e,t+10)&&(i+=10),t+=i}if(i>0)return e.subarray(r,r+i)},re=(e,t)=>{var r=0;return r=(127&e[t])<<21,r|=(127&e[t+1])<<14,r|=(127&e[t+2])<<7,r|=127&e[t+3]},ie=(e,t)=>J(e,t)&&re(e,t+6)+10<=e.length-t,ae=e=>e&&"PRIV"===e.key&&"com.apple.streaming.transportStreamTimestamp"===e.info,se=e=>{var t=String.fromCharCode(e[0],e[1],e[2],e[3]),r=re(e,4);return{type:t,size:r,data:e.subarray(10,10+r)}},ne=e=>{for(var t=0,r=[];J(e,t);){for(var i=re(e,t+6),a=(t+=10)+i;t+8<a;){var s=se(e.subarray(t)),n=oe(s);n&&r.push(n),t+=s.size+10}ee(e,t)&&(t+=10)}return r},oe=e=>"PRIV"===e.type?le(e):"W"===e.type[0]?de(e):he(e),le=e=>{if(!(e.size<2)){var t=ce(e.data,!0),r=new Uint8Array(e.data.subarray(t.length+1));return{key:e.type,info:t,data:r.buffer}}},he=e=>{if(!(e.size<2)){if("TXXX"===e.type){var t=1,r=ce(e.data.subarray(t),!0);t+=r.length+1;var i=ce(e.data.subarray(t));return{key:e.type,info:r,data:i}}var a=ce(e.data.subarray(1));return{key:e.type,data:a}}},de=e=>{if("WXXX"===e.type){if(e.size<2)return;var t=1,r=ce(e.data.subarray(t),!0);t+=r.length+1;var i=ce(e.data.subarray(t));return{key:e.type,info:r,data:i}}var a=ce(e.data);return{key:e.type,data:a}},ue=e=>{if(8===e.data.byteLength){var t=new Uint8Array(e.data),r=1&t[3],i=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return i/=45,r&&(i+=47721858.84),Math.round(i)}},ce=function(e,t){void 0===t&&(t=!1);var r=fe();if(r){var i=r.decode(e);if(t){var a=i.indexOf("\0");return-1!==a?i.substring(0,a):i}return i.replace(/\0/g,"")}for(var s,n,o,l=e.length,h="",d=0;d<l;){if(0===(s=e[d++])&&t)return h;if(0!==s&&3!==s)switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:h+=String.fromCharCode(s);break;case 12:case 13:n=e[d++],h+=String.fromCharCode((31&s)<<6|63&n);break;case 14:n=e[d++],o=e[d++],h+=String.fromCharCode((15&s)<<12|(63&n)<<6|(63&o)<<0)}}return h};function fe(){return Z||void 0===self.TextDecoder||(Z=new self.TextDecoder("utf-8")),Z}var ge;class ve{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners()}_registerListeners(){var{hls:e}=this;e.on(r.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(r.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(r.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(r.BUFFER_FLUSHING,this.onBufferFlushing,this)}_unregisterListeners(){var{hls:e}=this;e.off(r.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(r.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(r.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(r.BUFFER_FLUSHING,this.onBufferFlushing,this)}onMediaAttached(e,t){this.media=t.media}onMediaDetaching(){this.id3Track&&(Q(this.id3Track),this.id3Track=null,this.media=null)}getID3Track(e){if(this.media){for(var t=0;t<e.length;t++){var r=e[t];if("metadata"===r.kind&&"id3"===r.label)return Y(r,this.media),r}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(this.media){var r=t.frag,i=t.samples;this.id3Track||(this.id3Track=this.getID3Track(this.media.textTracks),this.id3Track.mode="hidden");for(var a=self.WebKitDataCue||self.VTTCue||self.TextTrackCue,s=0;s<i.length;s++){var n=ne(i[s].data);if(n){var o=i[s].pts,l=s<i.length-1?i[s+1].pts:r.end;l-o<=0&&(l=o+.25);for(var h=0;h<n.length;h++){var d=n[h];if(!ae(d)){var u=new a(o,l,"");u.value=d,this.id3Track.addCue(u)}}}}}}onBufferFlushing(e,t){var{startOffset:r,endOffset:i,type:a}=t;if(!a||"audio"===a){var{id3Track:s}=this;s&&$(s,r,i)}}}class me{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=e,this.config=e.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){var{config:e,levelDetails:t}=this;return void 0!==e.liveMaxLatencyDuration?e.liveMaxLatencyDuration:t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){var{levelDetails:e}=this;if(null===e)return null;var{holdBack:t,partHoldBack:r,targetduration:i}=e,{liveSyncDuration:a,liveSyncDurationCount:s,lowLatencyMode:n}=this.config,o=this.hls.userConfig,l=n&&r||t;(o.liveSyncDuration||o.liveSyncDurationCount||0===l)&&(l=void 0!==a?a:s*i);var h=i;return l+Math.min(1*this.stallCount,h)}get liveSyncPosition(){var e=this.estimateLiveEdge(),t=this.targetLatency,r=this.levelDetails;if(null===e||null===t||null===r)return null;var i=r.edge,a=e-t-this.edgeStalled,s=i-r.totalduration,n=i-(this.config.lowLatencyMode&&r.partTarget||r.targetduration);return Math.min(Math.max(s,a),n)}get drift(){var{levelDetails:e}=this;return null===e?1:e.drift}get edgeStalled(){var{levelDetails:e}=this;if(null===e)return 0;var t=3*(this.config.lowLatencyMode&&e.partTarget||e.targetduration);return Math.max(e.age-t,0)}get forwardBufferLength(){var{media:e,levelDetails:t}=this;if(!e||!t)return 0;var r=e.buffered.length;return r?e.buffered.end(r-1):t.edge-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(r.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(r.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(r.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(r.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(r.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(r.MEDIA_ATTACHED,this.onMediaAttached),this.hls.off(r.MEDIA_DETACHING,this.onMediaDetaching),this.hls.off(r.MANIFEST_LOADING,this.onManifestLoading),this.hls.off(r.LEVEL_UPDATED,this.onLevelUpdated),this.hls.off(r.ERROR,this.onError)}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(e,t){var{details:r}=t;this.levelDetails=r,r.advanced&&this.timeupdate(),!r.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(e,t){t.details===a.BUFFER_STALLED_ERROR&&(this.stallCount++,c.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){var{media:e,levelDetails:t}=this;if(e&&t){this.currentTime=e.currentTime;var r=this.computeLatency();if(null!==r){this._latency=r;var{lowLatencyMode:i,maxLiveSyncPlaybackRate:a}=this.config;if(i&&1!==a){var s=this.targetLatency;if(null!==s){var n=r-s,o=n<Math.min(this.maxLatency,s+t.targetduration);if(t.live&&o&&n>.05&&this.forwardBufferLength>1){var l=Math.min(2,Math.max(1,a)),h=Math.round(2/(1+Math.exp(-.75*n-this.edgeStalled))*20)/20;e.playbackRate=Math.min(l,Math.max(1,h))}else 1!==e.playbackRate&&0!==e.playbackRate&&(e.playbackRate=1)}}}}}estimateLiveEdge(){var{levelDetails:e}=this;return null===e?null:e.edge+e.age}computeLatency(){var e=this.estimateLiveEdge();return null===e?null:e-this.currentTime}}function pe(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function Te(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?pe(Object(r),!0).forEach((function(t){ye(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):pe(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function ye(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ee(){return Ee=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e},Ee.apply(this,arguments)}!function(e){e.No="",e.Yes="YES",e.v2="v2"}(ge||(ge={}));class Se{constructor(e,t,r){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=r}addDirectives(e){var t=new self.URL(e);return void 0!==this.msn&&t.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.toString()}}class Le{constructor(e){this.attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.unknownCodecs=void 0,this.audioGroupIds=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.textGroupIds=void 0,this.url=void 0,this._urlId=0,this.url=[e.url],this.attrs=e.attrs,this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.unknownCodecs=e.unknownCodecs,this.codecSet=[e.videoCodec,e.audioCodec].filter((e=>e)).join(",").replace(/\.[^.,]+/g,"")}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get uri(){return this.url[this._urlId]||""}get urlId(){return this._urlId}set urlId(e){var t=e%this.url.length;this._urlId!==t&&(this.details=void 0,this._urlId=t)}}function be(e,t,r){switch(t){case"audio":e.audioGroupIds||(e.audioGroupIds=[]),e.audioGroupIds.push(r);break;case"text":e.textGroupIds||(e.textGroupIds=[]),e.textGroupIds.push(r)}}function Ae(e){var t={};e.forEach((e=>{var r=e.groupId||"";e.id=t[r]=t[r]||0,t[r]++}))}function Re(e,t){var r=t.startPTS;if(Number.isFinite(r)){var i,a=0;t.sn>e.sn?(a=r-e.start,i=e):(a=e.start-r,i=t),i.duration!==a&&(i.duration=a)}else if(t.sn>e.sn){e.cc===t.cc&&e.minEndPTS?t.start=e.start+(e.minEndPTS-e.start):t.start=e.start+e.duration}else t.start=Math.max(e.start-t.duration,0)}function De(e,t,r,i,a,s){i-r<=0&&(c.warn("Fragment should have a positive duration",t),i=r+t.duration,s=a+t.duration);var n=r,o=i,l=t.startPTS,h=t.endPTS;if(Number.isFinite(l)){var d=Math.abs(l-r);Number.isFinite(t.deltaPTS)?t.deltaPTS=Math.max(d,t.deltaPTS):t.deltaPTS=d,n=Math.max(r,l),r=Math.min(r,l),a=Math.min(a,t.startDTS),o=Math.min(i,h),i=Math.max(i,h),s=Math.max(s,t.endDTS)}t.duration=i-r;var u=r-t.start;t.appendedPTS=i,t.start=t.startPTS=r,t.maxStartPTS=n,t.startDTS=a,t.endPTS=i,t.minEndPTS=o,t.endDTS=s;var f,g=t.sn;if(!e||g<e.startSN||g>e.endSN)return 0;var v=g-e.startSN,m=e.fragments;for(m[v]=t,f=v;f>0;f--)Re(m[f],m[f-1]);for(f=v;f<m.length-1;f++)Re(m[f],m[f+1]);return e.fragmentHint&&Re(m[m.length-1],e.fragmentHint),e.PTSKnown=e.alignedSliding=!0,u}function ke(e,t){for(var r=null,i=e.fragments,a=i.length-1;a>=0;a--){var s=i[a].initSegment;if(s){r=s;break}}e.fragmentHint&&delete e.fragmentHint.endPTS;var n,o=0;if(function(e,t,r){for(var i=t.skippedSegments,a=Math.max(e.startSN,t.startSN)-t.startSN,s=(e.fragmentHint?1:0)+(i?t.endSN:Math.min(e.endSN,t.endSN))-t.startSN,n=t.startSN-e.startSN,o=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,l=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,h=a;h<=s;h++){var d=l[n+h],u=o[h];i&&!u&&h<i&&(u=t.fragments[h]=d),d&&u&&r(d,u)}}(e,t,((e,i)=>{var a;e.relurl&&(o=e.cc-i.cc),Number.isFinite(e.startPTS)&&Number.isFinite(e.endPTS)&&(i.start=i.startPTS=e.startPTS,i.startDTS=e.startDTS,i.appendedPTS=e.appendedPTS,i.maxStartPTS=e.maxStartPTS,i.endPTS=e.endPTS,i.endDTS=e.endDTS,i.minEndPTS=e.minEndPTS,i.duration=e.endPTS-e.startPTS,i.duration&&(n=i),t.PTSKnown=t.alignedSliding=!0),i.elementaryStreams=e.elementaryStreams,i.loader=e.loader,i.stats=e.stats,i.urlId=e.urlId,e.initSegment?(i.initSegment=e.initSegment,r=e.initSegment):i.initSegment&&i.initSegment.relurl!=(null===(a=r)||void 0===a?void 0:a.relurl)||(i.initSegment=r)})),t.skippedSegments&&(t.deltaUpdateFailed=t.fragments.some((e=>!e)),t.deltaUpdateFailed)){c.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(var l=t.skippedSegments;l--;)t.fragments.shift();t.startSN=t.fragments[0].sn,t.startCC=t.fragments[0].cc}var h=t.fragments;if(o){c.warn("discontinuity sliding from playlist, take drift into account");for(var d=0;d<h.length;d++)h[d].cc+=o}t.skippedSegments&&(t.startCC=t.fragments[0].cc),function(e,t,r){if(e&&t)for(var i=0,a=0,s=e.length;a<=s;a++){var n=e[a],o=t[a+i];n&&o&&n.index===o.index&&n.fragment.sn===o.fragment.sn?r(n,o):i--}}(e.partList,t.partList,((e,t)=>{t.elementaryStreams=e.elementaryStreams,t.stats=e.stats})),n?De(t,n,n.startPTS,n.endPTS,n.startDTS,n.endDTS):Ce(e,t),h.length&&(t.totalduration=t.edge-h[0].start),t.driftStartTime=e.driftStartTime,t.driftStart=e.driftStart;var u=t.advancedDateTime;if(t.advanced&&u){var f=t.edge;t.driftStart||(t.driftStartTime=u,t.driftStart=f),t.driftEndTime=u,t.driftEnd=f}else t.driftEndTime=e.driftEndTime,t.driftEnd=e.driftEnd,t.advancedDateTime=e.advancedDateTime}function Ce(e,t){var r=t.startSN+t.skippedSegments-e.startSN,i=e.fragments;r<0||r>=i.length||_e(t,i[r].start)}function _e(e,t){if(t){for(var r=e.fragments,i=e.skippedSegments;i<r.length;i++)r[i].start+=t;e.fragmentHint&&(e.fragmentHint.start+=t)}}class Ie{constructor(e,t){this.hls=void 0,this.timer=-1,this.canLoad=!1,this.retryCount=0,this.log=void 0,this.warn=void 0,this.log=c.log.bind(c,t+":"),this.warn=c.warn.bind(c,t+":"),this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}onError(e,t){t.fatal&&t.type===i.NETWORK_ERROR&&this.clearTimer()}clearTimer(){clearTimeout(this.timer),this.timer=-1}startLoad(){this.canLoad=!0,this.retryCount=0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t){var r=null==t?void 0:t.renditionReports;if(r)for(var i=0;i<r.length;i++){var a=r[i],s=""+a.URI;if(s===e.substr(-s.length)){var n=parseInt(a["LAST-MSN"]),o=parseInt(a["LAST-PART"]);if(t&&this.hls.config.lowLatencyMode){var l=Math.min(t.age-t.partTarget,t.targetduration);void 0!==o&&l>t.partTarget&&(o+=1)}if(Number.isFinite(n))return new Se(n,Number.isFinite(o)?o:void 0,ge.No)}}}loadPlaylist(e){}shouldLoadTrack(e){return this.canLoad&&e&&!!e.url&&(!e.details||e.details.live)}playlistLoaded(e,t,r){var{details:i,stats:a}=t,s=a.loading.end?Math.max(0,self.performance.now()-a.loading.end):0;if(i.advancedDateTime=Date.now()-s,i.live||null!=r&&r.live){if(i.reloaded(r),r&&this.log("live playlist "+e+" "+(i.advanced?"REFRESHED "+i.lastPartSn+"-"+i.lastPartIndex:"MISSED")),r&&i.fragments.length>0&&ke(r,i),!this.canLoad||!i.live)return;var n,o=void 0,l=void 0;if(i.canBlockReload&&i.endSN&&i.advanced){var h=this.hls.config.lowLatencyMode,d=i.lastPartSn,u=i.endSN,c=i.lastPartIndex,f=d===u;-1!==c?(o=f?u+1:d,l=f?h?0:c:c+1):o=u+1;var g=i.age,v=g+i.ageHeader,m=Math.min(v-i.partTarget,1.5*i.targetduration);if(m>0){if(r&&m>r.tuneInGoal)this.warn("CDN Tune-in goal increased from: "+r.tuneInGoal+" to: "+m+" with playlist age: "+i.age),m=0;else{var p=Math.floor(m/i.targetduration);if(o+=p,void 0!==l)l+=Math.round(m%i.targetduration/i.partTarget);this.log("CDN Tune-in age: "+i.ageHeader+"s last advanced "+g.toFixed(2)+"s goal: "+m+" skip sn "+p+" to part "+l)}i.tuneInGoal=m}if(n=this.getDeliveryDirectives(i,t.deliveryDirectives,o,l),h||!f)return void this.loadPlaylist(n)}else n=this.getDeliveryDirectives(i,t.deliveryDirectives,o,l);var T=function(e,t){var r,i=1e3*e.levelTargetDuration,a=i/2,s=e.age,n=s>0&&s<3*i,o=t.loading.end-t.loading.start,l=e.availabilityDelay;if(!1===e.updated)if(n){var h=333*e.misses;r=Math.max(Math.min(a,2*o),h),e.availabilityDelay=(e.availabilityDelay||0)+r}else r=a;else n?(l=Math.min(l||i/2,s),e.availabilityDelay=l,r=l+i-s):r=i-o;return Math.round(r)}(i,a);void 0!==o&&i.canBlockReload&&(T-=i.partTarget||1),this.log("reload live playlist "+e+" in "+Math.round(T)+" ms"),this.timer=self.setTimeout((()=>this.loadPlaylist(n)),T)}else this.clearTimer()}getDeliveryDirectives(e,t,r,i){var a=function(e,t){var{canSkipUntil:r,canSkipDateRanges:i,endSN:a}=e;return r&&(void 0!==t?t-a:0)<r?i?ge.v2:ge.Yes:ge.No}(e,r);return null!=t&&t.skip&&e.deltaUpdateFailed&&(r=t.msn,i=t.part,a=ge.No),new Se(r,i,a)}retryLoadingOrFail(e){var t,{config:r}=this.hls,i=this.retryCount<r.levelLoadingMaxRetry;if(i)if(this.retryCount++,e.details.indexOf("LoadTimeOut")>-1&&null!==(t=e.context)&&void 0!==t&&t.deliveryDirectives)this.warn("retry playlist loading #"+this.retryCount+' after "'+e.details+'"'),this.loadPlaylist();else{var a=Math.min(Math.pow(2,this.retryCount)*r.levelLoadingRetryDelay,r.levelLoadingMaxRetryTimeout);this.timer=self.setTimeout((()=>this.loadPlaylist()),a),this.warn("retry playlist loading #"+this.retryCount+" in "+a+' ms after "'+e.details+'"')}else this.warn('cannot recover from error "'+e.details+'"'),this.clearTimer(),e.fatal=!0;return i}}var we,xe=/chrome|firefox/.test(navigator.userAgent.toLowerCase());class Oe extends Ie{constructor(e){super(e,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._startLevel=void 0,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.onParsedComplete=void 0,this._registerListeners()}_registerListeners(){var{hls:e}=this;e.on(r.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(r.LEVEL_LOADED,this.onLevelLoaded,this),e.on(r.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(r.FRAG_LOADED,this.onFragLoaded,this),e.on(r.ERROR,this.onError,this)}_unregisterListeners(){var{hls:e}=this;e.off(r.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(r.LEVEL_LOADED,this.onLevelLoaded,this),e.off(r.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(r.FRAG_LOADED,this.onFragLoaded,this),e.off(r.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.manualLevelIndex=-1,this._levels.length=0,super.destroy()}startLoad(){this._levels.forEach((e=>{e.loadError=0})),super.startLoad()}onManifestLoaded(e,t){var s,n,o=[],l=[],h=[],d={},u=!1,c=!1,f=!1;if(t.levels.forEach((e=>{var t=e.attrs;u=u||!(!e.width||!e.height),c=c||!!e.videoCodec,f=f||!!e.audioCodec,xe&&e.audioCodec&&-1!==e.audioCodec.indexOf("mp4a.40.34")&&(e.audioCodec=void 0);var r=e.bitrate+"-"+e.attrs.RESOLUTION+"-"+e.attrs.CODECS;(n=d[r])?n.url.push(e.url):(n=new Le(e),d[r]=n,o.push(n)),t&&(t.AUDIO&&be(n,"audio",t.AUDIO),t.SUBTITLES&&be(n,"text",t.SUBTITLES))})),(u||c)&&f&&(o=o.filter((e=>{var{videoCodec:t,width:r,height:i}=e;return!!t||!(!r||!i)}))),o=o.filter((e=>{var{audioCodec:t,videoCodec:r}=e;return(!t||O(t,"audio"))&&(!r||O(r,"video"))})),t.audioTracks&&Ae(l=t.audioTracks.filter((e=>!e.audioCodec||O(e.audioCodec,"audio")))),t.subtitles&&Ae(h=t.subtitles),o.length>0){s=o[0].bitrate,o.sort(((e,t)=>e.bitrate-t.bitrate)),this._levels=o;for(var g=0;g<o.length;g++)if(o[g].bitrate===s){this._firstLevel=g,this.log("manifest loaded, "+o.length+" level(s) found, first bitrate: "+s);break}var v=f&&!c,m={levels:o,audioTracks:l,subtitleTracks:h,firstLevel:this._firstLevel,stats:t.stats,audio:f,video:c,altAudio:!v&&l.some((e=>!!e.url))};this.hls.trigger(r.MANIFEST_PARSED,m),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}else this.hls.trigger(r.ERROR,{type:i.MEDIA_ERROR,details:a.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,reason:"no level with compatible codecs found in manifest"})}get levels(){return 0===this._levels.length?null:this._levels}get level(){return this.currentLevelIndex}set level(e){var t,s=this._levels;if(0!==s.length&&(this.currentLevelIndex!==e||null===(t=s[e])||void 0===t||!t.details)){if(e<0||e>=s.length){var n=e<0;if(this.hls.trigger(r.ERROR,{type:i.OTHER_ERROR,details:a.LEVEL_SWITCH_ERROR,level:e,fatal:n,reason:"invalid level idx"}),n)return;e=Math.min(e,s.length-1)}this.clearTimer();var o=this.currentLevelIndex,l=s[o],h=s[e];this.log("switching to level "+e+" from "+o),this.currentLevelIndex=e;var d=Ee({},h,{level:e,maxBitrate:h.maxBitrate,uri:h.uri,urlId:h.urlId});delete d._urlId,this.hls.trigger(r.LEVEL_SWITCHING,d);var u=h.details;if(!u||u.live){var c=this.switchParams(h.uri,null==l?void 0:l.details);this.loadPlaylist(c)}}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,void 0===this._startLevel&&(this._startLevel=e),-1!==e&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(void 0===this._startLevel){var e=this.hls.config.startLevel;return void 0!==e?e:this._firstLevel}return this._startLevel}set startLevel(e){this._startLevel=e}onError(e,t){if(super.onError(e,t),!t.fatal){var r=t.context,i=this._levels[this.currentLevelIndex];if(r&&(r.type===P.AUDIO_TRACK&&i.audioGroupIds&&r.groupId===i.audioGroupIds[i.urlId]||r.type===P.SUBTITLE_TRACK&&i.textGroupIds&&r.groupId===i.textGroupIds[i.urlId]))this.redundantFailover(this.currentLevelIndex);else{var s,n=!1,o=!0;switch(t.details){case a.FRAG_LOAD_ERROR:case a.FRAG_LOAD_TIMEOUT:case a.KEY_LOAD_ERROR:case a.KEY_LOAD_TIMEOUT:if(t.frag){var l=this._levels[t.frag.level];l?(l.fragmentError++,l.fragmentError>this.hls.config.fragLoadingMaxRetry&&(s=t.frag.level)):s=t.frag.level}break;case a.LEVEL_LOAD_ERROR:case a.LEVEL_LOAD_TIMEOUT:r&&(r.deliveryDirectives&&(o=!1),s=r.level),n=!0;break;case a.REMUX_ALLOC_ERROR:s=t.level,n=!0}void 0!==s&&this.recoverLevel(t,s,n,o)}}}recoverLevel(e,t,r,i){var{details:a}=e,s=this._levels[t];if(s.loadError++,r){if(!this.retryLoadingOrFail(e))return void(this.currentLevelIndex=-1);e.levelRetry=!0}if(i){var n=s.url.length;if(n>1&&s.loadError<n)e.levelRetry=!0,this.redundantFailover(t);else if(-1===this.manualLevelIndex){var o=0===t?this._levels.length-1:t-1;this.currentLevelIndex!==o&&0===this._levels[o].loadError&&(this.warn(a+": switch to "+o),e.levelRetry=!0,this.hls.nextAutoLevel=o)}}}redundantFailover(e){var t=this._levels[e],r=t.url.length;if(r>1){var i=(t.urlId+1)%r;this.warn("Switching to redundant URL-id "+i),this._levels.forEach((e=>{e.urlId=i})),this.level=e}}onFragLoaded(e,t){var{frag:r}=t;if(void 0!==r&&r.type===F.MAIN){var i=this._levels[r.level];void 0!==i&&(i.fragmentError=0,i.loadError=0)}}onLevelLoaded(e,t){var r,i,{level:a,details:s}=t,n=this._levels[a];if(!n)return this.warn("Invalid level index "+a),void(null!==(i=t.deliveryDirectives)&&void 0!==i&&i.skip&&(s.deltaUpdateFailed=!0));a===this.currentLevelIndex?(0===n.fragmentError&&(n.loadError=0,this.retryCount=0),this.playlistLoaded(a,t,n.details)):null!==(r=t.deliveryDirectives)&&void 0!==r&&r.skip&&(s.deltaUpdateFailed=!0)}onAudioTrackSwitched(e,t){var r=this.hls.levels[this.currentLevelIndex];if(r&&r.audioGroupIds){for(var i=-1,a=this.hls.audioTracks[t.id].groupId,s=0;s<r.audioGroupIds.length;s++)if(r.audioGroupIds[s]===a){i=s;break}i!==r.urlId&&(r.urlId=i,this.startLoad())}}loadPlaylist(e){var t=this.currentLevelIndex,i=this._levels[t];if(this.canLoad&&i&&i.url.length>0){var a=i.urlId,s=i.url[a];if(e)try{s=e.addDirectives(s)}catch(e){this.warn("Could not construct new URL with HLS Delivery Directives: "+e)}this.log("Attempt loading level index "+t+(e?" at sn "+e.msn+" part "+e.part:"")+" with URL-id "+a+" "+s),this.clearTimer(),this.hls.trigger(r.LEVEL_LOADING,{url:s,level:t,id:a,deliveryDirectives:e||null})}}get nextLoadLevel(){return-1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=e)}removeLevel(e,t){var i=(e,r)=>r!==t,a=this._levels.filter(((r,a)=>a!==e||r.url.length>1&&void 0!==t&&(r.url=r.url.filter(i),r.audioGroupIds&&(r.audioGroupIds=r.audioGroupIds.filter(i)),r.textGroupIds&&(r.textGroupIds=r.textGroupIds.filter(i)),r.urlId=0,!0))).map(((e,t)=>{var{details:r}=e;return null!=r&&r.fragments&&r.fragments.forEach((e=>{e.level=t})),e}));this._levels=a,this.hls.trigger(r.LEVELS_UPDATED,{levels:a})}}!function(e){e.NOT_LOADED="NOT_LOADED",e.BACKTRACKED="BACKTRACKED",e.APPENDING="APPENDING",e.PARTIAL="PARTIAL",e.OK="OK"}(we||(we={}));class Pe{constructor(e){this.activeFragment=null,this.activeParts=null,this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hls=e,this._registerListeners()}_registerListeners(){var{hls:e}=this;e.on(r.BUFFER_APPENDED,this.onBufferAppended,this),e.on(r.FRAG_BUFFERED,this.onFragBuffered,this),e.on(r.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){var{hls:e}=this;e.off(r.BUFFER_APPENDED,this.onBufferAppended,this),e.off(r.FRAG_BUFFERED,this.onFragBuffered,this),e.off(r.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.timeRanges=null}getAppendedFrag(e,t){if(t===F.MAIN){var{activeFragment:r,activeParts:i}=this;if(!r)return null;if(i)for(var a=i.length;a--;){var s=i[a],n=s?s.end:r.appendedPTS;if(s.start<=e&&void 0!==n&&e<=n)return a>9&&(this.activeParts=i.slice(a-9)),s}else if(r.start<=e&&void 0!==r.appendedPTS&&e<=r.appendedPTS)return r}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){for(var{fragments:r}=this,i=Object.keys(r),a=i.length;a--;){var s=r[i[a]];if((null==s?void 0:s.body.type)===t&&s.buffered){var n=s.body;if(n.start<=e&&e<=n.end)return n}}return null}detectEvictedFragments(e,t,r){Object.keys(this.fragments).forEach((i=>{var a=this.fragments[i];if(a)if(a.buffered){var s=a.range[e];s&&s.time.some((e=>{var r=!this.isTimeBuffered(e.startPTS,e.endPTS,t);return r&&this.removeFragment(a.body),r}))}else a.body.type===r&&this.removeFragment(a.body)}))}detectPartialFragments(e){var t=this.timeRanges,{frag:r,part:i}=e;if(t&&"initSegment"!==r.sn){var a=Me(r),s=this.fragments[a];s&&(Object.keys(t).forEach((e=>{var a=r.elementaryStreams[e];if(a){var n=t[e],o=null!==i||!0===a.partial;s.range[e]=this.getBufferedTimes(r,i,o,n)}})),s.backtrack=s.loaded=null,Object.keys(s.range).length?s.buffered=!0:this.removeFragment(s.body))}}fragBuffered(e){var t=Me(e),r=this.fragments[t];r&&(r.backtrack=r.loaded=null,r.buffered=!0)}getBufferedTimes(e,t,r,i){for(var a={time:[],partial:r},s=t?t.start:e.start,n=t?t.end:e.end,o=e.minEndPTS||n,l=e.maxStartPTS||s,h=0;h<i.length;h++){var d=i.start(h)-this.bufferPadding,u=i.end(h)+this.bufferPadding;if(l>=d&&o<=u){a.time.push({startPTS:Math.max(s,i.start(h)),endPTS:Math.min(n,i.end(h))});break}if(s<u&&n>d)a.partial=!0,a.time.push({startPTS:Math.max(s,i.start(h)),endPTS:Math.min(n,i.end(h))});else if(n<=d)break}return a}getPartialFragment(e){var t,r,i,a=null,s=0,{bufferPadding:n,fragments:o}=this;return Object.keys(o).forEach((l=>{var h=o[l];h&&Fe(h)&&(r=h.body.start-n,i=h.body.end+n,e>=r&&e<=i&&(t=Math.min(e-r,i-e),s<=t&&(a=h.body,s=t)))})),a}getState(e){var t=Me(e),r=this.fragments[t];return r?r.buffered?Fe(r)?we.PARTIAL:we.OK:r.backtrack?we.BACKTRACKED:we.APPENDING:we.NOT_LOADED}backtrack(e,t){var r=Me(e),i=this.fragments[r];if(!i||i.backtrack)return null;var a=i.backtrack=t||i.loaded;return i.loaded=null,a}getBacktrackData(e){var t=Me(e),r=this.fragments[t];if(r){var i,{backtrack:a}=r;if(null!=a&&null!==(i=a.payload)&&void 0!==i&&i.byteLength)return a;this.removeFragment(e)}return null}isTimeBuffered(e,t,r){for(var i,a,s=0;s<r.length;s++){if(i=r.start(s)-this.bufferPadding,a=r.end(s)+this.bufferPadding,e>=i&&t<=a)return!0;if(t<=i)return!1}return!1}onFragLoaded(e,t){var{frag:r,part:i}=t;if("initSegment"!==r.sn&&!r.bitrateTest&&!i){var a=Me(r);this.fragments[a]={body:r,loaded:t,backtrack:null,buffered:!1,range:Object.create(null)}}}onBufferAppended(e,t){var{frag:r,part:i,timeRanges:a}=t;if(r.type===F.MAIN)if(this.activeFragment=r,i){var s=this.activeParts;s||(this.activeParts=s=[]),s.push(i)}else this.activeParts=null;this.timeRanges=a,Object.keys(a).forEach((e=>{var t=a[e];if(this.detectEvictedFragments(e,t),!i)for(var s=0;s<t.length;s++)r.appendedPTS=Math.max(t.end(s),r.appendedPTS||0)}))}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){var t=Me(e);return!!this.fragments[t]}removeFragmentsInRange(e,t,r){Object.keys(this.fragments).forEach((i=>{var a=this.fragments[i];if(a&&a.buffered){var s=a.body;s.type===r&&s.start<t&&s.end>e&&this.removeFragment(s)}}))}removeFragment(e){var t=Me(e);e.stats.loaded=0,e.clearElementaryStreamInfo(),delete this.fragments[t]}removeAllFragments(){this.fragments=Object.create(null),this.activeFragment=null,this.activeParts=null}}function Fe(e){var t,r;return e.buffered&&((null===(t=e.range.video)||void 0===t?void 0:t.partial)||(null===(r=e.range.audio)||void 0===r?void 0:r.partial))}function Me(e){return e.type+"_"+e.level+"_"+e.urlId+"_"+e.sn}var Ne={length:0,start:()=>0,end:()=>0};class Ue{static isBuffered(e,t){try{if(e)for(var r=Ue.getBuffered(e),i=0;i<r.length;i++)if(t>=r.start(i)&&t<=r.end(i))return!0}catch(e){}return!1}static bufferInfo(e,t,r){try{if(e){var i,a=Ue.getBuffered(e),s=[];for(i=0;i<a.length;i++)s.push({start:a.start(i),end:a.end(i)});return this.bufferedInfo(s,t,r)}}catch(e){}return{len:0,start:t,end:t,nextStart:void 0}}static bufferedInfo(e,t,r){t=Math.max(0,t),e.sort((function(e,t){var r=e.start-t.start;return r||t.end-e.end}));var i=[];if(r)for(var a=0;a<e.length;a++){var s=i.length;if(s){var n=i[s-1].end;e[a].start-n<r?e[a].end>n&&(i[s-1].end=e[a].end):i.push(e[a])}else i.push(e[a])}else i=e;for(var o,l=0,h=t,d=t,u=0;u<i.length;u++){var c=i[u].start,f=i[u].end;if(t+r>=c&&t<f)h=c,l=(d=f)-t;else if(t+r<c){o=c;break}}return{len:l,start:h||0,end:d||0,nextStart:o}}static getBuffered(e){try{return e.buffered}catch(e){return c.log("failed to get media.buffered",e),Ne}}}class Be{constructor(e,t,r,i,a,s){void 0===i&&(i=0),void 0===a&&(a=-1),void 0===s&&(s=!1),this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing={start:0,executeStart:0,executeEnd:0,end:0},this.buffering={audio:{start:0,executeStart:0,executeEnd:0,end:0},video:{start:0,executeStart:0,executeEnd:0,end:0},audiovideo:{start:0,executeStart:0,executeEnd:0,end:0}},this.level=e,this.sn=t,this.id=r,this.size=i,this.part=a,this.partial=s}}function Ge(e,t){if(e){var r=e.start+t;e.start=e.startPTS=r,e.endPTS=r+e.duration}}function He(e,t){for(var r=t.fragments,i=0,a=r.length;i<a;i++)Ge(r[i],e);t.fragmentHint&&Ge(t.fragmentHint,e),t.alignedSliding=!0}function Ke(e,t,r){t&&(!function(e,t,r){if(function(e,t,r){return!(!t.details||!(r.endCC>r.startCC||e&&e.cc<r.startCC))}(e,r,t)){var i=function(e,t){var r=e.fragments,i=t.fragments;if(i.length&&r.length){var a=function(e,t){for(var r=null,i=0,a=e.length;i<a;i++){var s=e[i];if(s&&s.cc===t){r=s;break}}return r}(r,i[0].cc);if(a&&(!a||a.startPTS))return a;c.log("No frag in previous level to align on")}else c.log("No fragments to align")}(r.details,t);i&&Number.isFinite(i.start)&&(c.log("Adjusting PTS using last level due to CC increase within current level "+t.url),He(i.start,t))}}(e,r,t),!r.alignedSliding&&t.details&&function(e,t){if(!t.fragments.length||!e.hasProgramDateTime||!t.hasProgramDateTime)return;var r=t.fragments[0].programDateTime,i=e.fragments[0].programDateTime,a=(i-r)/1e3+t.fragments[0].start;a&&Number.isFinite(a)&&(c.log("Adjusting PTS using programDateTime delta "+(i-r)+"ms, sliding:"+a.toFixed(3)+" "+e.url+" "),He(a,e))}(r,t.details),r.alignedSliding||!t.details||r.skippedSegments||Ce(t.details,r))}function Ve(e,t){var{programDateTime:r}=e;if(r){var i=(r-t)/1e3;e.start=e.startPTS=i,e.endPTS=i+e.duration}}var je=function(e,t){for(var r=0,i=e.length-1,a=null,s=null;r<=i;){var n=t(s=e[a=(r+i)/2|0]);if(n>0)r=a+1;else{if(!(n<0))return s;i=a-1}}return null};function We(e,t,r){if(null===t||!Array.isArray(e)||!e.length||!Number.isFinite(t))return null;if(t<(e[0].programDateTime||0))return null;if(t>=(e[e.length-1].endProgramDateTime||0))return null;r=r||0;for(var i=0;i<e.length;++i){var a=e[i];if(Ye(t,r,a))return a}return null}function qe(e,t,r,i){void 0===r&&(r=0),void 0===i&&(i=0);var a=null;if(e?a=t[e.sn-t[0].sn+1]||null:0===r&&0===t[0].start&&(a=t[0]),a&&0===Xe(r,i,a))return a;var s=je(t,Xe.bind(null,r,i));return s||a}function Xe(e,t,r){void 0===e&&(e=0),void 0===t&&(t=0);var i=Math.min(t,r.duration+(r.deltaPTS?r.deltaPTS:0));return r.start+r.duration-i<=e?1:r.start-i>e&&r.start?-1:0}function Ye(e,t,r){var i=1e3*Math.min(t,r.duration+(r.deltaPTS?r.deltaPTS:0));return(r.endProgramDateTime||0)-i>e}var ze=Math.pow(2,17);class Qe{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){var r=e.url;if(!r)return Promise.reject(new Ze({type:i.NETWORK_ERROR,details:a.FRAG_LOAD_ERROR,fatal:!1,frag:e,networkDetails:null},"Fragment does not have a "+(r?"part list":"url")));this.abort();var s=this.config,n=s.fLoader,o=s.loader;return new Promise(((r,l)=>{this.loader&&this.loader.destroy();var h=this.loader=e.loader=n?new n(s):new o(s),d=$e(e),u={timeout:s.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:s.fragLoadingMaxRetryTimeout,highWaterMark:ze};e.stats=h.stats,h.load(d,u,{onSuccess:(t,i,a,s)=>{this.resetLoader(e,h),r({frag:e,part:null,payload:t.data,networkDetails:s})},onError:(t,r,s)=>{this.resetLoader(e,h),l(new Ze({type:i.NETWORK_ERROR,details:a.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:t,networkDetails:s}))},onAbort:(t,r,s)=>{this.resetLoader(e,h),l(new Ze({type:i.NETWORK_ERROR,details:a.INTERNAL_ABORTED,fatal:!1,frag:e,networkDetails:s}))},onTimeout:(t,r,s)=>{this.resetLoader(e,h),l(new Ze({type:i.NETWORK_ERROR,details:a.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,networkDetails:s}))},onProgress:(r,i,a,s)=>{t&&t({frag:e,part:null,payload:a,networkDetails:s})}})}))}loadPart(e,t,r){this.abort();var s=this.config,n=s.fLoader,o=s.loader;return new Promise(((l,h)=>{this.loader&&this.loader.destroy();var d=this.loader=e.loader=n?new n(s):new o(s),u=$e(e,t),c={timeout:s.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:s.fragLoadingMaxRetryTimeout,highWaterMark:ze};t.stats=d.stats,d.load(u,c,{onSuccess:(i,a,s,n)=>{this.resetLoader(e,d),this.updateStatsFromPart(e,t);var o={frag:e,part:t,payload:i.data,networkDetails:n};r(o),l(o)},onError:(r,s,n)=>{this.resetLoader(e,d),h(new Ze({type:i.NETWORK_ERROR,details:a.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:r,networkDetails:n}))},onAbort:(r,s,n)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,d),h(new Ze({type:i.NETWORK_ERROR,details:a.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,networkDetails:n}))},onTimeout:(r,s,n)=>{this.resetLoader(e,d),h(new Ze({type:i.NETWORK_ERROR,details:a.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,networkDetails:n}))}})}))}updateStatsFromPart(e,t){var r=e.stats,i=t.stats,a=i.total;if(r.loaded+=i.loaded,a){var s=Math.round(e.duration/t.duration),n=Math.min(Math.round(r.loaded/a),s),o=(s-n)*Math.round(r.loaded/n);r.total=r.loaded+o}else r.total=Math.max(r.loaded,r.total);var l=r.loading,h=i.loading;l.start?l.first+=h.first-h.start:(l.start=h.start,l.first=h.first),l.end=h.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function $e(e,t){void 0===t&&(t=null);var r=t||e,i={frag:e,part:t,responseType:"arraybuffer",url:r.url,rangeStart:0,rangeEnd:0},a=r.byteRangeStartOffset,s=r.byteRangeEndOffset;return Number.isFinite(a)&&Number.isFinite(s)&&(i.rangeStart=a,i.rangeEnd=s),i}class Ze extends Error{constructor(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];super(...r),this.data=void 0,this.data=e}}class Je{constructor(e,t){this.subtle=void 0,this.aesIV=void 0,this.subtle=e,this.aesIV=t}decrypt(e,t){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e)}}class et{constructor(e,t){this.subtle=void 0,this.key=void 0,this.subtle=e,this.key=t}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}class tt{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){for(var t=new DataView(e),r=new Uint32Array(4),i=0;i<4;i++)r[i]=t.getUint32(4*i);return r}initTable(){var e=this.sBox,t=this.invSBox,r=this.subMix,i=r[0],a=r[1],s=r[2],n=r[3],o=this.invSubMix,l=o[0],h=o[1],d=o[2],u=o[3],c=new Uint32Array(256),f=0,g=0,v=0;for(v=0;v<256;v++)c[v]=v<128?v<<1:v<<1^283;for(v=0;v<256;v++){var m=g^g<<1^g<<2^g<<3^g<<4;m=m>>>8^255&m^99,e[f]=m,t[m]=f;var p=c[f],T=c[p],y=c[T],E=257*c[m]^16843008*m;i[f]=E<<24|E>>>8,a[f]=E<<16|E>>>16,s[f]=E<<8|E>>>24,n[f]=E,E=16843009*y^65537*T^257*p^16843008*f,l[m]=E<<24|E>>>8,h[m]=E<<16|E>>>16,d[m]=E<<8|E>>>24,u[m]=E,f?(f=p^c[c[c[y^p]]],g^=c[c[g]]):f=g=1}}expandKey(e){for(var t=this.uint8ArrayToUint32Array_(e),r=!0,i=0;i<t.length&&r;)r=t[i]===this.key[i],i++;if(!r){this.key=t;var a=this.keySize=t.length;if(4!==a&&6!==a&&8!==a)throw new Error("Invalid aes key size="+a);var s,n,o,l,h=this.ksRows=4*(a+6+1),d=this.keySchedule=new Uint32Array(h),u=this.invKeySchedule=new Uint32Array(h),c=this.sBox,f=this.rcon,g=this.invSubMix,v=g[0],m=g[1],p=g[2],T=g[3];for(s=0;s<h;s++)s<a?o=d[s]=t[s]:(l=o,s%a==0?(l=c[(l=l<<8|l>>>24)>>>24]<<24|c[l>>>16&255]<<16|c[l>>>8&255]<<8|c[255&l],l^=f[s/a|0]<<24):a>6&&s%a==4&&(l=c[l>>>24]<<24|c[l>>>16&255]<<16|c[l>>>8&255]<<8|c[255&l]),d[s]=o=(d[s-a]^l)>>>0);for(n=0;n<h;n++)s=h-n,l=3&n?d[s]:d[s-4],u[n]=n<4||s<=4?l:v[c[l>>>24]]^m[c[l>>>16&255]]^p[c[l>>>8&255]]^T[c[255&l]],u[n]=u[n]>>>0}}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,r){for(var i,a,s,n,o,l,h,d,u,c,f,g,v,m,p=this.keySize+6,T=this.invKeySchedule,y=this.invSBox,E=this.invSubMix,S=E[0],L=E[1],b=E[2],A=E[3],R=this.uint8ArrayToUint32Array_(r),D=R[0],k=R[1],C=R[2],_=R[3],I=new Int32Array(e),w=new Int32Array(I.length),x=this.networkToHostOrderSwap;t<I.length;){for(u=x(I[t]),c=x(I[t+1]),f=x(I[t+2]),g=x(I[t+3]),o=u^T[0],l=g^T[1],h=f^T[2],d=c^T[3],v=4,m=1;m<p;m++)i=S[o>>>24]^L[l>>16&255]^b[h>>8&255]^A[255&d]^T[v],a=S[l>>>24]^L[h>>16&255]^b[d>>8&255]^A[255&o]^T[v+1],s=S[h>>>24]^L[d>>16&255]^b[o>>8&255]^A[255&l]^T[v+2],n=S[d>>>24]^L[o>>16&255]^b[l>>8&255]^A[255&h]^T[v+3],o=i,l=a,h=s,d=n,v+=4;i=y[o>>>24]<<24^y[l>>16&255]<<16^y[h>>8&255]<<8^y[255&d]^T[v],a=y[l>>>24]<<24^y[h>>16&255]<<16^y[d>>8&255]<<8^y[255&o]^T[v+1],s=y[h>>>24]<<24^y[d>>16&255]<<16^y[o>>8&255]<<8^y[255&l]^T[v+2],n=y[d>>>24]<<24^y[o>>16&255]<<16^y[l>>8&255]<<8^y[255&h]^T[v+3],w[t]=x(i^D),w[t+1]=x(n^k),w[t+2]=x(s^C),w[t+3]=x(a^_),D=u,k=c,C=f,_=g,t+=4}return w.buffer}}class rt{constructor(e,t,r){var{removePKCS7Padding:i=!0}=void 0===r?{}:r;if(this.logEnabled=!0,this.observer=void 0,this.config=void 0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.observer=e,this.config=t,this.removePKCS7Padding=i,i)try{var a=self.crypto;a&&(this.subtle=a.subtle||a.webkitSubtle)}catch(e){}null===this.subtle&&(this.config.enableSoftwareAES=!0)}destroy(){this.observer=null}isSync(){return this.config.enableSoftwareAES}flush(){var{currentResult:e}=this;if(e){var t,r,i,a=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?(r=(t=a).byteLength,(i=r&&new DataView(t.buffer).getUint8(r-1))?f(t,0,r-i):t):a}this.reset()}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,r,i){if(this.config.enableSoftwareAES){this.softwareDecrypt(new Uint8Array(e),t,r);var a=this.flush();a&&i(a.buffer)}else this.webCryptoDecrypt(new Uint8Array(e),t,r).then(i)}softwareDecrypt(e,t,r){var{currentIV:i,currentResult:a,remainderData:s}=this;this.logOnce("JS AES decrypt"),s&&(e=k(s,e),this.remainderData=null);var n=this.getValidChunk(e);if(!n.length)return null;i&&(r=i);var o=this.softwareDecrypter;o||(o=this.softwareDecrypter=new tt),o.expandKey(t);var l=a;return this.currentResult=o.decrypt(n.buffer,0,r),this.currentIV=f(n,-16).buffer,l||null}webCryptoDecrypt(e,t,r){var i=this.subtle;return this.key===t&&this.fastAesKey||(this.key=t,this.fastAesKey=new et(i,t)),this.fastAesKey.expandKey().then((t=>i?new Je(i,r).decrypt(e.buffer,t):Promise.reject(new Error("web crypto not initialized")))).catch((i=>this.onWebCryptoError(i,e,t,r)))}onWebCryptoError(e,t,r,i){return c.warn("[decrypter.ts]: WebCrypto Error, disable WebCrypto API:",e),this.config.enableSoftwareAES=!0,this.logEnabled=!0,this.softwareDecrypt(t,r,i)}getValidChunk(e){var t=e,r=e.length-e.length%16;return r!==e.length&&(t=f(e,0,r),this.remainderData=f(e,r)),t}logOnce(e){this.logEnabled&&(c.log("[decrypter.ts]: "+e),this.logEnabled=!1)}}var it=function(e){for(var t="",r=e.length,i=0;i<r;i++)t+="["+e.start(i).toFixed(3)+","+e.end(i).toFixed(3)+"]";return t},at="STOPPED",st="IDLE",nt="KEY_LOADING",ot="FRAG_LOADING",lt="FRAG_LOADING_WAITING_RETRY",ht="PARSING",dt="PARSED",ut="BACKTRACKING",ct="ENDED",ft="ERROR",gt="WAITING_LEVEL";class vt extends class{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return!this._tickInterval&&(this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}{constructor(e,t,i){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=at,this.media=void 0,this.mediaBuffer=void 0,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.loadedmetadata=!1,this.fragLoadError=0,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.logPrefix=i,this.log=c.log.bind(c,i+":"),this.warn=c.warn.bind(c,i+":"),this.hls=e,this.fragmentLoader=new Qe(e.config),this.fragmentTracker=t,this.config=e.config,this.decrypter=new rt(e,e.config),e.on(r.KEY_LOADED,this.onKeyLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){this.fragmentLoader.abort();var e=this.fragCurrent;e&&this.fragmentTracker.removeFragment(e),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=at}_streamEnded(e,t){var{fragCurrent:r,fragmentTracker:i}=this;if(!t.live&&r&&r.sn===t.endSN&&!e.nextStart){var a=i.getState(r);return a===we.PARTIAL||a===we.OK}return!1}onMediaAttached(e,t){var r=this.media=this.mediaBuffer=t.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),r.addEventListener("seeking",this.onvseeking),r.addEventListener("ended",this.onvended);var i=this.config;this.levels&&i.autoStartLoad&&this.state===at&&this.startLoad(i.startPosition)}onMediaDetaching(){var e=this.media;null!=e&&e.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),e&&(e.removeEventListener("seeking",this.onvseeking),e.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){var{config:e,fragCurrent:t,media:r,mediaBuffer:i,state:a}=this,s=r?r.currentTime:0,n=Ue.bufferInfo(i||r,s,e.maxBufferHole);if(this.log("media seeking to "+(Number.isFinite(s)?s.toFixed(3):s)+", state: "+a),a===ct)this.resetLoadingState();else if(t&&!n.len){var o=e.maxFragLookUpTolerance,l=t.start-o,h=s>t.start+t.duration+o;(s<l||h)&&(h&&t.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),t.loader.abort()),this.resetLoadingState())}r&&(this.lastCurrentTime=s),this.loadedmetadata||n.len||(this.nextLoadPosition=this.startPosition=s),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onKeyLoaded(e,t){if(this.state===nt&&t.frag===this.fragCurrent&&this.levels){this.state=st;var r=this.levels[t.frag.level].details;r&&this.loadFragment(t.frag,r,t.frag.start)}}onHandlerDestroying(){this.stopLoad(),super.onHandlerDestroying()}onHandlerDestroyed(){this.state=at,this.hls.off(r.KEY_LOADED,this.onKeyLoaded,this),this.fragmentLoader&&this.fragmentLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadKey(e,t){this.log("Loading key for "+e.sn+" of ["+t.startSN+"-"+t.endSN+"], "+("[stream-controller]"===this.logPrefix?"level":"track")+" "+e.level),this.state=nt,this.fragCurrent=e,this.hls.trigger(r.KEY_LOADING,{frag:e})}loadFragment(e,t,r){this._loadFragForPlayback(e,t,r)}_loadFragForPlayback(e,t,i){this._doFragLoad(e,t,i,(t=>{if(this.fragContextChanged(e))return this.warn("Fragment "+e.sn+(t.part?" p: "+t.part.index:"")+" of level "+e.level+" was dropped during download."),void this.fragmentTracker.removeFragment(e);e.stats.chunkCount++,this._handleFragmentLoadProgress(t)})).then((t=>{if(t){this.fragLoadError=0;var i=this.state;if(!this.fragContextChanged(e))return"payload"in t&&(this.log("Loaded fragment "+e.sn+" of level "+e.level),this.hls.trigger(r.FRAG_LOADED,t),this.state===ut)?(this.fragmentTracker.backtrack(e,t),void this.resetFragmentLoading(e)):void this._handleFragmentLoadComplete(t);(i===ot||i===ut||!this.fragCurrent&&i===ht)&&(this.fragmentTracker.removeFragment(e),this.state=st)}})).catch((t=>{this.warn(t),this.resetFragmentLoading(e)}))}flushMainBuffer(e,t,i){if(void 0===i&&(i=null),e-t){var a={startOffset:e,endOffset:t,type:i};this.fragLoadError=0,this.hls.trigger(r.BUFFER_FLUSHING,a)}}_loadInitSegment(e){this._doFragLoad(e).then((t=>{if(!t||this.fragContextChanged(e)||!this.levels)throw new Error("init load aborted");return t})).then((t=>{var{hls:i}=this,{payload:a}=t,s=e.decryptdata;if(a&&a.byteLength>0&&s&&s.key&&s.iv&&"AES-128"===s.method){var n=self.performance.now();return this.decrypter.webCryptoDecrypt(new Uint8Array(a),s.key.buffer,s.iv.buffer).then((a=>{var s=self.performance.now();return i.trigger(r.FRAG_DECRYPTED,{frag:e,payload:a,stats:{tstart:n,tdecrypt:s}}),t.payload=a,t}))}return t})).then((t=>{var{fragCurrent:i,hls:a,levels:s}=this;if(!s)throw new Error("init load aborted, missing levels");var n=s[e.level].details;console.assert(n,"Level details are defined when init segment is loaded");var o=e.stats;this.state=st,this.fragLoadError=0,e.data=new Uint8Array(t.payload),o.parsing.start=o.buffering.start=self.performance.now(),o.parsing.end=o.buffering.end=self.performance.now(),t.frag===i&&a.trigger(r.FRAG_BUFFERED,{stats:o,frag:i,part:null,id:e.type}),this.tick()})).catch((t=>{this.warn(t),this.resetFragmentLoading(e)}))}fragContextChanged(e){var{fragCurrent:t}=this;return!e||!t||e.level!==t.level||e.sn!==t.sn||e.urlId!==t.urlId}fragBufferedComplete(e,t){var r=this.mediaBuffer?this.mediaBuffer:this.media;this.log("Buffered "+e.type+" sn: "+e.sn+(t?" part: "+t.index:"")+" of "+("[stream-controller]"===this.logPrefix?"level":"track")+" "+e.level+" "+it(Ue.getBuffered(r))),this.state=st,this.tick()}_handleFragmentLoadComplete(e){var{transmuxer:t}=this;if(t){var{frag:r,part:i,partsLoaded:a}=e,s=!a||0===a.length||a.some((e=>!e)),n=new Be(r.level,r.sn,r.stats.chunkCount+1,0,i?i.index:-1,!s);t.flush(n)}}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i,a){if(void 0===i&&(i=null),!this.levels)throw new Error("frag load aborted, missing levels");if(i=Math.max(e.start,i||0),this.config.lowLatencyMode&&t){var s=t.partList;if(s&&a){i>e.end&&t.fragmentHint&&(e=t.fragmentHint);var n=this.getNextPart(s,e,i);if(n>-1){var o=s[n];return this.log("Loading part sn: "+e.sn+" p: "+o.index+" cc: "+e.cc+" of playlist ["+t.startSN+"-"+t.endSN+"] parts [0-"+n+"-"+(s.length-1)+"] "+("[stream-controller]"===this.logPrefix?"level":"track")+": "+e.level+", target: "+parseFloat(i.toFixed(3))),this.nextLoadPosition=o.start+o.duration,this.state=ot,this.hls.trigger(r.FRAG_LOADING,{frag:e,part:s[n],targetBufferTime:i}),this.doFragPartsLoad(e,s,n,a).catch((e=>this.handleFragLoadError(e)))}if(!e.url||this.loadedEndOfParts(s,i))return Promise.resolve(null)}}return this.log("Loading fragment "+e.sn+" cc: "+e.cc+" "+(t?"of ["+t.startSN+"-"+t.endSN+"] ":"")+("[stream-controller]"===this.logPrefix?"level":"track")+": "+e.level+", target: "+parseFloat(i.toFixed(3))),Number.isFinite(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=ot,this.hls.trigger(r.FRAG_LOADING,{frag:e,targetBufferTime:i}),this.fragmentLoader.load(e,a).catch((e=>this.handleFragLoadError(e)))}doFragPartsLoad(e,t,i,a){return new Promise(((s,n)=>{var o=[],l=i=>{var h=t[i];this.fragmentLoader.loadPart(e,h,a).then((a=>{o[h.index]=a;var n=a.part;this.hls.trigger(r.FRAG_LOADED,a);var d=t[i+1];if(!d||d.fragment!==e)return s({frag:e,part:n,partsLoaded:o});l(i+1)})).catch(n)};l(i)}))}handleFragLoadError(e){var{data:t}=e;return t&&t.details===a.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(r.ERROR,t),null}_handleTransmuxerFlush(e){var t=this.getCurrentContext(e);if(t&&this.state===ht){var{frag:r,part:i,level:a}=t,s=self.performance.now();r.stats.parsing.end=s,i&&(i.stats.parsing.end=s),this.updateLevelTiming(r,i,a,e.partial)}else this.fragCurrent||(this.state=st)}getCurrentContext(e){var{levels:t}=this,{level:r,sn:i,part:a}=e;if(!t||!t[r])return this.warn("Levels object was unset while buffering fragment "+i+" of level "+r+". The current chunk will not be buffered."),null;var s=t[r],n=a>-1?function(e,t,r){if(!e||!e.details)return null;var i=e.details.partList;if(i)for(var a=i.length;a--;){var s=i[a];if(s.index===r&&s.fragment.sn===t)return s}return null}(s,i,a):null,o=n?n.fragment:function(e,t,r){if(!e||!e.details)return null;var i=e.details,a=i.fragments[t-i.startSN];return a||((a=i.fragmentHint)&&a.sn===t?a:t<i.startSN&&r&&r.sn===t?r:null)}(s,i,this.fragCurrent);return o?{frag:o,part:n,level:s}:null}bufferFragmentData(e,t,i,a){if(e&&this.state===ht){var{data1:s,data2:n}=e,o=s;if(s&&n&&(o=k(s,n)),o&&o.length){var l={type:e.type,frag:t,part:i,chunkMeta:a,parent:t.type,data:o};this.hls.trigger(r.BUFFER_APPENDING,l),e.dropped&&e.independent&&!i&&this.flushBufferGap(t)}}}flushBufferGap(e){var t=this.media;if(t)if(Ue.isBuffered(t,t.currentTime)){var r=t.currentTime,i=Ue.bufferInfo(t,r,0),a=e.duration,s=Math.min(2*this.config.maxFragLookUpTolerance,.25*a),n=Math.max(Math.min(e.start-s,i.end-s),r+s);e.start-n>s&&this.flushMainBuffer(n,e.start)}else this.flushMainBuffer(0,e.start)}getFwdBufferInfo(e,t){var{config:r}=this,i=this.getLoadPosition();if(!Number.isFinite(i))return null;var a=Ue.bufferInfo(e,i,r.maxBufferHole);if(0===a.len&&void 0!==a.nextStart){var s=this.fragmentTracker.getBufferedFrag(i,t);if(s&&a.nextStart<s.end)return Ue.bufferInfo(e,i,Math.max(a.nextStart,r.maxBufferHole))}return a}getMaxBufferLength(e){var t,{config:r}=this;return t=e?Math.max(8*r.maxBufferSize/e,r.maxBufferLength):r.maxBufferLength,Math.min(t,r.maxMaxBufferLength)}reduceMaxBufferLength(e){var t=this.config,r=e||t.maxBufferLength;return t.maxMaxBufferLength>=r&&(t.maxMaxBufferLength/=2,this.warn("Reduce max buffer length to "+t.maxMaxBufferLength+"s"),!0)}getNextFragment(e,t){var r,i,a=t.fragments,s=a.length;if(!s)return null;var n,{config:o}=this,l=a[0].start;if(t.live){var h=o.initialLiveManifestSize;if(s<h)return this.warn("Not enough fragments to start playback (have: "+s+", need: "+h+")"),null;t.PTSKnown||this.startFragRequested||-1!==this.startPosition||(n=this.getInitialLiveFragment(t,a),this.startPosition=n?this.hls.liveSyncPosition||n.start:e)}else e<=l&&(n=a[0]);if(!n){var d=o.lowLatencyMode?t.partEnd:t.fragmentEnd;n=this.getFragmentAtPosition(e,d,t)}return null===(r=n)||void 0===r||!r.initSegment||null!==(i=n)&&void 0!==i&&i.initSegment.data||this.bitrateTest||(n=n.initSegment),n}getNextPart(e,t,r){for(var i=-1,a=!1,s=!0,n=0,o=e.length;n<o;n++){var l=e[n];if(s=s&&!l.independent,i>-1&&r<l.start)break;var h=l.loaded;!h&&(a||l.independent||s)&&l.fragment===t&&(i=n),a=h}return i}loadedEndOfParts(e,t){var r=e[e.length-1];return r&&t>r.start&&r.loaded}getInitialLiveFragment(e,t){var r=this.fragPrevious,i=null;if(r){if(e.hasProgramDateTime&&(this.log("Live playlist, switching playlist, load frag with same PDT: "+r.programDateTime),i=We(t,r.endProgramDateTime,this.config.maxFragLookUpTolerance)),!i){var a=r.sn+1;if(a>=e.startSN&&a<=e.endSN){var s=t[a-e.startSN];r.cc===s.cc&&(i=s,this.log("Live playlist, switching playlist, load frag with next SN: "+i.sn))}i||(i=function(e,t){return je(e,(e=>e.cc<t?1:e.cc>t?-1:0))}(t,r.cc),i&&this.log("Live playlist, switching playlist, load frag with same CC: "+i.sn))}}else{var n=this.hls.liveSyncPosition;null!==n&&(i=this.getFragmentAtPosition(n,this.bitrateTest?e.fragmentEnd:e.edge,e))}return i}getFragmentAtPosition(e,t,r){var i,{config:a,fragPrevious:s}=this,{fragments:n,endSN:o}=r,{fragmentHint:l}=r,h=a.maxFragLookUpTolerance,d=!!(a.lowLatencyMode&&r.partList&&l);(d&&l&&!this.bitrateTest&&(n=n.concat(l),o=l.sn),e<t)?i=qe(s,n,e,e>t-h?0:h):i=n[n.length-1];if(i){var u=i.sn-r.startSN,c=s&&i.level===s.level,f=n[u+1];if(this.fragmentTracker.getState(i)===we.BACKTRACKED){i=null;for(var g=u;n[g]&&this.fragmentTracker.getState(n[g])===we.BACKTRACKED;)i=s?n[g--]:n[--g];i||(i=f)}else s&&i.sn===s.sn&&!d&&c&&(i.sn<o&&this.fragmentTracker.getState(f)!==we.OK?(this.log("SN "+i.sn+" just loaded, load next one: "+f.sn),i=f):i=null)}return i}synchronizeToLiveEdge(e){var{config:t,media:r}=this;if(r){var i=this.hls.liveSyncPosition,a=r.currentTime,s=e.fragments[0].start,n=e.edge,o=a>=s-t.maxFragLookUpTolerance&&a<=n;if(null!==i&&r.duration>i&&(a<i||!o)){var l=void 0!==t.liveMaxLatencyDuration?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;(!o&&r.readyState<4||a<n-l)&&(this.loadedmetadata||(this.nextLoadPosition=i),r.readyState&&(this.warn("Playback: "+a.toFixed(3)+" is located too far from the end of live sliding playlist: "+n+", reset currentTime to : "+i.toFixed(3)),r.currentTime=i))}}}alignPlaylists(e,t){var{levels:r,levelLastLoaded:i,fragPrevious:a}=this,s=null!==i?r[i]:null,n=e.fragments.length;if(!n)return this.warn("No fragments in live playlist"),0;var o=e.fragments[0].start,l=!t,h=e.alignedSliding&&Number.isFinite(o);if(l||!h&&!o){Ke(a,s,e);var d=e.fragments[0].start;return this.log("Live playlist sliding: "+d.toFixed(2)+" start-sn: "+(t?t.startSN:"na")+"->"+e.startSN+" prev-sn: "+(a?a.sn:"na")+" fragments: "+n),d}return o}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.tuneInGoal>Math.max(e.partHoldBack,3*e.partTarget)}setStartPosition(e,t){var r=this.startPosition;if(r<t&&(r=-1),-1===r||-1===this.lastCurrentTime){var i=e.startTimeOffset;Number.isFinite(i)?(r=t+i,i<0&&(r+=e.totalduration),r=Math.min(Math.max(t,r),t+e.totalduration),this.log("Start time offset "+i+" found in playlist, adjust startPosition to "+r),this.startPosition=r):e.live?r=this.hls.liveSyncPosition||t:this.startPosition=r=0,this.lastCurrentTime=r}this.nextLoadPosition=r}getLoadPosition(){var{media:e}=this,t=0;return this.loadedmetadata&&e?t=e.currentTime:this.nextLoadPosition&&(t=this.nextLoadPosition),t}handleFragLoadAborted(e,t){this.transmuxer&&"initSegment"!==e.sn&&e.stats.aborted&&(this.warn("Fragment "+e.sn+(t?" part"+t.index:"")+" of level "+e.level+" was aborted"),this.resetFragmentLoading(e))}resetFragmentLoading(e){this.fragCurrent&&this.fragContextChanged(e)||(this.state=st)}onFragmentOrKeyLoadError(e,t){if(!t.fatal){var r=t.frag;if(r&&r.type===e){var i=this.fragCurrent;console.assert(i&&r.sn===i.sn&&r.level===i.level&&r.urlId===i.urlId,"Frag load error must match current frag to retry");var a=this.config;if(this.fragLoadError+1<=a.fragLoadingMaxRetry){if(this.resetLiveStartWhenNotLoaded(r.level))return;var s=Math.min(Math.pow(2,this.fragLoadError)*a.fragLoadingRetryDelay,a.fragLoadingMaxRetryTimeout);this.warn("Fragment "+r.sn+" of "+e+" "+r.level+" failed to load, retrying in "+s+"ms"),this.retryDate=self.performance.now()+s,this.fragLoadError++,this.state=lt}else t.levelRetry?(e===F.AUDIO&&(this.fragCurrent=null),this.fragLoadError=0,this.state=st):(c.error(t.details+" reaches max retry, redispatch as fatal ..."),t.fatal=!0,this.hls.stopLoad(),this.state=ft)}}}afterBufferFlushed(e,t,r){if(e){var i=Ue.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,i,r),this.state===ct&&this.resetLoadingState()}}resetLoadingState(){this.fragCurrent=null,this.fragPrevious=null,this.state=st}resetLiveStartWhenNotLoaded(e){if(!this.loadedmetadata){this.startFragRequested=!1;var t=this.levels?this.levels[e].details:null;if(null!=t&&t.live)return this.startPosition=-1,this.setStartPosition(t,0),this.resetLoadingState(),!0;this.nextLoadPosition=this.startPosition}return!1}updateLevelTiming(e,t,i,a){var s=i.details;console.assert(!!s,"level.details must be defined"),Object.keys(e.elementaryStreams).reduce(((t,n)=>{var o=e.elementaryStreams[n];if(o){var l=o.endPTS-o.startPTS;if(l<=0)return this.warn("Could not parse fragment "+e.sn+" "+n+" duration reliably ("+l+") resetting transmuxer to fallback to playlist timing"),this.resetTransmuxer(),t||!1;var h=a?0:De(s,e,o.startPTS,o.endPTS,o.startDTS,o.endDTS);return this.hls.trigger(r.LEVEL_PTS_UPDATED,{details:s,level:i,drift:h,type:n,frag:e,start:o.startPTS,end:o.endPTS}),!0}return t}),!1)?(this.state=dt,this.hls.trigger(r.FRAG_PARSED,{frag:e,part:t})):this.resetLoadingState()}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}set state(e){var t=this._state;t!==e&&(this._state=e,this.log(t+"->"+e))}get state(){return this._state}}function mt(){return self.MediaSource||self.WebKitMediaSource}function pt(){return self.SourceBuffer||self.WebKitSourceBuffer}var Tt=t((function(e){function t(e){var t={};function r(i){if(t[i])return t[i].exports;var a=t[i]={i:i,l:!1,exports:{}};return e[i].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=t,r.i=function(e){return e},r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:i})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/",r.oe=function(e){throw console.error(e),e};var i=r(r.s=ENTRY_MODULE);return i.default||i}var r="[\\.|\\-|\\+|\\w|/|@]+",i="\\(\\s*(/\\*.*?\\*/)?\\s*.*?([\\.|\\-|\\+|\\w|/|@]+).*?\\)";function a(e){return(e+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function s(e,t,s){var n={};n[s]=[];var o=t.toString(),l=o.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/);if(!l)return n;for(var h,d=l[1],u=new RegExp("(\\\\n|\\W)"+a(d)+i,"g");h=u.exec(o);)"dll-reference"!==h[3]&&n[s].push(h[3]);for(u=new RegExp("\\("+a(d)+'\\("(dll-reference\\s('+r+'))"\\)\\)'+i,"g");h=u.exec(o);)e[h[2]]||(n[s].push(h[1]),e[h[2]]=__webpack_require__(h[1]).m),n[h[2]]=n[h[2]]||[],n[h[2]].push(h[4]);for(var c,f=Object.keys(n),g=0;g<f.length;g++)for(var v=0;v<n[f[g]].length;v++)c=n[f[g]][v],isNaN(1*c)||(n[f[g]][v]=1*n[f[g]][v]);return n}function n(e){return Object.keys(e).reduce((function(t,r){return t||e[r].length>0}),!1)}e.exports=function(e,r){r=r||{};var i={main:__webpack_modules__},a=r.all?{main:Object.keys(i.main)}:function(e,t){for(var r={main:[t]},i={main:[]},a={main:{}};n(r);)for(var o=Object.keys(r),l=0;l<o.length;l++){var h=o[l],d=r[h].pop();if(a[h]=a[h]||{},!a[h][d]&&e[h][d]){a[h][d]=!0,i[h]=i[h]||[],i[h].push(d);for(var u=s(e,e[h][d],h),c=Object.keys(u),f=0;f<c.length;f++)r[c[f]]=r[c[f]]||[],r[c[f]]=r[c[f]].concat(u[c[f]])}}return i}(i,e),o="";Object.keys(a).filter((function(e){return"main"!==e})).forEach((function(e){for(var r=0;a[e][r];)r++;a[e].push(r),i[e][r]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",o=o+"var "+e+" = ("+t.toString().replace("ENTRY_MODULE",JSON.stringify(r))+")({"+a[e].map((function(t){return JSON.stringify(t)+": "+i[e][t].toString()})).join(",")+"});\n"})),o=o+"new (("+t.toString().replace("ENTRY_MODULE",JSON.stringify(e))+")({"+a.main.map((function(e){return JSON.stringify(e)+": "+i.main[e].toString()})).join(",")+"}))(self);";var l=new window.Blob([o],{type:"text/javascript"});if(r.bare)return l;var h=(window.URL||window.webkitURL||window.mozURL||window.msURL).createObjectURL(l),d=new window.Worker(h);return d.objectURL=h,d}})),yt=Object.freeze(e({__proto__:null,default:Tt,__moduleExports:Tt},[Tt]));class Et{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.initPTS=null}resetInitSegment(e,t,r){this._id3Track={type:"id3",id:0,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(){}resetContiguity(){}canParse(e,t){return!1}appendFrame(e,t,r){}demux(e,t){this.cachedData&&(e=k(this.cachedData,e),this.cachedData=null);var r,i,a=te(e,0),s=a?a.length:0,n=this._audioTrack,o=this._id3Track,l=a?(e=>{for(var t=ne(e),r=0;r<t.length;r++){var i=t[r];if(ae(i))return ue(i)}})(a):void 0,h=e.length;for(0!==this.frameIndex&&null!==this.initPTS||(this.initPTS=St(l,t)),a&&a.length>0&&o.samples.push({pts:this.initPTS,dts:this.initPTS,data:a}),i=this.initPTS;s<h;){if(this.canParse(e,s)){var d=this.appendFrame(n,e,s);d?(this.frameIndex++,i=d.sample.pts,r=s+=d.length):s=h}else ie(e,s)?(a=te(e,s),o.samples.push({pts:i,dts:i,data:a}),r=s+=a.length):s++;if(s===h&&r!==h){var u=f(e,r);this.cachedData?this.cachedData=k(this.cachedData,u):this.cachedData=u}}return{audioTrack:n,avcTrack:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0},id3Track:o,textTrack:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0}}}demuxSampleAes(e,t,r){return Promise.reject(new Error("["+this+"] This demuxer does not support Sample-AES decryption"))}flush(e){var t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),this.frameIndex=0,{audioTrack:this._audioTrack,avcTrack:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0},id3Track:this._id3Track,textTrack:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0}}}destroy(){}}var St=(e,t)=>Number.isFinite(e)?90*e:9e4*t;function Lt(e,t){return 255===e[t]&&240==(246&e[t+1])}function bt(e,t){return 1&e[t+1]?7:9}function At(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}function Rt(e,t){return t+1<e.length&&Lt(e,t)}function Dt(e,t){if(Rt(e,t)){var r=bt(e,t);if(t+r>=e.length)return!1;var i=At(e,t);if(i<=r)return!1;var a=t+i;return a===e.length||Rt(e,a)}return!1}function kt(e,t,s,n,o){if(!e.samplerate){var l=function(e,t,s,n){var o,l,h,d,u=navigator.userAgent.toLowerCase(),f=n,g=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];o=1+((192&t[s+2])>>>6);var v=(60&t[s+2])>>>2;if(!(v>g.length-1))return h=(1&t[s+2])<<2,h|=(192&t[s+3])>>>6,c.log("manifest codec:"+n+", ADTS type:"+o+", samplingIndex:"+v),/firefox/i.test(u)?v>=6?(o=5,d=new Array(4),l=v-3):(o=2,d=new Array(2),l=v):-1!==u.indexOf("android")?(o=2,d=new Array(2),l=v):(o=5,d=new Array(4),n&&(-1!==n.indexOf("mp4a.40.29")||-1!==n.indexOf("mp4a.40.5"))||!n&&v>=6?l=v-3:((n&&-1!==n.indexOf("mp4a.40.2")&&(v>=6&&1===h||/vivaldi/i.test(u))||!n&&1===h)&&(o=2,d=new Array(2)),l=v)),d[0]=o<<3,d[0]|=(14&v)>>1,d[1]|=(1&v)<<7,d[1]|=h<<3,5===o&&(d[1]|=(14&l)>>1,d[2]=(1&l)<<7,d[2]|=8,d[3]=0),{config:d,samplerate:g[v],channelCount:h,codec:"mp4a.40."+o,manifestCodec:f};e.trigger(r.ERROR,{type:i.MEDIA_ERROR,details:a.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ADTS sampling index:"+v})}(t,s,n,o);if(!l)return;e.config=l.config,e.samplerate=l.samplerate,e.channelCount=l.channelCount,e.codec=l.codec,e.manifestCodec=l.manifestCodec,c.log("parsed codec:"+e.codec+", rate:"+l.samplerate+", channels:"+l.channelCount)}}function Ct(e){return 9216e4/e}function _t(e,t,r,i,a){var s=function(e,t,r,i,a){var s=bt(e,t),n=At(e,t);if((n-=s)>0)return{headerLength:s,frameLength:n,stamp:r+i*a}}(t,r,i,a,Ct(e.samplerate));if(s){var n,{frameLength:o,headerLength:l,stamp:h}=s,d=l+o,u=Math.max(0,r+d-t.length);u?(n=new Uint8Array(d-l)).set(t.subarray(r+l,t.length),0):n=t.subarray(r+l,r+d);var c={unit:n,pts:h};return u||e.samples.push(c),{sample:c,length:d,missing:u}}}class It extends Et{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,r){super.resetInitSegment(e,t,r),this._audioTrack={container:"audio/adts",type:"audio",id:0,pid:-1,sequenceNumber:0,isAAC:!0,samples:[],manifestCodec:e,duration:r,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;for(var t=(te(e,0)||[]).length,r=e.length;t<r;t++)if(Dt(e,t))return c.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return function(e,t){return t+5<e.length}(e,t)&&Lt(e,t)&&At(e,t)<=e.length-t}(e,t)}appendFrame(e,t,r){kt(e,this.observer,t,r,e.manifestCodec);var i=_t(e,t,r,this.initPTS,this.frameIndex);if(i&&0===i.missing)return i}}It.minProbeByteLength=9;class wt{constructor(e,t){this.remainderData=null,this.config=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(){}resetContiguity(){}static probe(e){return A({data:e,start:0,end:Math.min(e.length,16384)},["moof"]).length>0}demux(e){var t=e,r={type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0};if(this.config.progressive){this.remainderData&&(t=k(this.remainderData,e));var i=function(e){var t={valid:null,remainder:null},r=A(e,["moof"]);if(!r)return t;if(r.length<2)return t.remainder=e,t;var i=r[r.length-1];return t.valid=f(e,0,i.start-8),t.remainder=f(e,i.start-8),t}(t);this.remainderData=i.remainder,r.samples=i.valid||new Uint8Array}else r.samples=t;return{audioTrack:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0},avcTrack:r,id3Track:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0},textTrack:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0}}}flush(){var e={type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0};return e.samples=this.remainderData||new Uint8Array,this.remainderData=null,{audioTrack:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0},avcTrack:e,id3Track:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0},textTrack:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0}}}demuxSampleAes(e,t,r){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}}wt.minProbeByteLength=1024;var xt=null,Ot=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],Pt=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],Ft=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],Mt=[0,1,1,4];function Nt(e,t,r,i,a){if(!(r+24>t.length)){var s=Ut(t,r);if(s&&r+s.frameLength<=t.length){var n=i+a*(9e4*s.samplesPerFrame/s.sampleRate),o={unit:t.subarray(r,r+s.frameLength),pts:n,dts:n};return e.config=[],e.channelCount=s.channelCount,e.samplerate=s.sampleRate,e.samples.push(o),{sample:o,length:s.frameLength,missing:0}}}}function Ut(e,t){var r=e[t+1]>>3&3,i=e[t+1]>>1&3,a=e[t+2]>>4&15,s=e[t+2]>>2&3;if(1!==r&&0!==a&&15!==a&&3!==s){var n=e[t+2]>>1&1,o=e[t+3]>>6,l=1e3*Ot[14*(3===r?3-i:3===i?3:4)+a-1],h=Pt[3*(3===r?0:2===r?1:2)+s],d=3===o?1:2,u=Ft[r][i],c=Mt[i],f=8*u*c,g=Math.floor(u*l/h+n)*c;if(null===xt){var v=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);xt=v?parseInt(v[1]):0}return!!xt&&xt<=87&&2===i&&l>=224e3&&0===o&&(e[t+3]=128|e[t+3]),{sampleRate:h,channelCount:d,frameLength:g,samplesPerFrame:f}}}function Bt(e,t){return 255===e[t]&&224==(224&e[t+1])&&0!=(6&e[t+1])}function Gt(e,t){return t+1<e.length&&Bt(e,t)}function Ht(e,t){if(t+1<e.length&&Bt(e,t)){var r=Ut(e,t),i=4;null!=r&&r.frameLength&&(i=r.frameLength);var a=t+i;return a===e.length||Gt(e,a)}return!1}class Kt{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){var e=this.data,t=this.bytesAvailable,r=e.byteLength-t,i=new Uint8Array(4),a=Math.min(4,t);if(0===a)throw new Error("no bytes available");i.set(e.subarray(r,r+a)),this.word=new DataView(i.buffer).getUint32(0),this.bitsAvailable=8*a,this.bytesAvailable-=a}skipBits(e){var t;this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,e-=(t=e>>3)>>3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){var t=Math.min(this.bitsAvailable,e),r=this.word>>>32-t;return e>32&&c.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0?this.word<<=t:this.bytesAvailable>0&&this.loadWord(),(t=e-t)>0&&this.bitsAvailable?r<<t|this.readBits(t):r}skipLZ(){var e;for(e=0;e<this.bitsAvailable;++e)if(0!=(this.word&2147483648>>>e))return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){var e=this.skipLZ();return this.readBits(e+1)-1}readEG(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){for(var t=8,r=8,i=0;i<e;i++)0!==r&&(r=(t+this.readEG()+256)%256),t=0===r?t:r}readSPS(){var e,t,r,i=0,a=0,s=0,n=0,o=this.readUByte.bind(this),l=this.readBits.bind(this),h=this.readUEG.bind(this),d=this.readBoolean.bind(this),u=this.skipBits.bind(this),c=this.skipEG.bind(this),f=this.skipUEG.bind(this),g=this.skipScalingList.bind(this);o();var v=o();if(l(5),u(3),o(),f(),100===v||110===v||122===v||244===v||44===v||83===v||86===v||118===v||128===v){var m=h();if(3===m&&u(1),f(),f(),u(1),d())for(t=3!==m?8:12,r=0;r<t;r++)d()&&g(r<6?16:64)}f();var p=h();if(0===p)h();else if(1===p)for(u(1),c(),c(),e=h(),r=0;r<e;r++)c();f(),u(1);var T=h(),y=h(),E=l(1);0===E&&u(1),u(1),d()&&(i=h(),a=h(),s=h(),n=h());var S=[1,1];if(d()&&d())switch(o()){case 1:S=[1,1];break;case 2:S=[12,11];break;case 3:S=[10,11];break;case 4:S=[16,11];break;case 5:S=[40,33];break;case 6:S=[24,11];break;case 7:S=[20,11];break;case 8:S=[32,11];break;case 9:S=[80,33];break;case 10:S=[18,11];break;case 11:S=[15,11];break;case 12:S=[64,33];break;case 13:S=[160,99];break;case 14:S=[4,3];break;case 15:S=[3,2];break;case 16:S=[2,1];break;case 255:S=[o()<<8|o(),o()<<8|o()]}return{width:Math.ceil(16*(T+1)-2*i-2*a),height:(2-E)*(y+1)*16-(E?2:4)*(s+n),pixelRatio:S}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class Vt{constructor(e,t,r){this.keyData=void 0,this.decrypter=void 0,this.keyData=r,this.decrypter=new rt(e,t,{removePKCS7Padding:!1})}decryptBuffer(e,t){this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,t)}decryptAacSample(e,t,r,i){var a=e[t].unit,s=a.subarray(16,a.length-a.length%16),n=s.buffer.slice(s.byteOffset,s.byteOffset+s.length),o=this;this.decryptBuffer(n,(s=>{var n=new Uint8Array(s);a.set(n,16),i||o.decryptAacSamples(e,t+1,r)}))}decryptAacSamples(e,t,r){for(;;t++){if(t>=e.length)return void r();if(!(e[t].unit.length<32)){var i=this.decrypter.isSync();if(this.decryptAacSample(e,t,r,i),!i)return}}}getAvcEncryptedData(e){for(var t=16*Math.floor((e.length-48)/160)+16,r=new Int8Array(t),i=0,a=32;a<=e.length-16;a+=160,i+=16)r.set(e.subarray(a,a+16),i);return r}getAvcDecryptedUnit(e,t){for(var r=new Uint8Array(t),i=0,a=32;a<=e.length-16;a+=160,i+=16)e.set(r.subarray(i,i+16),a);return e}decryptAvcSample(e,t,r,i,a,s){var n=Zt(a.data),o=this.getAvcEncryptedData(n),l=this;this.decryptBuffer(o.buffer,(function(o){a.data=l.getAvcDecryptedUnit(n,o),s||l.decryptAvcSamples(e,t,r+1,i)}))}decryptAvcSamples(e,t,r,i){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,r=0){if(t>=e.length)return void i();for(var a=e[t].units;!(r>=a.length);r++){var s=a[r];if(!(s.data.length<=48||1!==s.type&&5!==s.type)){var n=this.decrypter.isSync();if(this.decryptAvcSample(e,t,r,i,s,n),!n)return}}}}}var jt={video:1,audio:2,id3:3,text:4};class Wt{constructor(e,t,r){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this.aacLastPTS=null,this._initPTS=null,this._initDTS=null,this._pmtId=-1,this._avcTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.observer=e,this.config=t,this.typeSupported=r}static probe(e){var t=Wt.syncOffset(e);return!(t<0)&&(t&&c.warn("MPEG2-TS detected but first sync word found @ offset "+t+", junk ahead ?"),!0)}static syncOffset(e){for(var t=Math.min(1e3,e.length-564),r=0;r<t;){if(71===e[r]&&71===e[r+188]&&71===e[r+376])return r;r++}return-1}static createTrack(e,t){return{container:"video"===e||"audio"===e?"video/mp2t":void 0,type:e,id:jt[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===e?t:void 0}}resetInitSegment(e,t,r){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack=Wt.createTrack("video",r),this._audioTrack=Wt.createTrack("audio",r),this._id3Track=Wt.createTrack("id3",r),this._txtTrack=Wt.createTrack("text",r),this._audioTrack.isAAC=!0,this.aacOverFlow=null,this.aacLastPTS=null,this.avcSample=null,this.audioCodec=e,this.videoCodec=t,this._duration=r}resetTimeStamp(){}resetContiguity(){var{_audioTrack:e,_avcTrack:t,_id3Track:r}=this;e&&(e.pesData=null),t&&(t.pesData=null),r&&(r.pesData=null),this.aacOverFlow=null,this.aacLastPTS=null}demux(e,t,s,n){var o;void 0===s&&(s=!1),void 0===n&&(n=!1),s||(this.sampleAes=null);var l=this._avcTrack,h=this._audioTrack,d=this._id3Track,u=l.pid,f=l.pesData,g=h.pid,v=d.pid,m=h.pesData,p=d.pesData,T=!1,y=this.pmtParsed,E=this._pmtId,S=e.length;if(this.remainderData&&(S=(e=k(this.remainderData,e)).length,this.remainderData=null),S<188&&!n)return this.remainderData=e,{audioTrack:h,avcTrack:l,id3Track:d,textTrack:this._txtTrack};var L=Math.max(0,Wt.syncOffset(e));(S-=(S+L)%188)<e.byteLength&&!n&&(this.remainderData=new Uint8Array(e.buffer,S,e.buffer.byteLength-S));for(var b=L;b<S;b+=188)if(71===e[b]){var A=!!(64&e[b+1]),R=((31&e[b+1])<<8)+e[b+2],D=void 0;if((48&e[b+3])>>4>1){if((D=b+5+e[b+4])===b+188)continue}else D=b+4;switch(R){case u:A&&(f&&(o=zt(f))&&this.parseAVCPES(o,!1),f={data:[],size:0}),f&&(f.data.push(e.subarray(D,b+188)),f.size+=b+188-D);break;case g:A&&(m&&(o=zt(m))&&(h.isAAC?this.parseAACPES(o):this.parseMPEGPES(o)),m={data:[],size:0}),m&&(m.data.push(e.subarray(D,b+188)),m.size+=b+188-D);break;case v:A&&(p&&(o=zt(p))&&this.parseID3PES(o),p={data:[],size:0}),p&&(p.data.push(e.subarray(D,b+188)),p.size+=b+188-D);break;case 0:A&&(D+=e[D]+1),E=this._pmtId=Xt(e,D);break;case E:A&&(D+=e[D]+1);var C=Yt(e,D,!0===this.typeSupported.mpeg||!0===this.typeSupported.mp3,s);(u=C.avc)>0&&(l.pid=u),(g=C.audio)>0&&(h.pid=g,h.isAAC=C.isAAC),(v=C.id3)>0&&(d.pid=v),T&&!y&&(c.log("reparse from beginning"),T=!1,b=L-188),y=this.pmtParsed=!0;break;case 17:case 8191:break;default:T=!0}}else this.observer.emit(r.ERROR,r.ERROR,{type:i.MEDIA_ERROR,details:a.FRAG_PARSING_ERROR,fatal:!1,reason:"TS packet did not start with 0x47"});l.pesData=f,h.pesData=m,d.pesData=p;var _={audioTrack:h,avcTrack:l,id3Track:d,textTrack:this._txtTrack};return n&&this.extractRemainingSamples(_),_}flush(){var e,{remainderData:t}=this;return this.remainderData=null,e=t?this.demux(t,-1,!1,!0):{audioTrack:this._audioTrack,avcTrack:this._avcTrack,textTrack:this._txtTrack,id3Track:this._id3Track},this.extractRemainingSamples(e),this.sampleAes?this.decrypt(e,this.sampleAes):e}extractRemainingSamples(e){var t,{audioTrack:r,avcTrack:i,id3Track:a}=e,s=i.pesData,n=r.pesData,o=a.pesData;s&&(t=zt(s))?(this.parseAVCPES(t,!0),i.pesData=null):i.pesData=s,n&&(t=zt(n))?(r.isAAC?this.parseAACPES(t):this.parseMPEGPES(t),r.pesData=null):(null!=n&&n.size&&c.log("last AAC PES packet truncated,might overlap between fragments"),r.pesData=n),o&&(t=zt(o))?(this.parseID3PES(t),a.pesData=null):a.pesData=o}demuxSampleAes(e,t,r){var i=this.demux(e,r,!0,!this.config.progressive),a=this.sampleAes=new Vt(this.observer,this.config,t);return this.decrypt(i,a)}decrypt(e,t){return new Promise((r=>{var{audioTrack:i,avcTrack:a}=e;i.samples&&i.isAAC?t.decryptAacSamples(i.samples,0,(()=>{a.samples?t.decryptAvcSamples(a.samples,0,0,(()=>{r(e)})):r(e)})):a.samples&&t.decryptAvcSamples(a.samples,0,0,(()=>{r(e)}))}))}destroy(){this._initPTS=this._initDTS=null,this._duration=0}parseAVCPES(e,t){var r,i=this._avcTrack,a=this.parseAVCNALu(e.data),s=this.avcSample,n=!1;e.data=null,s&&a.length&&!i.audFound&&(Qt(s,i),s=this.avcSample=qt(!1,e.pts,e.dts,"")),a.forEach((t=>{switch(t.type){case 1:r=!0,s||(s=this.avcSample=qt(!0,e.pts,e.dts,"")),s.frame=!0;var a=t.data;if(n&&a.length>4){var o=new Kt(a).readSliceType();2!==o&&4!==o&&7!==o&&9!==o||(s.key=!0)}break;case 5:r=!0,s||(s=this.avcSample=qt(!0,e.pts,e.dts,"")),s.key=!0,s.frame=!0;break;case 6:r=!0;var l=new Kt(Zt(t.data));l.readUByte();for(var h=0,d=0,u=!1,c=0;!u&&l.bytesAvailable>1;){h=0;do{h+=c=l.readUByte()}while(255===c);d=0;do{d+=c=l.readUByte()}while(255===c);if(4===h&&0!==l.bytesAvailable){if(u=!0,181===l.readUByte())if(49===l.readUShort())if(1195456820===l.readUInt())if(3===l.readUByte()){for(var f=l.readUByte(),g=31&f,v=[f,l.readUByte()],m=0;m<g;m++)v.push(l.readUByte()),v.push(l.readUByte()),v.push(l.readUByte());$t(this._txtTrack.samples,{type:3,pts:e.pts,bytes:v})}}else if(5===h&&0!==l.bytesAvailable){if(u=!0,d>16){for(var p=[],T=0;T<16;T++)p.push(l.readUByte().toString(16)),3!==T&&5!==T&&7!==T&&9!==T||p.push("-");for(var y=d-16,E=new Uint8Array(y),S=0;S<y;S++)E[S]=l.readUByte();$t(this._txtTrack.samples,{pts:e.pts,payloadType:h,uuid:p.join(""),userData:ce(E),userDataBytes:E})}}else if(d<l.bytesAvailable)for(var L=0;L<d;L++)l.readUByte()}break;case 7:if(r=!0,n=!0,!i.sps){var b=new Kt(t.data).readSPS();i.width=b.width,i.height=b.height,i.pixelRatio=b.pixelRatio,i.sps=[t.data],i.duration=this._duration;for(var A=t.data.subarray(1,4),R="avc1.",D=0;D<3;D++){var k=A[D].toString(16);k.length<2&&(k="0"+k),R+=k}i.codec=R}break;case 8:r=!0,i.pps||(i.pps=[t.data]);break;case 9:r=!1,i.audFound=!0,s&&Qt(s,i),s=this.avcSample=qt(!1,e.pts,e.dts,"");break;case 12:r=!1;break;default:r=!1,s&&(s.debug+="unknown NAL "+t.type+" ")}s&&r&&s.units.push(t)})),t&&s&&(Qt(s,i),this.avcSample=null)}getLastNalUnit(){var e,t,r=this.avcSample;if(!r||0===r.units.length){var i=this._avcTrack.samples;r=i[i.length-1]}if(null!==(e=r)&&void 0!==e&&e.units){var a=r.units;t=a[a.length-1]}return t}parseAVCNALu(e){var t,r,i=e.byteLength,a=this._avcTrack,s=a.naluState||0,n=s,o=[],l=0,h=-1,d=0;for(-1===s&&(h=0,d=31&e[0],s=0,l=1);l<i;)if(t=e[l++],s)if(1!==s)if(t)if(1===t){if(h>=0){var u={data:e.subarray(h,l-s-1),type:d};o.push(u)}else{var c=this.getLastNalUnit();if(c&&(n&&l<=4-n&&c.state&&(c.data=c.data.subarray(0,c.data.byteLength-n)),(r=l-s-1)>0)){var f=new Uint8Array(c.data.byteLength+r);f.set(c.data,0),f.set(e.subarray(0,r),c.data.byteLength),c.data=f}}l<i?(h=l,d=31&e[l],s=0):s=-1}else s=0;else s=3;else s=t?0:2;else s=t?0:1;if(h>=0&&s>=0){var g={data:e.subarray(h,i),type:d,state:s};o.push(g)}if(0===o.length){var v=this.getLastNalUnit();if(v){var m=new Uint8Array(v.data.byteLength+e.byteLength);m.set(v.data,0),m.set(e,v.data.byteLength),v.data=m}}return a.naluState=s,o}parseAACPES(e){var t,s,n,o,l,h=0,d=this._audioTrack,u=this.aacOverFlow,f=e.data;if(u){this.aacOverFlow=null;var g=u.sample.unit.byteLength,v=Math.min(u.missing,g),m=g-v;u.sample.unit.set(f.subarray(0,v),m),d.samples.push(u.sample),h=u.missing}for(t=h,s=f.length;t<s-1&&!Rt(f,t);t++);if(t!==h&&(t<s-1?(n="AAC PES did not start with ADTS header,offset:"+t,o=!1):(n="no ADTS header found in AAC PES",o=!0),c.warn("parsing error:"+n),this.observer.emit(r.ERROR,r.ERROR,{type:i.MEDIA_ERROR,details:a.FRAG_PARSING_ERROR,fatal:o,reason:n}),o))return;if(kt(d,this.observer,f,t,this.audioCodec),void 0!==e.pts)l=e.pts;else{if(!u)return void c.warn("[tsdemuxer]: AAC PES unknown PTS");var p=Ct(d.samplerate);l=u.sample.pts+p}for(var T=0;t<s;){if(Rt(f,t)){if(t+5<s){var y=_t(d,f,t,l,T);if(y){if(!y.missing){t+=y.length,T++;continue}this.aacOverFlow=y}}break}t++}}parseMPEGPES(e){var t=e.data,r=t.length,i=0,a=0,s=e.pts;if(void 0!==s)for(;a<r;)if(Gt(t,a)){var n=Nt(this._audioTrack,t,a,s,i);if(!n)break;a+=n.length,i++}else a++;else c.warn("[tsdemuxer]: MPEG PES unknown PTS")}parseID3PES(e){void 0!==e.pts?this._id3Track.samples.push(e):c.warn("[tsdemuxer]: ID3 PES unknown PTS")}}function qt(e,t,r,i){return{key:e,frame:!1,pts:t,dts:r,units:[],debug:i,length:0}}function Xt(e,t){return(31&e[t+10])<<8|e[t+11]}function Yt(e,t,r,i){var a={audio:-1,avc:-1,id3:-1,isAAC:!0},s=t+3+((15&e[t+1])<<8|e[t+2])-4;for(t+=12+((15&e[t+10])<<8|e[t+11]);t<s;){var n=(31&e[t+1])<<8|e[t+2];switch(e[t]){case 207:if(!i){c.log("ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:-1===a.audio&&(a.audio=n);break;case 21:-1===a.id3&&(a.id3=n);break;case 219:if(!i){c.log("H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:-1===a.avc&&(a.avc=n);break;case 3:case 4:r?-1===a.audio&&(a.audio=n,a.isAAC=!1):c.log("MPEG audio found, not supported in this browser");break;case 36:c.warn("Unsupported HEVC stream type found")}t+=5+((15&e[t+3])<<8|e[t+4])}return a}function zt(e){var t,r,i,a,s,n=0,o=e.data;if(!e||0===e.size)return null;for(;o[0].length<19&&o.length>1;){var l=new Uint8Array(o[0].length+o[1].length);l.set(o[0]),l.set(o[1],o[0].length),o[0]=l,o.splice(1,1)}if(1===((t=o[0])[0]<<16)+(t[1]<<8)+t[2]){if((r=(t[4]<<8)+t[5])&&r>e.size-6)return null;var h=t[7];192&h&&(a=536870912*(14&t[9])+4194304*(255&t[10])+16384*(254&t[11])+128*(255&t[12])+(254&t[13])/2,64&h?a-(s=536870912*(14&t[14])+4194304*(255&t[15])+16384*(254&t[16])+128*(255&t[17])+(254&t[18])/2)>54e5&&(c.warn(Math.round((a-s)/9e4)+"s delta between PTS and DTS, align them"),a=s):s=a);var d=(i=t[8])+9;if(e.size<=d)return null;e.size-=d;for(var u=new Uint8Array(e.size),f=0,g=o.length;f<g;f++){var v=(t=o[f]).byteLength;if(d){if(d>v){d-=v;continue}t=t.subarray(d),v-=d,d=0}u.set(t,n),n+=v}return r&&(r-=i+3),{data:u,pts:a,dts:s,len:r}}return null}function Qt(e,t){if(e.units.length&&e.frame){if(void 0===e.pts){var r=t.samples,i=r.length;if(!i)return void t.dropped++;var a=r[i-1];e.pts=a.pts,e.dts=a.dts}t.samples.push(e)}e.debug.length&&c.log(e.pts+"/"+e.dts+":"+e.debug)}function $t(e,t){var r=e.length;if(r>0){if(t.pts>=e[r-1].pts)e.push(t);else for(var i=r-1;i>=0;i--)if(t.pts<e[i].pts){e.splice(i,0,t);break}}else e.push(t)}function Zt(e){for(var t=e.byteLength,r=[],i=1;i<t-2;)0===e[i]&&0===e[i+1]&&3===e[i+2]?(r.push(i+2),i+=2):i++;if(0===r.length)return e;var a=t-r.length,s=new Uint8Array(a),n=0;for(i=0;i<a;n++,i++)n===r[0]&&(n++,r.shift()),s[i]=e[n];return s}Wt.minProbeByteLength=188;class Jt extends Et{resetInitSegment(e,t,r){super.resetInitSegment(e,t,r),this._audioTrack={container:"audio/mpeg",type:"audio",id:0,pid:-1,sequenceNumber:0,isAAC:!1,samples:[],manifestCodec:e,duration:r,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;for(var t=(te(e,0)||[]).length,r=e.length;t<r;t++)if(Ht(e,t))return c.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return Bt(e,t)&&4<=e.length-t}(e,t)}appendFrame(e,t,r){if(null!==this.initPTS)return Nt(e,t,r,this.initPTS,this.frameIndex)}}Jt.minProbeByteLength=4;class er{static getSilentFrame(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}var tr=Math.pow(2,32)-1;class rr{static init(){var e;for(e in rr.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},rr.types)rr.types.hasOwnProperty(e)&&(rr.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);var t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),r=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);rr.HDLR_TYPES={video:t,audio:r};var i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),a=new Uint8Array([0,0,0,0,0,0,0,0]);rr.STTS=rr.STSC=rr.STCO=a,rr.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),rr.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),rr.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),rr.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var s=new Uint8Array([105,115,111,109]),n=new Uint8Array([97,118,99,49]),o=new Uint8Array([0,0,0,1]);rr.FTYP=rr.box(rr.types.ftyp,s,o,s,n),rr.DINF=rr.box(rr.types.dinf,rr.box(rr.types.dref,i))}static box(e){for(var t=8,r=arguments.length,i=new Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];for(var s=i.length,n=s;s--;)t+=i[s].byteLength;var o=new Uint8Array(t);for(o[0]=t>>24&255,o[1]=t>>16&255,o[2]=t>>8&255,o[3]=255&t,o.set(e,4),s=0,t=8;s<n;s++)o.set(i[s],t),t+=i[s].byteLength;return o}static hdlr(e){return rr.box(rr.types.hdlr,rr.HDLR_TYPES[e])}static mdat(e){return rr.box(rr.types.mdat,e)}static mdhd(e,t){t*=e;var r=Math.floor(t/(tr+1)),i=Math.floor(t%(tr+1));return rr.box(rr.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,r>>24,r>>16&255,r>>8&255,255&r,i>>24,i>>16&255,i>>8&255,255&i,85,196,0,0]))}static mdia(e){return rr.box(rr.types.mdia,rr.mdhd(e.timescale,e.duration),rr.hdlr(e.type),rr.minf(e))}static mfhd(e){return rr.box(rr.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?rr.box(rr.types.minf,rr.box(rr.types.smhd,rr.SMHD),rr.DINF,rr.stbl(e)):rr.box(rr.types.minf,rr.box(rr.types.vmhd,rr.VMHD),rr.DINF,rr.stbl(e))}static moof(e,t,r){return rr.box(rr.types.moof,rr.mfhd(e),rr.traf(r,t))}static moov(e){for(var t=e.length,r=[];t--;)r[t]=rr.trak(e[t]);return rr.box.apply(null,[rr.types.moov,rr.mvhd(e[0].timescale,e[0].duration)].concat(r).concat(rr.mvex(e)))}static mvex(e){for(var t=e.length,r=[];t--;)r[t]=rr.trex(e[t]);return rr.box.apply(null,[rr.types.mvex,...r])}static mvhd(e,t){t*=e;var r=Math.floor(t/(tr+1)),i=Math.floor(t%(tr+1)),a=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,r>>24,r>>16&255,r>>8&255,255&r,i>>24,i>>16&255,i>>8&255,255&i,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return rr.box(rr.types.mvhd,a)}static sdtp(e){var t,r,i=e.samples||[],a=new Uint8Array(4+i.length);for(t=0;t<i.length;t++)r=i[t].flags,a[t+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return rr.box(rr.types.sdtp,a)}static stbl(e){return rr.box(rr.types.stbl,rr.stsd(e),rr.box(rr.types.stts,rr.STTS),rr.box(rr.types.stsc,rr.STSC),rr.box(rr.types.stsz,rr.STSZ),rr.box(rr.types.stco,rr.STCO))}static avc1(e){var t,r,i,a=[],s=[];for(t=0;t<e.sps.length;t++)i=(r=e.sps[t]).byteLength,a.push(i>>>8&255),a.push(255&i),a=a.concat(Array.prototype.slice.call(r));for(t=0;t<e.pps.length;t++)i=(r=e.pps[t]).byteLength,s.push(i>>>8&255),s.push(255&i),s=s.concat(Array.prototype.slice.call(r));var n=rr.box(rr.types.avcC,new Uint8Array([1,a[3],a[4],a[5],255,224|e.sps.length].concat(a).concat([e.pps.length]).concat(s))),o=e.width,l=e.height,h=e.pixelRatio[0],d=e.pixelRatio[1];return rr.box(rr.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),n,rr.box(rr.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),rr.box(rr.types.pasp,new Uint8Array([h>>24,h>>16&255,h>>8&255,255&h,d>>24,d>>16&255,d>>8&255,255&d])))}static esds(e){var t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.config).concat([6,1,2]))}static mp4a(e){var t=e.samplerate;return rr.box(rr.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0]),rr.box(rr.types.esds,rr.esds(e)))}static mp3(e){var t=e.samplerate;return rr.box(rr.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0]))}static stsd(e){return"audio"===e.type?e.isAAC||"mp3"!==e.codec?rr.box(rr.types.stsd,rr.STSD,rr.mp4a(e)):rr.box(rr.types.stsd,rr.STSD,rr.mp3(e)):rr.box(rr.types.stsd,rr.STSD,rr.avc1(e))}static tkhd(e){var t=e.id,r=e.duration*e.timescale,i=e.width,a=e.height,s=Math.floor(r/(tr+1)),n=Math.floor(r%(tr+1));return rr.box(rr.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,s>>24,s>>16&255,s>>8&255,255&s,n>>24,n>>16&255,n>>8&255,255&n,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,i>>8&255,255&i,0,0,a>>8&255,255&a,0,0]))}static traf(e,t){var r=rr.sdtp(e),i=e.id,a=Math.floor(t/(tr+1)),s=Math.floor(t%(tr+1));return rr.box(rr.types.traf,rr.box(rr.types.tfhd,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i])),rr.box(rr.types.tfdt,new Uint8Array([1,0,0,0,a>>24,a>>16&255,a>>8&255,255&a,s>>24,s>>16&255,s>>8&255,255&s])),rr.trun(e,r.length+16+20+8+16+8+8),r)}static trak(e){return e.duration=e.duration||4294967295,rr.box(rr.types.trak,rr.tkhd(e),rr.mdia(e))}static trex(e){var t=e.id;return rr.box(rr.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){var r,i,a,s,n,o,l=e.samples||[],h=l.length,d=12+16*h,u=new Uint8Array(d);for(t+=8+d,u.set([0,0,15,1,h>>>24&255,h>>>16&255,h>>>8&255,255&h,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),r=0;r<h;r++)a=(i=l[r]).duration,s=i.size,n=i.flags,o=i.cts,u.set([a>>>24&255,a>>>16&255,a>>>8&255,255&a,s>>>24&255,s>>>16&255,s>>>8&255,255&s,n.isLeading<<2|n.dependsOn,n.isDependedOn<<6|n.hasRedundancy<<4|n.paddingValue<<1|n.isNonSync,61440&n.degradPrio,15&n.degradPrio,o>>>24&255,o>>>16&255,o>>>8&255,255&o],12+16*r);return rr.box(rr.types.trun,u)}static initSegment(e){rr.types||rr.init();var t=rr.moov(e),r=new Uint8Array(rr.FTYP.byteLength+t.byteLength);return r.set(rr.FTYP),r.set(t,rr.FTYP.byteLength),r}}rr.types=void 0,rr.HDLR_TYPES=void 0,rr.STTS=void 0,rr.STSC=void 0,rr.STCO=void 0,rr.STSZ=void 0,rr.VMHD=void 0,rr.SMHD=void 0,rr.STSD=void 0,rr.FTYP=void 0,rr.DINF=void 0;function ir(e,t,r,i){void 0===r&&(r=1),void 0===i&&(i=!1);var a=e*t*r;return i?Math.round(a):a}function ar(e,t){return void 0===t&&(t=!1),ir(e,1e3,1/9e4,t)}var sr=null,nr=null,or=!1;class lr{constructor(e,t,r,i){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=void 0,this._initDTS=void 0,this.nextAvcDts=null,this.nextAudioPts=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.observer=e,this.config=t,this.typeSupported=r,this.ISGenerated=!1,null===sr){var a=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);sr=a?parseInt(a[1]):0}if(null===nr){var s=navigator.userAgent.match(/Safari\/(\d+)/i);nr=s?parseInt(s[1]):0}or=!!sr&&sr<75||!!nr&&nr<600}destroy(){}resetTimeStamp(e){c.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){c.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){c.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1}getVideoStartPts(e){var t=!1,r=e.reduce(((e,r)=>{var i=r.pts-e;return i<-4294967296?(t=!0,hr(e,r.pts)):i>0?e:r.pts}),e[0].pts);return t&&c.debug("PTS rollover detected"),r}remux(e,t,r,i,a,s,n,o){var l,h,d,u,f,g,v=a,m=a,p=e.pid>-1,T=t.pid>-1,y=t.samples.length,E=e.samples.length>0,S=y>1;if((!p||E)&&(!T||S)||this.ISGenerated||n){this.ISGenerated||(d=this.generateIS(e,t,a));var L=this.isVideoContiguous,b=-1;if(S&&(b=function(e){for(var t=0;t<e.length;t++)if(e[t].key)return t;return-1}(t.samples),!L&&this.config.forceKeyFrameOnDiscontinuity))if(g=!0,b>0){c.warn("[mp4-remuxer]: Dropped "+b+" out of "+y+" video samples due to a missing keyframe");var A=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(b),t.dropped+=b,m+=(t.samples[0].pts-A)/(t.timescale||9e4)}else-1===b&&(c.warn("[mp4-remuxer]: No keyframe found out of "+y+" video samples"),g=!1);if(this.ISGenerated){if(E&&S){var R=this.getVideoStartPts(t.samples),D=(hr(e.samples[0].pts,R)-R)/t.inputTimeScale;v+=Math.max(0,D),m+=Math.max(0,-D)}if(E){if(e.samplerate||(c.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),d=this.generateIS(e,t,a)),h=this.remuxAudio(e,v,this.isAudioContiguous,s,T||S||o===F.AUDIO?m:void 0),S){var k=h?h.endPTS-h.startPTS:0;t.inputTimeScale||(c.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),d=this.generateIS(e,t,a)),l=this.remuxVideo(t,m,L,k)}}else S&&(l=this.remuxVideo(t,m,L,0));l&&(l.firstKeyFrame=b,l.independent=-1!==b)}}return this.ISGenerated&&(r.samples.length&&(f=this.remuxID3(r,a)),i.samples.length&&(u=this.remuxText(i,a))),{audio:h,video:l,initSegment:d,independent:g,text:u,id3:f}}generateIS(e,t,r){var i,a,s,n=e.samples,o=t.samples,l=this.typeSupported,h={},d=!Number.isFinite(this._initPTS),u="audio/mp4";if(d&&(i=a=1/0),e.config&&n.length&&(e.timescale=e.samplerate,e.isAAC||(l.mpeg?(u="audio/mpeg",e.codec=""):l.mp3&&(e.codec="mp3")),h.audio={id:"audio",container:u,codec:e.codec,initSegment:!e.isAAC&&l.mpeg?new Uint8Array(0):rr.initSegment([e]),metadata:{channelCount:e.channelCount}},d&&(s=e.inputTimeScale,i=a=n[0].pts-Math.round(s*r))),t.sps&&t.pps&&o.length&&(t.timescale=t.inputTimeScale,h.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:rr.initSegment([t]),metadata:{width:t.width,height:t.height}},d)){s=t.inputTimeScale;var c=this.getVideoStartPts(o),f=Math.round(s*r);a=Math.min(a,hr(o[0].dts,c)-f),i=Math.min(i,c-f)}if(Object.keys(h).length)return this.ISGenerated=!0,d&&(this._initPTS=i,this._initDTS=a),{tracks:h,initPTS:i,timescale:s}}remuxVideo(e,t,s,n){var o,l,h,d=e.inputTimeScale,u=e.samples,f=[],g=u.length,v=this._initPTS,m=this.nextAvcDts,p=8,T=Number.POSITIVE_INFINITY,y=Number.NEGATIVE_INFINITY,E=0,S=!1;s&&null!==m||(m=t*d-(u[0].pts-hr(u[0].dts,u[0].pts)));for(var L=0;L<g;L++){var b=u[L];if(b.pts=hr(b.pts-v,m),b.dts=hr(b.dts-v,m),b.dts>b.pts){E=Math.max(Math.min(E,b.pts-b.dts),-18e3)}b.dts<u[L>0?L-1:L].dts&&(S=!0)}S&&u.sort((function(e,t){var r=e.dts-t.dts,i=e.pts-t.pts;return r||i})),l=u[0].dts,h=u[u.length-1].dts;var A=Math.round((h-l)/(g-1));if(E<0){if(E<-2*A){c.warn("PTS < DTS detected in video samples, offsetting DTS from PTS by "+ar(-A,!0)+" ms");for(var R=E,D=0;D<g;D++)u[D].dts=R=Math.max(R,u[D].pts-A),u[D].pts=Math.max(R,u[D].pts)}else{c.warn("PTS < DTS detected in video samples, shifting DTS by "+ar(E,!0)+" ms to overcome this issue");for(var k=0;k<g;k++)u[k].dts=u[k].dts+E}l=u[0].dts}if(s){var C=l-m,_=C>A;if(_||C<-1){_?c.warn("AVC: "+ar(C,!0)+" ms ("+C+"dts) hole between fragments detected, filling it"):c.warn("AVC: "+ar(-C,!0)+" ms ("+C+"dts) overlapping between fragments detected"),l=m;var I=u[0].pts-C;u[0].dts=l,u[0].pts=I,c.log("Video: First PTS/DTS adjusted: "+ar(I,!0)+"/"+ar(l,!0)+", delta: "+ar(C,!0)+" ms")}}or&&(l=Math.max(0,l));for(var w=0,x=0,O=0;O<g;O++){for(var P=u[O],F=P.units,M=F.length,N=0,U=0;U<M;U++)N+=F[U].data.length;x+=N,w+=M,P.length=N,P.dts=Math.max(P.dts,l),P.pts=Math.max(P.pts,P.dts,0),T=Math.min(P.pts,T),y=Math.max(P.pts,y)}h=u[g-1].dts;var B,G=x+4*w+8;try{B=new Uint8Array(G)}catch(e){return void this.observer.emit(r.ERROR,r.ERROR,{type:i.MUX_ERROR,details:a.REMUX_ALLOC_ERROR,fatal:!1,bytes:G,reason:"fail allocating video mdat "+G})}var H=new DataView(B.buffer);H.setUint32(0,G),B.set(rr.types.mdat,4);for(var K=0;K<g;K++){for(var V=u[K],j=V.units,W=0,q=0,X=j.length;q<X;q++){var Y=j[q],z=Y.data,Q=Y.data.byteLength;H.setUint32(p,Q),p+=4,B.set(z,p),p+=Q,W+=4+Q}if(K<g-1)o=u[K+1].dts-V.dts;else{var $=this.config,Z=V.dts-u[K>0?K-1:K].dts;if($.stretchShortVideoTrack&&null!==this.nextAudioPts){var J=Math.floor($.maxBufferHole*d),ee=(n?T+n*d:this.nextAudioPts)-V.pts;ee>J?((o=ee-Z)<0&&(o=Z),c.log("[mp4-remuxer]: It is approximately "+ee/90+" ms to the next segment; using duration "+o/90+" ms for the last video frame.")):o=Z}else o=Z}var te=Math.round(V.pts-V.dts);f.push(new dr(V.key,o,W,te))}if(f.length&&sr&&sr<70){var re=f[0].flags;re.dependsOn=2,re.isNonSync=0}console.assert(void 0!==o,"mp4SampleDuration must be computed"),this.nextAvcDts=m=h+o,this.isVideoContiguous=!0;var ie={data1:rr.moof(e.sequenceNumber++,l,Ee({},e,{samples:f})),data2:B,startPTS:T/d,endPTS:(y+o)/d,startDTS:l/d,endDTS:m/d,type:"video",hasAudio:!1,hasVideo:!0,nb:f.length,dropped:e.dropped};return e.samples=[],e.dropped=0,console.assert(B.length,"MDAT length must not be zero"),ie}remuxAudio(e,t,s,n,o){var l=e.inputTimeScale,h=l/(e.samplerate?e.samplerate:l),d=e.isAAC?1024:1152,u=d*h,f=this._initPTS,g=!e.isAAC&&this.typeSupported.mpeg,v=[],m=e.samples,p=g?0:8,T=this.nextAudioPts||-1,y=t*l;if(this.isAudioContiguous=s=s||m.length&&T>0&&(n&&Math.abs(y-T)<9e3||Math.abs(hr(m[0].pts-f,y)-T)<20*u),m.forEach((function(e){e.pts=hr(e.pts-f,y)})),!s||T<0){if(m=m.filter((e=>e.pts>=0)),!m.length)return;T=0===o?0:n?Math.max(0,y):m[0].pts}if(e.isAAC)for(var E=void 0!==o,S=this.config.maxAudioFramesDrift,L=0,b=T;L<m.length;L++){var A=m[L],R=A.pts,D=R-b,k=Math.abs(1e3*D/l);if(D<=-S*u&&E)0===L&&(c.warn("Audio frame @ "+(R/l).toFixed(3)+"s overlaps nextAudioPts by "+Math.round(1e3*D/l)+" ms."),this.nextAudioPts=T=b=R);else if(D>=S*u&&k<1e4&&E){var C=Math.round(D/u);(b=R-C*u)<0&&(C--,b+=u),0===L&&(this.nextAudioPts=T=b),c.warn("[mp4-remuxer]: Injecting "+C+" audio frame @ "+(b/l).toFixed(3)+"s due to "+Math.round(1e3*D/l)+" ms gap.");for(var _=0;_<C;_++){var I=Math.max(b,0),w=er.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);w||(c.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),w=A.unit.subarray()),m.splice(L,0,{unit:w,pts:I}),b+=u,L++}}A.pts=b,b+=u}for(var x,O=null,P=null,F=0,M=m.length;M--;)F+=m[M].unit.byteLength;for(var N=0,U=m.length;N<U;N++){var B=m[N],G=B.unit,H=B.pts;if(null!==P){v[N-1].duration=Math.round((H-P)/h)}else{if(s&&e.isAAC&&(H=T),O=H,!(F>0))return;F+=p;try{x=new Uint8Array(F)}catch(e){return void this.observer.emit(r.ERROR,r.ERROR,{type:i.MUX_ERROR,details:a.REMUX_ALLOC_ERROR,fatal:!1,bytes:F,reason:"fail allocating audio mdat "+F})}g||(new DataView(x.buffer).setUint32(0,F),x.set(rr.types.mdat,4))}x.set(G,p);var K=G.byteLength;p+=K,v.push(new dr(!0,d,K,0)),P=H}var V=v.length;if(V){var j=v[v.length-1];this.nextAudioPts=T=P+h*j.duration;var W=g?new Uint8Array(0):rr.moof(e.sequenceNumber++,O/h,Ee({},e,{samples:v}));e.samples=[];var q=O/l,X=T/l,Y={data1:W,data2:x,startPTS:q,endPTS:X,startDTS:q,endDTS:X,type:"audio",hasAudio:!0,hasVideo:!1,nb:V};return this.isAudioContiguous=!0,console.assert(x.length,"MDAT length must not be zero"),Y}}remuxEmptyAudio(e,t,r,i){var a=e.inputTimeScale,s=a/(e.samplerate?e.samplerate:a),n=this.nextAudioPts,o=(null!==n?n:i.startDTS*a)+this._initDTS,l=i.endDTS*a+this._initDTS,h=1024*s,d=Math.ceil((l-o)/h),u=er.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if(c.warn("[mp4-remuxer]: remux empty Audio"),u){for(var f=[],g=0;g<d;g++){var v=o+g*h;f.push({unit:u,pts:v,dts:v})}return e.samples=f,this.remuxAudio(e,t,r,!1)}c.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec")}remuxID3(e,t){var r=e.samples.length;if(r){for(var i=e.inputTimeScale,a=this._initPTS,s=this._initDTS,n=0;n<r;n++){var o=e.samples[n];o.pts=hr(o.pts-a,t*i)/i,o.dts=hr(o.dts-s,t*i)/i}var l=e.samples;return e.samples=[],{samples:l}}}remuxText(e,t){var r=e.samples.length;if(r){for(var i=e.inputTimeScale,a=this._initPTS,s=0;s<r;s++){var n=e.samples[s];n.pts=hr(n.pts-a,t*i)/i}e.samples.sort(((e,t)=>e.pts-t.pts));var o=e.samples;return e.samples=[],{samples:o}}}}function hr(e,t){var r;if(null===t)return e;for(r=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=r;return e}class dr{constructor(e,t,r,i){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=t,this.size=r,this.cts=i,this.flags=new ur(e)}}class ur{constructor(e){this.isLeading=0,this.isDependedOn=0,this.hasRedundancy=0,this.degradPrio=0,this.dependsOn=1,this.isNonSync=1,this.dependsOn=e?2:1,this.isNonSync=e?0:1}}class cr{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=void 0,this.initTracks=void 0,this.lastEndDTS=null}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndDTS=null}resetNextTimestamp(){this.lastEndDTS=null}resetInitSegment(e,t,r){this.audioCodec=t,this.videoCodec=r,this.generateInitSegment(e),this.emitInitSegment=!0}generateInitSegment(e){var{audioCodec:t,videoCodec:r}=this;if(!e||!e.byteLength)return this.initTracks=void 0,void(this.initData=void 0);var i=this.initData=function(e){for(var t=[],r=A(e,["moov","trak"]),i=0;i<r.length;i++){var a=r[i],s=A(a,["tkhd"])[0];if(s){var n=s.data[s.start],o=0===n?12:20,l=L(s,o),h=A(a,["mdia","mdhd"])[0];if(h){var d=L(h,o=0===(n=h.data[h.start])?12:20),c=A(a,["mdia","hdlr"])[0];if(c){var f=S(c.data.subarray(c.start+8,c.start+12)),g={soun:u.AUDIO,vide:u.VIDEO}[f];if(g){var v=A(a,["mdia","minf","stbl","stsd"])[0],m=void 0;v&&(m=S(v.data.subarray(v.start+12,v.start+16))),t[l]={timescale:d,type:g},t[g]={timescale:d,id:l,codec:m}}}}}}return A(e,["moov","mvex","trex"]).forEach((e=>{var r=L(e,4),i=t[r];i&&(i.default={duration:L(e,12),flags:L(e,20)})})),t}(e);t||(t=vr(i.audio,u.AUDIO)),r||(r=vr(i.video,u.VIDEO));var a={};i.audio&&i.video?a.audiovideo={container:"video/mp4",codec:t+","+r,initSegment:e,id:"main"}:i.audio?a.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:i.video?a.video={container:"video/mp4",codec:r,initSegment:e,id:"main"}:c.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=a}remux(e,t,r,i,a){var{initPTS:s,lastEndDTS:n}=this,o={audio:void 0,video:void 0,text:i,id3:r,initSegment:void 0};Number.isFinite(n)||(n=this.lastEndDTS=a||0);var l=t.samples;if(!l||!l.length)return o;var h={initPTS:void 0,timescale:1},d=this.initData;if(d&&d.length||(this.generateInitSegment(l),d=this.initData),!d||!d.length)return c.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),o;this.emitInitSegment&&(h.tracks=this.initTracks,this.emitInitSegment=!1),Number.isFinite(s)||(this.initPTS=h.initPTS=s=gr(d,l,n));var f=function(e,t){for(var r=0,i=0,a=0,s=A(e,["moof","traf"]),n=0;n<s.length;n++){var o=s[n],l=A(o,["tfhd"])[0],h=t[L(l,4)];if(h){var d=h.default,c=L(l,0)|(null==d?void 0:d.flags),f=null==d?void 0:d.duration;8&c&&(f=L(l,2&c?12:8));for(var g=h.timescale||9e4,v=A(o,["trun"]),m=0;m<v.length;m++)r=f?f*L(v[m],4):D(v[m]),h.type===u.VIDEO?i+=r/g:h.type===u.AUDIO&&(a+=r/g)}}if(0===i&&0===a){var p=R(e);if(null!=p&&p.references)return p.references.reduce(((e,t)=>e+t.info.duration||0),0)}return i||a}(l,d),g=n,v=f+g;!function(e,t,r){A(t,["moof","traf"]).forEach((function(t){A(t,["tfhd"]).forEach((function(i){var a=L(i,4),s=e[a];if(s){var n=s.timescale||9e4;A(t,["tfdt"]).forEach((function(e){var t=e.data[e.start],i=L(e,4);if(0===t)b(e,4,i-r*n);else{i*=Math.pow(2,32),i+=L(e,8),i-=r*n,i=Math.max(i,0);var a=Math.floor(i/(y+1)),s=Math.floor(i%(y+1));b(e,4,a),b(e,8,s)}}))}}))}))}(d,l,s),f>0?this.lastEndDTS=v:(c.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());var m=!!d.audio,p=!!d.video,T="";m&&(T+="audio"),p&&(T+="video");var E={data1:l,startPTS:g,startDTS:g,endPTS:v,endDTS:v,type:T,hasAudio:m,hasVideo:p,nb:1,dropped:0};return o.audio="audio"===E.type?E:void 0,o.video="audio"!==E.type?E:void 0,o.text=i,o.id3=r,o.initSegment=h,o}}var fr,gr=(e,t,r)=>function(e,t){return A(t,["moof","traf"]).reduce(((t,r)=>{var i=A(r,["tfdt"])[0],a=i.data[i.start],s=A(r,["tfhd"]).reduce(((t,r)=>{var s=L(r,4),n=e[s];if(n){var o=L(i,4);1===a&&(o*=Math.pow(2,32),o+=L(i,8));var l=o/(n.timescale||9e4);if(isFinite(l)&&(null===t||l<t))return l}return t}),null);return null!==s&&isFinite(s)&&(null===t||s<t)?s:t}),null)||0}(e,t)-r;function vr(e,t){var r=null==e?void 0:e.codec;return r&&r.length>4?r:"hvc1"===r?"hvc1.1.c.L120.90":"av01"===r?"av01.0.04M.08":"avc1"===r||t===u.VIDEO?"avc1.42e01e":"mp4a.40.5"}class mr{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){var e,{chunks:t,dataLength:r}=this;return t.length?(e=1===t.length?t[0]:function(e,t){for(var r=new Uint8Array(t),i=0,a=0;a<e.length;a++){var s=e[a];r.set(s,i),i+=s.length}return r}(t,r),this.reset(),e):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}}try{fr=self.performance.now.bind(self.performance)}catch(e){c.debug("Unable to use Performance API on this environment"),fr=self.Date.now}var pr=[{demux:Wt,remux:lr},{demux:wt,remux:cr},{demux:It,remux:lr},{demux:Jt,remux:lr}],Tr=1024;pr.forEach((e=>{var{demux:t}=e;Tr=Math.max(Tr,t.minProbeByteLength)}));class yr{constructor(e,t,r,i,a){this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.cache=new mr,this.observer=e,this.typeSupported=t,this.config=r,this.vendor=i,this.id=a}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,r,i){var a=r.transmuxing;a.executeStart=fr();var s=new Uint8Array(e),{cache:n,config:o,currentTransmuxState:l,transmuxConfig:h}=this;i&&(this.currentTransmuxState=i);var d=function(e,t){var r=null;e.byteLength>0&&null!=t&&null!=t.key&&null!==t.iv&&null!=t.method&&(r=t);return r}(s,t);if(d&&"AES-128"===d.method){var u=this.getDecrypter();if(!o.enableSoftwareAES)return this.decryptionPromise=u.webCryptoDecrypt(s,d.key.buffer,d.iv.buffer).then((e=>{var t=this.push(e,null,r);return this.decryptionPromise=null,t})),this.decryptionPromise;var c=u.softwareDecrypt(s,d.key.buffer,d.iv.buffer);if(!c)return a.executeEnd=fr(),Er(r);s=new Uint8Array(c)}var{contiguous:f,discontinuity:g,trackSwitch:v,accurateTimeOffset:m,timeOffset:p}=i||l,{audioCodec:T,videoCodec:y,defaultInitPts:E,duration:S,initSegmentData:L}=h;if((g||v)&&this.resetInitSegment(L,T,y,S),g&&this.resetInitialTimestamp(E),f||this.resetContiguity(),this.needsProbing(s,g,v)){if(n.dataLength)s=k(n.flush(),s);this.configureTransmuxer(s,h)}var b=this.transmux(s,d,p,m,r),A=this.currentTransmuxState;return A.contiguous=!0,A.discontinuity=!1,A.trackSwitch=!1,a.executeEnd=fr(),b}flush(e){var t=e.transmuxing;t.executeStart=fr();var{decrypter:s,cache:n,currentTransmuxState:o,decryptionPromise:l}=this;if(l)return l.then((()=>this.flush(e)));var h=[],{timeOffset:d}=o;if(s){var u=s.flush();u&&h.push(this.push(u,null,e))}var c=n.dataLength;n.reset();var{demuxer:f,remuxer:g}=this;if(!f||!g)return c>=Tr&&this.observer.emit(r.ERROR,r.ERROR,{type:i.MEDIA_ERROR,details:a.FRAG_PARSING_ERROR,fatal:!0,reason:"no demux matching with content found"}),t.executeEnd=fr(),[Er(e)];var v=f.flush(d);return Sr(v)?v.then((t=>(this.flushRemux(h,t,e),h))):(this.flushRemux(h,v,e),h)}flushRemux(e,t,r){var{audioTrack:i,avcTrack:a,id3Track:s,textTrack:n}=t,{accurateTimeOffset:o,timeOffset:l}=this.currentTransmuxState;c.log("[transmuxer.ts]: Flushed fragment "+r.sn+(r.part>-1?" p: "+r.part:"")+" of level "+r.level);var h=this.remuxer.remux(i,a,s,n,l,o,!0,this.id);e.push({remuxResult:h,chunkMeta:r}),r.transmuxing.executeEnd=fr()}resetInitialTimestamp(e){var{demuxer:t,remuxer:r}=this;t&&r&&(t.resetTimeStamp(e),r.resetTimeStamp(e))}resetContiguity(){var{demuxer:e,remuxer:t}=this;e&&t&&(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,r,i){var{demuxer:a,remuxer:s}=this;a&&s&&(a.resetInitSegment(t,r,i),s.resetInitSegment(e,t,r))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,r,i,a){return t&&"SAMPLE-AES"===t.method?this.transmuxSampleAes(e,t,r,i,a):this.transmuxUnencrypted(e,r,i,a)}transmuxUnencrypted(e,t,r,i){var{audioTrack:a,avcTrack:s,id3Track:n,textTrack:o}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(a,s,n,o,t,r,!1,this.id),chunkMeta:i}}transmuxSampleAes(e,t,r,i,a){return this.demuxer.demuxSampleAes(e,t,r).then((e=>({remuxResult:this.remuxer.remux(e.audioTrack,e.avcTrack,e.id3Track,e.textTrack,r,i,!1,this.id),chunkMeta:a})))}configureTransmuxer(e,t){for(var r,{config:i,observer:a,typeSupported:s,vendor:n}=this,{audioCodec:o,defaultInitPts:l,duration:h,initSegmentData:d,videoCodec:u}=t,f=0,g=pr.length;f<g;f++)if(pr[f].demux.probe(e)){r=pr[f];break}r||(c.warn("Failed to find demuxer by probing frag, treating as mp4 passthrough"),r={demux:wt,remux:cr});var v=this.demuxer,m=this.remuxer,p=r.remux,T=r.demux;m&&m instanceof p||(this.remuxer=new p(a,i,s,n)),v&&v instanceof T||(this.demuxer=new T(a,i,s),this.probe=T.probe),this.resetInitSegment(d,o,u,h),this.resetInitialTimestamp(l)}needsProbing(e,t,r){return!this.demuxer||!this.remuxer||t||r}getDecrypter(){var e=this.decrypter;return e||(e=this.decrypter=new rt(this.observer,this.config)),e}}var Er=e=>({remuxResult:{},chunkMeta:e});function Sr(e){return"then"in e&&e.then instanceof Function}class Lr{constructor(e,t,r,i,a){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=r,this.duration=i,this.defaultInitPts=a}}class br{constructor(e,t,r,i,a){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=r,this.trackSwitch=i,this.timeOffset=a}}var Ar=t((function(e){var t=Object.prototype.hasOwnProperty,r="~";function i(){}function a(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function s(e,t,i,s,n){if("function"!=typeof i)throw new TypeError("The listener must be a function");var o=new a(i,s||e,n),l=r?r+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function n(e,t){0==--e._eventsCount?e._events=new i:delete e._events[t]}function o(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(r=!1)),o.prototype.eventNames=function(){var e,i,a=[];if(0===this._eventsCount)return a;for(i in e=this._events)t.call(e,i)&&a.push(r?i.slice(1):i);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(e)):a},o.prototype.listeners=function(e){var t=r?r+e:e,i=this._events[t];if(!i)return[];if(i.fn)return[i.fn];for(var a=0,s=i.length,n=new Array(s);a<s;a++)n[a]=i[a].fn;return n},o.prototype.listenerCount=function(e){var t=r?r+e:e,i=this._events[t];return i?i.fn?1:i.length:0},o.prototype.emit=function(e,t,i,a,s,n){var o=r?r+e:e;if(!this._events[o])return!1;var l,h,d=this._events[o],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,i),!0;case 4:return d.fn.call(d.context,t,i,a),!0;case 5:return d.fn.call(d.context,t,i,a,s),!0;case 6:return d.fn.call(d.context,t,i,a,s,n),!0}for(h=1,l=new Array(u-1);h<u;h++)l[h-1]=arguments[h];d.fn.apply(d.context,l)}else{var c,f=d.length;for(h=0;h<f;h++)switch(d[h].once&&this.removeListener(e,d[h].fn,void 0,!0),u){case 1:d[h].fn.call(d[h].context);break;case 2:d[h].fn.call(d[h].context,t);break;case 3:d[h].fn.call(d[h].context,t,i);break;case 4:d[h].fn.call(d[h].context,t,i,a);break;default:if(!l)for(c=1,l=new Array(u-1);c<u;c++)l[c-1]=arguments[c];d[h].fn.apply(d[h].context,l)}}return!0},o.prototype.on=function(e,t,r){return s(this,e,t,r,!1)},o.prototype.once=function(e,t,r){return s(this,e,t,r,!0)},o.prototype.removeListener=function(e,t,i,a){var s=r?r+e:e;if(!this._events[s])return this;if(!t)return n(this,s),this;var o=this._events[s];if(o.fn)o.fn!==t||a&&!o.once||i&&o.context!==i||n(this,s);else{for(var l=0,h=[],d=o.length;l<d;l++)(o[l].fn!==t||a&&!o[l].once||i&&o[l].context!==i)&&h.push(o[l]);h.length?this._events[s]=1===h.length?h[0]:h:n(this,s)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&n(this,t)):(this._events=new i,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,e.exports=o})),Rr=mt()||{isTypeSupported:()=>!1};class Dr{constructor(e,t,s,n){this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.worker=void 0,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.hls=e,this.id=t,this.onTransmuxComplete=s,this.onFlush=n;var o=e.config,l=(t,r)=>{(r=r||{}).frag=this.frag,r.id=this.id,e.trigger(t,r)};this.observer=new Ar.EventEmitter,this.observer.on(r.FRAG_DECRYPTED,l),this.observer.on(r.ERROR,l);var h={mp4:Rr.isTypeSupported("video/mp4"),mpeg:Rr.isTypeSupported("audio/mpeg"),mp3:Rr.isTypeSupported('audio/mp4; codecs="mp3"')},d=navigator.vendor;if(o.enableWorker&&"undefined"!=typeof Worker){var u;c.log("demuxing in webworker");try{u=this.worker=yt(require.resolve("../demux/transmuxer-worker.ts")),this.onwmsg=this.onWorkerMessage.bind(this),u.addEventListener("message",this.onwmsg),u.onerror=t=>{e.trigger(r.ERROR,{type:i.OTHER_ERROR,details:a.INTERNAL_EXCEPTION,fatal:!0,event:"demuxerWorker",error:new Error(t.message+"  ("+t.filename+":"+t.lineno+")")})},u.postMessage({cmd:"init",typeSupported:h,vendor:d,id:t,config:JSON.stringify(o)})}catch(e){c.warn("Error in worker:",e),c.error("Error while initializing DemuxerWorker, fallback to inline"),u&&self.URL.revokeObjectURL(u.objectURL),this.transmuxer=new yr(this.observer,h,o,d,t),this.worker=null}}else this.transmuxer=new yr(this.observer,h,o,d,t)}destroy(){var e=this.worker;if(e)e.removeEventListener("message",this.onwmsg),e.terminate(),this.worker=null;else{var t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}var r=this.observer;r&&r.removeAllListeners(),this.observer=null}push(e,t,r,i,a,s,n,o,l,h){l.transmuxing.start=self.performance.now();var{transmuxer:d,worker:u}=this,f=s?s.start:a.start,g=a.decryptdata,v=this.frag,m=!(v&&a.cc===v.cc),p=!(v&&l.level===v.level),T=v?l.sn-v.sn:-1,y=this.part?l.part-this.part.index:1,E=!p&&(1===T||0===T&&1===y),S=self.performance.now();(p||T||0===a.stats.parsing.start)&&(a.stats.parsing.start=S),!s||!y&&E||(s.stats.parsing.start=S);var L=new br(m,E,o,p,f);if(!E||m){c.log("[transmuxer-interface, "+a.type+"]: Starting new transmux session for sn: "+l.sn+" p: "+l.part+" level: "+l.level+" id: "+l.id+"\n        discontinuity: "+m+"\n        trackSwitch: "+p+"\n        contiguous: "+E+"\n        accurateTimeOffset: "+o+"\n        timeOffset: "+f);var b=new Lr(r,i,t,n,h);this.configureTransmuxer(b)}if(this.frag=a,this.part=s,u)u.postMessage({cmd:"demux",data:e,decryptdata:g,chunkMeta:l,state:L},e instanceof ArrayBuffer?[e]:[]);else if(d){var A=d.push(e,g,l,L);Sr(A)?A.then((e=>{this.handleTransmuxComplete(e)})):this.handleTransmuxComplete(A)}}flush(e){e.transmuxing.start=self.performance.now();var{transmuxer:t,worker:r}=this;if(r)r.postMessage({cmd:"flush",chunkMeta:e});else if(t){var i=t.flush(e);Sr(i)?i.then((t=>{this.handleFlushResult(t,e)})):this.handleFlushResult(i,e)}}handleFlushResult(e,t){e.forEach((e=>{this.handleTransmuxComplete(e)})),this.onFlush(t)}onWorkerMessage(e){var t=e.data,r=this.hls;switch(t.event){case"init":self.URL.revokeObjectURL(this.worker.objectURL);break;case"transmuxComplete":this.handleTransmuxComplete(t.data);break;case"flush":this.onFlush(t.data);break;default:t.data=t.data||{},t.data.frag=this.frag,t.data.id=this.id,r.trigger(t.event,t.data)}}configureTransmuxer(e){var{worker:t,transmuxer:r}=this;t?t.postMessage({cmd:"configure",config:e}):r&&r.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}class kr{constructor(e,t,r,i){this.config=void 0,this.media=void 0,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=e,this.media=t,this.fragmentTracker=r,this.hls=i}destroy(){this.hls=this.fragmentTracker=this.media=null}poll(e){var{config:t,media:r,stalled:i}=this,{currentTime:a,seeking:s}=r,n=this.seeking&&!s,o=!this.seeking&&s;if(this.seeking=s,a===e){if((o||n)&&(this.stalled=null),!r.paused&&!r.ended&&0!==r.playbackRate&&Ue.getBuffered(r).length){var l=Ue.bufferInfo(r,a,0),h=l.len>0,d=l.nextStart||0;if(h||d){if(s){var u=l.len>2,f=!d||d-a>2&&!this.fragmentTracker.getPartialFragment(a);if(u||f)return;this.moved=!1}if(!this.moved&&null!==this.stalled){var g,v=Math.max(d,l.start||0)-a,m=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,p=(null==m||null===(g=m.details)||void 0===g?void 0:g.live)?2*m.details.targetduration:2;if(v>0&&v<=p)return void this._trySkipBufferHole(null)}var T=self.performance.now();if(null!==i){var y=T-i;!s&&y>=250&&this._reportStall(l.len);var E=Ue.bufferInfo(r,a,t.maxBufferHole);this._tryFixBufferStall(E,y)}else this.stalled=T}}}else if(this.moved=!0,null!==i){if(this.stallReported){var S=self.performance.now()-i;c.warn("playback not stuck anymore @"+a+", after "+Math.round(S)+"ms"),this.stallReported=!1}this.stalled=null,this.nudgeRetry=0}}_tryFixBufferStall(e,t){var{config:r,fragmentTracker:i,media:a}=this,s=a.currentTime,n=i.getPartialFragment(s);if(n&&this._trySkipBufferHole(n))return;e.len>r.maxBufferHole&&t>1e3*r.highBufferWatchdogPeriod&&(c.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(e){var{hls:t,media:s,stallReported:n}=this;n||(this.stallReported=!0,c.warn("Playback stalling at @"+s.currentTime+" due to low buffer (buffer="+e+")"),t.trigger(r.ERROR,{type:i.MEDIA_ERROR,details:a.BUFFER_STALLED_ERROR,fatal:!1,buffer:e}))}_trySkipBufferHole(e){for(var{config:t,hls:s,media:n}=this,o=n.currentTime,l=0,h=Ue.getBuffered(n),d=0;d<h.length;d++){var u=h.start(d);if(o+t.maxBufferHole>=l&&o<u){var f=Math.max(u+.05,n.currentTime+.1);return c.warn("skipping hole, adjusting currentTime from "+o+" to "+f),this.moved=!0,this.stalled=null,n.currentTime=f,e&&s.trigger(r.ERROR,{type:i.MEDIA_ERROR,details:a.BUFFER_SEEK_OVER_HOLE,fatal:!1,reason:"fragment loaded with buffer holes, seeking from "+o+" to "+f,frag:e}),f}l=h.end(d)}return 0}_tryNudgeBuffer(){var{config:e,hls:t,media:s}=this,n=s.currentTime,o=(this.nudgeRetry||0)+1;if(this.nudgeRetry=o,o<e.nudgeMaxRetry){var l=n+o*e.nudgeOffset;c.warn("Nudging 'currentTime' from "+n+" to "+l),s.currentTime=l,t.trigger(r.ERROR,{type:i.MEDIA_ERROR,details:a.BUFFER_NUDGE_ON_STALL,fatal:!1})}else c.error("Playhead still not moving while enough data buffered @"+n+" after "+e.nudgeMaxRetry+" nudges"),t.trigger(r.ERROR,{type:i.MEDIA_ERROR,details:a.BUFFER_STALLED_ERROR,fatal:!0})}}class Cr extends vt{constructor(e,t){super(e,t,"[stream-controller]"),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.stalled=!1,this.couldBacktrack=!1,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){var{hls:e}=this;e.on(r.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(r.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(r.MANIFEST_LOADING,this.onManifestLoading,this),e.on(r.MANIFEST_PARSED,this.onManifestParsed,this),e.on(r.LEVEL_LOADING,this.onLevelLoading,this),e.on(r.LEVEL_LOADED,this.onLevelLoaded,this),e.on(r.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(r.ERROR,this.onError,this),e.on(r.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(r.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(r.BUFFER_CREATED,this.onBufferCreated,this),e.on(r.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(r.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(r.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){var{hls:e}=this;e.off(r.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(r.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(r.MANIFEST_LOADING,this.onManifestLoading,this),e.off(r.MANIFEST_PARSED,this.onManifestParsed,this),e.off(r.LEVEL_LOADED,this.onLevelLoaded,this),e.off(r.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(r.ERROR,this.onError,this),e.off(r.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(r.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(r.BUFFER_CREATED,this.onBufferCreated,this),e.off(r.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(r.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(r.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),this.onMediaDetaching()}startLoad(e){if(this.levels){var{lastCurrentTime:t,hls:r}=this;if(this.stopLoad(),this.setInterval(100),this.level=-1,this.fragLoadError=0,!this.startFragRequested){var i=r.startLevel;-1===i&&(r.config.testBandwidth?(i=0,this.bitrateTest=!0):i=r.nextAutoLevel),this.level=r.nextLoadLevel=i,this.loadedmetadata=!1}t>0&&-1===e&&(this.log("Override startPosition with lastCurrentTime @"+t.toFixed(3)),e=t),this.state=st,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=at}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case st:this.doTickIdle();break;case gt:var e,{levels:t,level:r}=this,i=null==t||null===(e=t[r])||void 0===e?void 0:e.details;if(i&&(!i.live||this.levelLastLoaded===this.level)){if(this.waitForCdnTuneIn(i))break;this.state=st;break}break;case lt:var a,s=self.performance.now(),n=this.retryDate;(!n||s>=n||null!==(a=this.media)&&void 0!==a&&a.seeking)&&(this.log("retryDate reached, switch back to IDLE state"),this.state=st)}this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){var e,t,{hls:i,levelLastLoaded:a,levels:s,media:n}=this,{config:o,nextLoadLevel:l}=i;if(null!==a&&(n||!this.startFragRequested&&o.startFragPrefetch)&&(!this.altAudio||!this.audioOnly)&&s&&s[l]){var h=s[l];this.level=i.nextLoadLevel=l;var d=h.details;if(!d||this.state===gt||d.live&&this.levelLastLoaded!==l)this.state=gt;else{var c=this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:n,F.MAIN);if(null!==c)if(!(c.len>=this.getMaxBufferLength(h.maxBitrate))){if(this._streamEnded(c,d)){var f={};return this.altAudio&&(f.type="video"),this.hls.trigger(r.BUFFER_EOS,f),void(this.state=ct)}var g=c.end,v=this.getNextFragment(g,d);if(this.couldBacktrack&&!this.fragPrevious&&v&&"initSegment"!==v.sn){var m=v.sn-d.startSN;m>1&&(v=d.fragments[m-1],this.fragmentTracker.removeFragment(v))}if(v&&this.fragmentTracker.getState(v)===we.OK&&this.nextLoadPosition>g){var p=this.audioOnly&&!this.altAudio?u.AUDIO:u.VIDEO;this.afterBufferFlushed(n,p,F.MAIN),v=this.getNextFragment(this.nextLoadPosition,d)}v&&(!v.initSegment||v.initSegment.data||this.bitrateTest||(v=v.initSegment),"identity"!==(null===(e=v.decryptdata)||void 0===e?void 0:e.keyFormat)||null!==(t=v.decryptdata)&&void 0!==t&&t.key?this.loadFragment(v,d,g):this.loadKey(v,d))}}}}loadFragment(e,t,r){var i,a=this.fragmentTracker.getState(e);if(this.fragCurrent=e,a===we.BACKTRACKED){var s=this.fragmentTracker.getBacktrackData(e);if(s)return this._handleFragmentLoadProgress(s),void this._handleFragmentLoadComplete(s);a=we.NOT_LOADED}a===we.NOT_LOADED||a===we.PARTIAL?"initSegment"===e.sn?this._loadInitSegment(e):this.bitrateTest?(e.bitrateTest=!0,this.log("Fragment "+e.sn+" of level "+e.level+" is being downloaded to test bitrate and will not be buffered"),this._loadBitrateTestFrag(e)):(this.startFragRequested=!0,super.loadFragment(e,t,r)):a===we.APPENDING?this.reduceMaxBufferLength(e.duration)&&this.fragmentTracker.removeFragment(e):0===(null===(i=this.media)||void 0===i?void 0:i.buffered.length)&&this.fragmentTracker.removeAllFragments()}getAppendedFrag(e){var t=this.fragmentTracker.getAppendedFrag(e,F.MAIN);return t&&"fragment"in t?t.fragment:t}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,F.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){var{levels:e,media:t}=this;if(null!=t&&t.readyState){var r,i=this.getAppendedFrag(t.currentTime);if(i&&i.start>1&&this.flushMainBuffer(0,i.start-1),!t.paused&&e){var a=e[this.hls.nextLoadLevel],s=this.fragLastKbps;r=s&&this.fragCurrent?this.fragCurrent.duration*a.maxBitrate/(1e3*s)+1:0}else r=0;var n=this.getBufferedFrag(t.currentTime+r);if(n){var o=this.followingBufferedFrag(n);if(o){this.abortCurrentFrag();var l=o.maxStartPTS?o.maxStartPTS:o.start,h=o.duration,d=Math.max(n.end,l+Math.min(Math.max(h-this.config.maxFragLookUpTolerance,.5*h),.75*h));this.flushMainBuffer(d,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){var e=this.fragCurrent;this.fragCurrent=null,null!=e&&e.loader&&e.loader.abort(),this.state===nt&&(this.state=st),this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);var r=t.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),r.addEventListener("playing",this.onvplaying),r.addEventListener("seeked",this.onvseeked),this.gapController=new kr(this.config,r,this.fragmentTracker,this.hls)}onMediaDetaching(){var{media:e}=this;e&&(e.removeEventListener("playing",this.onvplaying),e.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){var e=this.media,t=e?e.currentTime:null;Number.isFinite(t)&&this.log("Media seeked to "+t.toFixed(3)),this.tick()}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(r.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=this.stalled=!1,this.startPosition=this.lastCurrentTime=0,this.fragPlaying=null}onManifestParsed(e,t){var r,i,a,s=!1,n=!1;t.levels.forEach((e=>{(r=e.audioCodec)&&(-1!==r.indexOf("mp4a.40.2")&&(s=!0),-1!==r.indexOf("mp4a.40.5")&&(n=!0))})),this.audioCodecSwitch=s&&n&&!("function"==typeof(null==(a=pt())||null===(i=a.prototype)||void 0===i?void 0:i.changeType)),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){var{levels:r}=this;if(r&&this.state===st){var i=r[t.level];(!i.details||i.details.live&&this.levelLastLoaded!==t.level||this.waitForCdnTuneIn(i.details))&&(this.state=gt)}}onLevelLoaded(e,t){var i,{levels:a}=this,s=t.level,n=t.details,o=n.totalduration;if(a){this.log("Level "+s+" loaded ["+n.startSN+","+n.endSN+"], cc ["+n.startCC+", "+n.endCC+"] duration:"+o);var l=this.fragCurrent;!l||this.state!==ot&&this.state!==lt||l.level!==t.level&&l.loader&&(this.state=st,l.loader.abort());var h=a[s],d=0;if(n.live||null!==(i=h.details)&&void 0!==i&&i.live){if(n.fragments[0]||(n.deltaUpdateFailed=!0),n.deltaUpdateFailed)return;d=this.alignPlaylists(n,h.details)}if(h.details=n,this.levelLastLoaded=s,this.hls.trigger(r.LEVEL_UPDATED,{details:n,level:s}),this.state===gt){if(this.waitForCdnTuneIn(n))return;this.state=st}this.startFragRequested?n.live&&this.synchronizeToLiveEdge(n):this.setStartPosition(n,d),this.tick()}else this.warn("Levels were reset while loading level "+s)}_handleFragmentLoadProgress(e){var t,{frag:r,part:i,payload:a}=e,{levels:s}=this;if(s){var n=s[r.level],o=n.details;if(o){var l=n.videoCodec,h=o.PTSKnown||!o.live,d=null===(t=r.initSegment)||void 0===t?void 0:t.data,u=this._getAudioCodec(n),c=this.transmuxer=this.transmuxer||new Dr(this.hls,F.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),f=i?i.index:-1,g=-1!==f,v=new Be(r.level,r.sn,r.stats.chunkCount,a.byteLength,f,g),m=this.initPTS[r.cc];c.push(a,d,u,l,r,i,o.totalduration,h,v,m)}else this.warn("Dropping fragment "+r.sn+" of level "+r.level+" after level details were reset")}else this.warn("Levels were reset while fragment load was in progress. Fragment "+r.sn+" of level "+r.level+" will not be buffered")}onAudioTrackSwitching(e,t){var i=this.altAudio,a=!!t.url,s=t.id;if(!a){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;var n=this.fragCurrent;null!=n&&n.loader&&(this.log("Switching to main audio track, cancel main fragment load"),n.loader.abort()),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();var o=this.hls;i&&o.trigger(r.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:"audio"}),o.trigger(r.AUDIO_TRACK_SWITCHED,{id:s})}}onAudioTrackSwitched(e,t){var r=t.id,i=!!this.hls.audioTracks[r].url;if(i){var a=this.videoBuffer;a&&this.mediaBuffer!==a&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=a)}this.altAudio=i,this.tick()}onBufferCreated(e,t){var r,i,a=t.tracks,s=!1;for(var n in a){var o=a[n];if("main"===o.id){if(i=n,r=o,"video"===n){var l=a[n];l&&(this.videoBuffer=l.buffer)}}else s=!0}s&&r?(this.log("Alternate track found, use "+i+".buffered to schedule main fragment loading"),this.mediaBuffer=r.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){var{frag:r,part:i}=t;if(!r||r.type===F.MAIN){if(this.fragContextChanged(r))return this.warn("Fragment "+r.sn+(i?" p: "+i.index:"")+" of level "+r.level+" finished buffering, but was aborted. state: "+this.state),void(this.state===dt&&(this.state=st));var a=i?i.stats:r.stats;this.fragLastKbps=Math.round(8*a.total/(a.buffering.end-a.loading.first)),"initSegment"!==r.sn&&(this.fragPrevious=r),this.fragBufferedComplete(r,i)}}onError(e,t){switch(t.details){case a.FRAG_LOAD_ERROR:case a.FRAG_LOAD_TIMEOUT:case a.KEY_LOAD_ERROR:case a.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(F.MAIN,t);break;case a.LEVEL_LOAD_ERROR:case a.LEVEL_LOAD_TIMEOUT:this.state!==ft&&(t.fatal?(this.warn(""+t.details),this.state=ft):t.levelRetry||this.state!==gt||(this.state=st));break;case a.BUFFER_FULL_ERROR:if("main"===t.parent&&(this.state===ht||this.state===dt)){var r=!0,i=this.getFwdBufferInfo(this.media,F.MAIN);i&&i.len>.5&&(r=!this.reduceMaxBufferLength(i.len)),r&&(this.warn("buffer full error also media.currentTime is not buffered, flush main"),this.immediateLevelSwitch()),this.resetLoadingState()}}}checkBuffer(){var{media:e,gapController:t}=this;if(e&&t&&e.readyState){var r=Ue.getBuffered(e);!this.loadedmetadata&&r.length?(this.loadedmetadata=!0,this.seekToStartPos()):t.poll(this.lastCurrentTime),this.lastCurrentTime=e.currentTime}}onFragLoadEmergencyAborted(){this.state=st,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(e,t){var{type:r}=t;if(r!==u.AUDIO||this.audioOnly&&!this.altAudio){var i=(r===u.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(i,r,F.MAIN)}}onLevelsUpdated(e,t){this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){var{media:e}=this,t=e.currentTime,r=this.startPosition;if(r>=0&&t<r){if(e.seeking)return void c.log("could not seek to "+r+", already seeking at "+t);var i=Ue.getBuffered(e),a=(i.length?i.start(0):0)-r;a>0&&(a<this.config.maxBufferHole||a<this.config.maxFragLookUpTolerance)&&(c.log("adjusting start position by "+a+" to match buffer start"),r+=a,this.startPosition=r),this.log("seek to target start position "+r+" from current time "+t),e.currentTime=r}}_getAudioCodec(e){var t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),t}_loadBitrateTestFrag(e){this._doFragLoad(e).then((t=>{var{hls:i}=this;if(t&&!i.nextLoadLevel&&!this.fragContextChanged(e)){this.fragLoadError=0,this.state=st,this.startFragRequested=!1,this.bitrateTest=!1;var a=e.stats;a.parsing.start=a.parsing.end=a.buffering.start=a.buffering.end=self.performance.now(),i.trigger(r.FRAG_LOADED,t)}}))}_handleTransmuxComplete(e){var t,i="main",{hls:a}=this,{remuxResult:s,chunkMeta:n}=e,o=this.getCurrentContext(n);if(!o)return this.warn("The loading context changed while buffering fragment "+n.sn+" of level "+n.level+". This chunk will not be buffered."),void this.resetLiveStartWhenNotLoaded(n.level);var{frag:l,part:h,level:d}=o,{video:c,text:f,id3:g,initSegment:v}=s,m=this.altAudio?void 0:s.audio;if(!this.fragContextChanged(l)){if(this.state=ht,v){v.tracks&&(this._bufferInitSegment(d,v.tracks,l,n),a.trigger(r.FRAG_PARSING_INIT_SEGMENT,{frag:l,id:i,tracks:v.tracks}));var p=v.initPTS,T=v.timescale;Number.isFinite(p)&&(this.initPTS[l.cc]=p,a.trigger(r.INIT_PTS_FOUND,{frag:l,id:i,initPTS:p,timescale:T}))}if(c&&!1!==s.independent){if(d.details){var{startPTS:y,endPTS:E,startDTS:S,endDTS:L}=c;if(h)h.elementaryStreams[c.type]={startPTS:y,endPTS:E,startDTS:S,endDTS:L};else if(c.firstKeyFrame&&c.independent&&(this.couldBacktrack=!0),c.dropped&&c.independent){if(this.getLoadPosition()+this.config.maxBufferHole<y)return void this.backtrack(l);l.setElementaryStreamInfo(c.type,l.start,E,l.start,L,!0)}l.setElementaryStreamInfo(c.type,y,E,S,L),this.bufferFragmentData(c,l,h,n)}}else if(!1===s.independent)return void this.backtrack(l);if(m){var{startPTS:b,endPTS:A,startDTS:R,endDTS:D}=m;h&&(h.elementaryStreams[u.AUDIO]={startPTS:b,endPTS:A,startDTS:R,endDTS:D}),l.setElementaryStreamInfo(u.AUDIO,b,A,R,D),this.bufferFragmentData(m,l,h,n)}if(null!=g&&null!==(t=g.samples)&&void 0!==t&&t.length){var k={frag:l,id:i,samples:g.samples};a.trigger(r.FRAG_PARSING_METADATA,k)}if(f){var C={frag:l,id:i,samples:f.samples};a.trigger(r.FRAG_PARSING_USERDATA,C)}}}_bufferInitSegment(e,t,i,a){if(this.state===ht){this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&delete t.audio;var{audio:s,video:n,audiovideo:o}=t;if(s){var l=e.audioCodec,h=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(l&&(l=-1!==l.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),1!==s.metadata.channelCount&&-1===h.indexOf("firefox")&&(l="mp4a.40.5")),-1!==h.indexOf("android")&&"audio/mpeg"!==s.container&&(l="mp4a.40.2",this.log("Android: force audio codec to "+l)),e.audioCodec&&e.audioCodec!==l&&this.log('Swapping manifest audio codec "'+e.audioCodec+'" for "'+l+'"'),s.levelCodec=l,s.id="main",this.log("Init audio buffer, container:"+s.container+", codecs[selected/level/parsed]=["+(l||"")+"/"+(e.audioCodec||"")+"/"+s.codec+"]")}n&&(n.levelCodec=e.videoCodec,n.id="main",this.log("Init video buffer, container:"+n.container+", codecs[level/parsed]=["+(e.videoCodec||"")+"/"+n.codec+"]")),o&&this.log("Init audiovideo buffer, container:"+o.container+", codecs[level/parsed]=["+(e.attrs.CODECS||"")+"/"+o.codec+"]"),this.hls.trigger(r.BUFFER_CODECS,t),Object.keys(t).forEach((e=>{var s=t[e].initSegment;null!=s&&s.byteLength&&this.hls.trigger(r.BUFFER_APPENDING,{type:e,data:s,frag:i,part:null,chunkMeta:a,parent:i.type})})),this.tick()}}backtrack(e){this.couldBacktrack=!0,this.resetTransmuxer(),this.flushBufferGap(e);var t=this.fragmentTracker.backtrack(e);this.fragPrevious=null,this.nextLoadPosition=e.start,t?this.resetFragmentLoading(e):this.state=ut}checkFragmentChanged(){var e=this.media,t=null;if(e&&e.readyState>1&&!1===e.seeking){var i=e.currentTime;if(Ue.isBuffered(e,i)?t=this.getAppendedFrag(i):Ue.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){var a=this.fragPlaying,s=t.level;a&&t.sn===a.sn&&a.level===s&&t.urlId===a.urlId||(this.hls.trigger(r.FRAG_CHANGED,{frag:t}),a&&a.level===s||this.hls.trigger(r.LEVEL_SWITCHED,{level:s}),this.fragPlaying=t)}}}get nextLevel(){var e=this.nextBufferedFrag;return e?e.level:-1}get currentLevel(){var e=this.media;if(e){var t=this.getAppendedFrag(e.currentTime);if(t)return t.level}return-1}get nextBufferedFrag(){var e=this.media;if(e){var t=this.getAppendedFrag(e.currentTime);return this.followingBufferedFrag(t)}return null}get forceStartLoad(){return this._forceStartLoad}}class _r{constructor(e,t,r){void 0===t&&(t=0),void 0===r&&(r=0),this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=r}sample(e,t){var r=Math.pow(this.alpha_,e);this.estimate_=t*(1-r)+r*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){var e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class Ir{constructor(e,t,r){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultEstimate_=r,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new _r(e),this.fast_=new _r(t)}update(e,t){var{slow_:r,fast_:i}=this;this.slow_.halfLife!==e&&(this.slow_=new _r(e,r.getEstimate(),r.getTotalWeight())),this.fast_.halfLife!==t&&(this.fast_=new _r(t,i.getEstimate(),i.getTotalWeight()))}sample(e,t){var r=(e=Math.max(e,this.minDelayMs_))/1e3,i=8*t/r;this.fast_.sample(r,i),this.slow_.sample(r,i)}canEstimate(){var e=this.fast_;return e&&e.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}destroy(){}}function wr(e){for(var t=[],r=0;r<e.length;r++){var i=e[r];"subtitles"===i.kind&&i.label&&t.push(e[r])}return t}class xr{constructor(e){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=e}append(e,t){var r=this.queues[t];r.push(e),1===r.length&&this.buffers[t]&&this.executeNext(t)}insertAbort(e,t){this.queues[t].unshift(e),this.executeNext(t)}appendBlocker(e){var t,r=new Promise((e=>{t=e})),i={execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(i,e),r}executeNext(e){var{buffers:t,queues:r}=this,i=t[e],a=r[e];if(a.length){var s=a[0];try{s.execute()}catch(t){c.warn("[buffer-operation-queue]: Unhandled exception executing the current operation"),s.onError(t),i&&i.updating||(a.shift(),this.executeNext(e))}}}shiftAndExecuteNext(e){this.queues[e].shift(),this.executeNext(e)}current(e){return this.queues[e][0]}}var Or=mt(),Pr=/([ha]vc.)(?:\.[^.,]+)+/;var Fr,Mr={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Nr=function(e){var t=e;return Mr.hasOwnProperty(e)&&(t=Mr[e]),String.fromCharCode(t)},Ur={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},Br={17:2,18:4,21:6,22:8,23:10,19:13,20:15},Gr={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},Hr={25:2,26:4,29:6,30:8,31:10,27:13,28:15},Kr=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];!function(e){e[e.ERROR=0]="ERROR",e[e.TEXT=1]="TEXT",e[e.WARNING=2]="WARNING",e[e.INFO=2]="INFO",e[e.DEBUG=3]="DEBUG",e[e.DATA=3]="DATA"}(Fr||(Fr={}));class Vr{constructor(){this.time=null,this.verboseLevel=Fr.ERROR}log(e,t){this.verboseLevel>=e&&c.log(this.time+" ["+e+"] "+t)}}var jr=function(e){for(var t=[],r=0;r<e.length;r++)t.push(e[r].toString(16));return t};class Wr{constructor(e,t,r,i,a){this.foreground=void 0,this.underline=void 0,this.italics=void 0,this.background=void 0,this.flash=void 0,this.foreground=e||"white",this.underline=t||!1,this.italics=r||!1,this.background=i||"black",this.flash=a||!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){for(var t=["foreground","underline","italics","background","flash"],r=0;r<t.length;r++){var i=t[r];e.hasOwnProperty(i)&&(this[i]=e[i])}}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class qr{constructor(e,t,r,i,a,s){this.uchar=void 0,this.penState=void 0,this.uchar=e||" ",this.penState=new Wr(t,r,i,a,s)}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class Xr{constructor(e){this.chars=void 0,this.pos=void 0,this.currPenState=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chars=[];for(var t=0;t<100;t++)this.chars.push(new qr);this.logger=e,this.pos=0,this.currPenState=new Wr}equals(e){for(var t=!0,r=0;r<100;r++)if(!this.chars[r].equals(e.chars[r])){t=!1;break}return t}copy(e){for(var t=0;t<100;t++)this.chars[t].copy(e.chars[t])}isEmpty(){for(var e=!0,t=0;t<100;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(Fr.DEBUG,"Negative cursor position "+this.pos),this.pos=0):this.pos>100&&(this.logger.log(Fr.DEBUG,"Too large cursor position "+this.pos),this.pos=100)}moveCursor(e){var t=this.pos+e;if(e>1)for(var r=this.pos+1;r<t+1;r++)this.chars[r].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();var t=Nr(e);this.pos>=100?this.logger.log(Fr.ERROR,"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!"):(this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1))}clearFromPos(e){var t;for(t=e;t<100;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){for(var e=[],t=!0,r=0;r<100;r++){var i=this.chars[r].uchar;" "!==i&&(t=!1),e.push(i)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class Yr{constructor(e){this.rows=void 0,this.currRow=void 0,this.nrRollUpRows=void 0,this.lastOutputScreen=void 0,this.logger=void 0,this.rows=[];for(var t=0;t<15;t++)this.rows.push(new Xr(e));this.logger=e,this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.reset()}reset(){for(var e=0;e<15;e++)this.rows[e].clear();this.currRow=14}equals(e){for(var t=!0,r=0;r<15;r++)if(!this.rows[r].equals(e.rows[r])){t=!1;break}return t}copy(e){for(var t=0;t<15;t++)this.rows[t].copy(e.rows[t])}isEmpty(){for(var e=!0,t=0;t<15;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(Fr.INFO,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(Fr.INFO,"pacData = "+JSON.stringify(e));var t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(var r=0;r<15;r++)this.rows[r].clear();var i=this.currRow+1-this.nrRollUpRows,a=this.lastOutputScreen;if(a){var s=a.rows[i].cueStartTime,n=this.logger.time;if(s&&null!==n&&s<n)for(var o=0;o<this.nrRollUpRows;o++)this.rows[t-this.nrRollUpRows+o+1].copy(a.rows[i+o])}}this.currRow=t;var l=this.rows[this.currRow];if(null!==e.indent){var h=e.indent,d=Math.max(h-1,0);l.setCursor(e.indent),e.color=l.chars[d].penState.foreground}var u={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(u)}setBkgData(e){this.logger.log(Fr.INFO,"bkgData = "+JSON.stringify(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(null!==this.nrRollUpRows){this.logger.log(Fr.TEXT,this.getDisplayText());var e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(Fr.INFO,"Rolling up")}else this.logger.log(Fr.DEBUG,"roll_up but nrRollUpRows not set yet")}getDisplayText(e){e=e||!1;for(var t=[],r="",i=-1,a=0;a<15;a++){var s=this.rows[a].getTextString();s&&(i=a+1,e?t.push("Row "+i+": '"+s+"'"):t.push(s.trim()))}return t.length>0&&(r=e?"["+t.join(" | ")+"]":t.join("\n")),r}getTextAndFormat(){return this.rows}}class zr{constructor(e,t,r){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Yr(r),this.nonDisplayedMemory=new Yr(r),this.lastOutputScreen=new Yr(r),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=r}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(Fr.INFO,"MODE="+e),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(var t=0;t<e.length;t++)this.writeScreen.insertChar(e[t]);var r=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(Fr.INFO,r+": "+this.writeScreen.getDisplayText(!0)),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(this.logger.log(Fr.TEXT,"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(Fr.INFO,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(Fr.INFO,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(Fr.INFO,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(Fr.INFO,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(Fr.INFO,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(Fr.INFO,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(Fr.INFO,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(Fr.INFO,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(Fr.INFO,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(Fr.INFO,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(Fr.INFO,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(Fr.INFO,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){var e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(Fr.TEXT,"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(Fr.INFO,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){var t={flash:!1};if(t.underline=e%2==1,t.italics=e>=46,t.italics)t.foreground="white";else{var r=Math.floor(e/2)-16;t.foreground=["white","green","blue","cyan","red","yellow","magenta"][r]}this.logger.log(Fr.INFO,"MIDROW: "+JSON.stringify(t)),this.writeScreen.setPen(t)}outputDataUpdate(e){void 0===e&&(e=!1);var t=this.logger.time;null!==t&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t):this.cueStartTime=t,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class Qr{constructor(e,t,r){this.channels=void 0,this.currentChannel=0,this.cmdHistory=void 0,this.logger=void 0;var i=new Vr;this.channels=[null,new zr(e,t,i),new zr(e+1,r,i)],this.cmdHistory={a:null,b:null},this.logger=i}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){var r,i,a,s=!1;this.logger.time=e;for(var n=0;n<t.length;n+=2)if(i=127&t[n],a=127&t[n+1],0!==i||0!==a){if(this.logger.log(Fr.DATA,"["+jr([t[n],t[n+1]])+"] -> ("+jr([i,a])+")"),(r=this.parseCmd(i,a))||(r=this.parseMidrow(i,a)),r||(r=this.parsePAC(i,a)),r||(r=this.parseBackgroundAttributes(i,a)),!r&&(s=this.parseChars(i,a))){var o=this.currentChannel;if(o&&o>0)this.channels[o].insertChars(s);else this.logger.log(Fr.WARNING,"No channel found yet. TEXT-MODE?")}r||s||this.logger.log(Fr.WARNING,"Couldn't parse cleaned data "+jr([i,a])+" orig: "+jr([t[n],t[n+1]]))}}parseCmd(e,t){var{cmdHistory:r}=this;if(!((20===e||28===e||21===e||29===e)&&t>=32&&t<=47)&&!((23===e||31===e)&&t>=33&&t<=35))return!1;if(Zr(e,t,r))return $r(null,null,r),this.logger.log(Fr.DEBUG,"Repeated command ("+jr([e,t])+") is dropped"),!0;var i=20===e||21===e||23===e?1:2,a=this.channels[i];return 20===e||21===e||28===e||29===e?32===t?a.ccRCL():33===t?a.ccBS():34===t?a.ccAOF():35===t?a.ccAON():36===t?a.ccDER():37===t?a.ccRU(2):38===t?a.ccRU(3):39===t?a.ccRU(4):40===t?a.ccFON():41===t?a.ccRDC():42===t?a.ccTR():43===t?a.ccRTD():44===t?a.ccEDM():45===t?a.ccCR():46===t?a.ccENM():47===t&&a.ccEOC():a.ccTO(t-32),$r(e,t,r),this.currentChannel=i,!0}parseMidrow(e,t){var r=0;if((17===e||25===e)&&t>=32&&t<=47){if((r=17===e?1:2)!==this.currentChannel)return this.logger.log(Fr.ERROR,"Mismatch channel in midrow parsing"),!1;var i=this.channels[r];return!!i&&(i.ccMIDROW(t),this.logger.log(Fr.DEBUG,"MIDROW ("+jr([e,t])+")"),!0)}return!1}parsePAC(e,t){var r,i=this.cmdHistory;if(!((e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127)&&!((16===e||24===e)&&t>=64&&t<=95))return!1;if(Zr(e,t,i))return $r(null,null,i),!0;var a=e<=23?1:2;r=t>=64&&t<=95?1===a?Ur[e]:Gr[e]:1===a?Br[e]:Hr[e];var s=this.channels[a];return!!s&&(s.setPAC(this.interpretPAC(r,t)),$r(e,t,i),this.currentChannel=a,!0)}interpretPAC(e,t){var r,i={color:null,italics:!1,indent:null,underline:!1,row:e};return r=t>95?t-96:t-64,i.underline=1==(1&r),r<=13?i.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(r/2)]:r<=15?(i.italics=!0,i.color="white"):i.indent=4*Math.floor((r-16)/2),i}parseChars(e,t){var r,i,a=null,s=null;(e>=25?(r=2,s=e-8):(r=1,s=e),s>=17&&s<=19)?(i=17===s?t+80:18===s?t+112:t+144,this.logger.log(Fr.INFO,"Special char '"+Nr(i)+"' in channel "+r),a=[i]):e>=32&&e<=127&&(a=0===t?[e]:[e,t]);if(a){var n=jr(a);this.logger.log(Fr.DEBUG,"Char codes =  "+n.join(",")),$r(e,t,this.cmdHistory)}return a}parseBackgroundAttributes(e,t){var r;if(!((16===e||24===e)&&t>=32&&t<=47)&&!((23===e||31===e)&&t>=45&&t<=47))return!1;var i={};16===e||24===e?(r=Math.floor((t-32)/2),i.background=Kr[r],t%2==1&&(i.background=i.background+"_semi")):45===t?i.background="transparent":(i.foreground="black",47===t&&(i.underline=!0));var a=e<=23?1:2;return this.channels[a].setBkgData(i),$r(e,t,this.cmdHistory),!0}reset(){for(var e=0;e<Object.keys(this.channels).length;e++){var t=this.channels[e];t&&t.reset()}this.cmdHistory={a:null,b:null}}cueSplitAtTime(e){for(var t=0;t<this.channels.length;t++){var r=this.channels[t];r&&r.cueSplitAtTime(e)}}}function $r(e,t,r){r.a=e,r.b=t}function Zr(e,t,r){return r.a===e&&r.b===t}class Jr{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,r){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=r,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[]}}var ei=function(){if("undefined"!=typeof self&&self.VTTCue)return self.VTTCue;var e=["","lr","rl"],t=["start","middle","end","left","right"];function r(e,t){if("string"!=typeof t)return!1;if(!Array.isArray(e))return!1;var r=t.toLowerCase();return!!~e.indexOf(r)&&r}function i(e){return r(t,e)}function a(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];for(var a=1;a<arguments.length;a++){var s=arguments[a];for(var n in s)e[n]=s[n]}return e}function s(t,s,n){var o=this,l={enumerable:!0};o.hasBeenReset=!1;var h="",d=!1,u=t,c=s,f=n,g=null,v="",m=!0,p="auto",T="start",y=50,E="middle",S=50,L="middle";Object.defineProperty(o,"id",a({},l,{get:function(){return h},set:function(e){h=""+e}})),Object.defineProperty(o,"pauseOnExit",a({},l,{get:function(){return d},set:function(e){d=!!e}})),Object.defineProperty(o,"startTime",a({},l,{get:function(){return u},set:function(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number.");u=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"endTime",a({},l,{get:function(){return c},set:function(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number.");c=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"text",a({},l,{get:function(){return f},set:function(e){f=""+e,this.hasBeenReset=!0}})),Object.defineProperty(o,"region",a({},l,{get:function(){return g},set:function(e){g=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"vertical",a({},l,{get:function(){return v},set:function(t){var i=function(t){return r(e,t)}(t);if(!1===i)throw new SyntaxError("An invalid or illegal string was specified.");v=i,this.hasBeenReset=!0}})),Object.defineProperty(o,"snapToLines",a({},l,{get:function(){return m},set:function(e){m=!!e,this.hasBeenReset=!0}})),Object.defineProperty(o,"line",a({},l,{get:function(){return p},set:function(e){if("number"!=typeof e&&"auto"!==e)throw new SyntaxError("An invalid number or illegal string was specified.");p=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"lineAlign",a({},l,{get:function(){return T},set:function(e){var t=i(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");T=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"position",a({},l,{get:function(){return y},set:function(e){if(e<0||e>100)throw new Error("Position must be between 0 and 100.");y=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"positionAlign",a({},l,{get:function(){return E},set:function(e){var t=i(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");E=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"size",a({},l,{get:function(){return S},set:function(e){if(e<0||e>100)throw new Error("Size must be between 0 and 100.");S=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"align",a({},l,{get:function(){return L},set:function(e){var t=i(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");L=t,this.hasBeenReset=!0}})),o.displayState=void 0}return s.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},s}();class ti{decode(e,t){if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function ri(e){function t(e,t,r,i){return 3600*(0|e)+60*(0|t)+(0|r)+parseFloat(i||0)}var r=e.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return r?parseFloat(r[2])>59?t(r[2],r[3],0,r[4]):t(r[1],r[2],r[3],r[4]):null}class ii{constructor(){this.values=Object.create(null)}set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,r){return r?this.has(e)?this.values[e]:t[r]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,r){for(var i=0;i<r.length;++i)if(t===r[i]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){var r=parseFloat(t);if(r>=0&&r<=100)return this.set(e,r),!0}return!1}}function ai(e,t,r,i){var a=i?e.split(i):[e];for(var s in a)if("string"==typeof a[s]){var n=a[s].split(r);if(2===n.length)t(n[0],n[1])}}var si=new ei(0,0,""),ni="middle"===si.align?"middle":"center";function oi(e,t,r){var i=e;function a(){var t=ri(e);if(null===t)throw new Error("Malformed timestamp: "+i);return e=e.replace(/^[^\sa-zA-Z-]+/,""),t}function s(){e=e.replace(/^\s+/,"")}if(s(),t.startTime=a(),s(),"--\x3e"!==e.substr(0,3))throw new Error("Malformed time stamp (time stamps must be separated by '--\x3e'): "+i);e=e.substr(3),s(),t.endTime=a(),s(),function(e,t){var i=new ii;ai(e,(function(e,t){var a;switch(e){case"region":for(var s=r.length-1;s>=0;s--)if(r[s].id===t){i.set(e,r[s].region);break}break;case"vertical":i.alt(e,t,["rl","lr"]);break;case"line":a=t.split(","),i.integer(e,a[0]),i.percent(e,a[0])&&i.set("snapToLines",!1),i.alt(e,a[0],["auto"]),2===a.length&&i.alt("lineAlign",a[1],["start",ni,"end"]);break;case"position":a=t.split(","),i.percent(e,a[0]),2===a.length&&i.alt("positionAlign",a[1],["start",ni,"end","line-left","line-right","auto"]);break;case"size":i.percent(e,t);break;case"align":i.alt(e,t,["start",ni,"end","left","right"])}}),/:/,/\s/),t.region=i.get("region",null),t.vertical=i.get("vertical","");var a=i.get("line","auto");"auto"===a&&-1===si.line&&(a=-1),t.line=a,t.lineAlign=i.get("lineAlign","start"),t.snapToLines=i.get("snapToLines",!0),t.size=i.get("size",100),t.align=i.get("align",ni);var s=i.get("position","auto");"auto"===s&&50===si.position&&(s="start"===t.align||"left"===t.align?0:"end"===t.align||"right"===t.align?100:50),t.position=s}(e,t)}function li(e){return e.replace(/<br(?: \/)?>/gi,"\n")}class hi{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new ti,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){var t=this;function r(){var e=t.buffer,r=0;for(e=li(e);r<e.length&&"\r"!==e[r]&&"\n"!==e[r];)++r;var i=e.substr(0,r);return"\r"===e[r]&&++r,"\n"===e[r]&&++r,t.buffer=e.substr(r),i}e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));try{var i="";if("INITIAL"===t.state){if(!/\r\n|\n/.test(t.buffer))return this;var a=(i=r()).match(/^()?WEBVTT([ \t].*)?$/);if(!a||!a[0])throw new Error("Malformed WebVTT signature.");t.state="HEADER"}for(var s=!1;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(s?s=!1:i=r(),t.state){case"HEADER":/:/.test(i)?ai(i,(function(e,t){}),/:/):i||(t.state="ID");continue;case"NOTE":i||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(i)){t.state="NOTE";break}if(!i)continue;if(t.cue=new ei(0,0,""),t.state="CUE",-1===i.indexOf("--\x3e")){t.cue.id=i;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{oi(i,t.cue,t.regionList)}catch(e){t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":var n=-1!==i.indexOf("--\x3e");if(!i||n&&(s=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(null===t.cue)continue;t.cue.text&&(t.cue.text+="\n"),t.cue.text+=i;continue;case"BADCUE":i||(t.state="ID")}}}catch(e){"CUETEXT"===t.state&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state="INITIAL"===t.state?"BADWEBVTT":"BADCUE"}return this}flush(){var e=this;try{if((e.cue||"HEADER"===e.state)&&(e.buffer+="\n\n",e.parse()),"INITIAL"===e.state||"BADWEBVTT"===e.state)throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}var di=/\r\n|\n\r|\n|\r/g,ui=function(e,t,r){return void 0===r&&(r=0),e.substr(r,t.length)===t},ci=function(e){for(var t=5381,r=e.length;r;)t=33*t^e.charCodeAt(--r);return(t>>>0).toString()};function fi(e,t,r){return ci(e.toString())+ci(t.toString())+ci(r)}function gi(e,t,r,i,a,s,n,o){var l,h,d=new hi,u=ce(new Uint8Array(e)).trim().replace(di,"\n").split("\n"),c=[],f=(void 0===(l=r)&&(l=1),ir(t,9e4,1/l)),g="00:00.000",v=0,m=0,p=!0,T=!1;d.oncue=function(e){var t=i[a],r=i.ccOffset,n=(v-f)/9e4;if(null!=t&&t.new&&(void 0!==m?r=i.ccOffset=t.start:function(e,t,r){var i=e[t],a=e[i.prevCC];if(!a||!a.new&&i.new)return e.ccOffset=e.presentationOffset=i.start,void(i.new=!1);for(;null!==(s=a)&&void 0!==s&&s.new;){var s;e.ccOffset+=i.start-a.start,i.new=!1,a=e[(i=a).prevCC]}e.presentationOffset=r}(i,a,n)),n&&(r=n-i.presentationOffset),T){var o=e.endTime-e.startTime,l=hr(9e4*(e.startTime+r-m),9e4*s)/9e4;e.startTime=l,e.endTime=l+o}var h=e.text.trim();e.text=decodeURIComponent(encodeURIComponent(h)),e.id||(e.id=fi(e.startTime,e.endTime,h)),e.endTime>0&&c.push(e)},d.onparsingerror=function(e){h=e},d.onflush=function(){h?o(h):n(c)},u.forEach((e=>{if(p){if(ui(e,"X-TIMESTAMP-MAP=")){p=!1,T=!0,e.substr(16).split(",").forEach((e=>{ui(e,"LOCAL:")?g=e.substr(6):ui(e,"MPEGTS:")&&(v=parseInt(e.substr(7)))}));try{m=function(e){var t=parseInt(e.substr(-3)),r=parseInt(e.substr(-6,2)),i=parseInt(e.substr(-9,2)),a=e.length>9?parseInt(e.substr(0,e.indexOf(":"))):0;if(!(Number.isFinite(t)&&Number.isFinite(r)&&Number.isFinite(i)&&Number.isFinite(a)))throw Error("Malformed X-TIMESTAMP-MAP: Local:"+e);return t+=1e3*r,t+=6e4*i,t+36e5*a}(g)/1e3}catch(e){T=!1,h=e}return}""===e&&(p=!1)}d.parse(e+"\n")})),d.flush()}var vi,mi=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,pi=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,Ti={left:"start",center:"center",right:"end",start:"start",end:"end"};function yi(e,t,r,i,a){var s=A(new Uint8Array(e),["mdat"]);if(0!==s.length){var n,o,l=s[0],h=ce(new Uint8Array(e,l.start,l.end-l.start)),d=(void 0===(n=r)&&(n=1),void 0===o&&(o=!1),ir(t,1,1/n,o));try{i(function(e,t){var r=(new DOMParser).parseFromString(e,"text/xml").getElementsByTagName("tt")[0];if(!r)throw new Error("Invalid ttml");var i={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},a=Object.keys(i).reduce(((e,t)=>(e[t]=r.getAttribute("ttp:"+t)||i[t],e)),{}),s="preserve"!==r.getAttribute("xml:space"),n=Si(Ei(r,"styling","style")),o=Si(Ei(r,"layout","region")),l=Ei(r,"body","[begin]");return[].map.call(l,(e=>{var r=Li(e,s);if(!r||!e.hasAttribute("begin"))return null;var i=Ri(e.getAttribute("begin"),a),l=Ri(e.getAttribute("dur"),a),h=Ri(e.getAttribute("end"),a);if(null===i)throw Ai(e);if(null===h){if(null===l)throw Ai(e);h=i+l}var d=new ei(i-t,h-t,r);d.id=fi(d.startTime,d.endTime,d.text);var u=o[e.getAttribute("region")],c=n[e.getAttribute("style")];d.position=10,d.size=80;var f=function(e,t){var r="http://www.w3.org/ns/ttml#styling";return["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"].reduce(((i,a)=>{var s=bi(t,r,a)||bi(e,r,a);return s&&(i[a]=s),i}),{})}(u,c),{textAlign:g}=f;if(g){var v=Ti[g];v&&(d.lineAlign=v),d.align=g}return Ee(d,f),d})).filter((e=>null!==e))}(h,d))}catch(e){a(e)}}else a(new Error("Could not parse IMSC1 mdat"))}function Ei(e,t,r){var i=e.getElementsByTagName(t)[0];return i?[].slice.call(i.querySelectorAll(r)):[]}function Si(e){return e.reduce(((e,t)=>{var r=t.getAttribute("xml:id");return r&&(e[r]=t),e}),{})}function Li(e,t){return[].slice.call(e.childNodes).reduce(((e,r,i)=>{var a;return"br"===r.nodeName&&i?e+"\n":null!==(a=r.childNodes)&&void 0!==a&&a.length?Li(r,t):t?e+r.textContent.trim().replace(/\s+/g," "):e+r.textContent}),"")}function bi(e,t,r){return e.hasAttributeNS(t,r)?e.getAttributeNS(t,r):null}function Ai(e){return new Error("Could not parse ttml timestamp "+e)}function Ri(e,t){if(!e)return null;var r=ri(e);return null===r&&(mi.test(e)?r=function(e,t){var r=mi.exec(e),i=(0|r[4])+(0|r[5])/t.subFrameRate;return 3600*(0|r[1])+60*(0|r[2])+(0|r[3])+i/t.frameRate}(e,t):pi.test(e)&&(r=function(e,t){var r=pi.exec(e),i=Number(r[1]);switch(r[2]){case"h":return 3600*i;case"m":return 60*i;case"ms":return 1e3*i;case"f":return i/t.frameRate;case"t":return i/t.tickRate}return i}(e,t))),r}function Di(e,t){return e&&e.label===t.name&&!(e.textTrack1||e.textTrack2)}class ki{constructor(e){this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.hls=void 0,this.streamController=void 0,this.clientRect=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){var{hls:e}=this;e.on(r.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(r.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(r.MANIFEST_PARSED,this.onManifestParsed,this),e.on(r.BUFFER_CODECS,this.onBufferCodecs,this),e.on(r.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){var{hls:e}=this;e.off(r.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(r.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(r.MANIFEST_PARSED,this.onManifestParsed,this),e.off(r.BUFFER_CODECS,this.onBufferCodecs,this),e.off(r.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){ki.isLevelAllowed(t.droppedLevel,this.restrictedLevels)&&this.restrictedLevels.push(t.droppedLevel)}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null}onManifestParsed(e,t){var r=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,r.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){var e=this.hls.levels;if(e.length){var t=this.hls;t.autoLevelCapping=this.getMaxLevel(e.length-1),t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){var t=this.hls.levels;if(!t.length)return-1;var r=t.filter(((t,r)=>ki.isLevelAllowed(r,this.restrictedLevels)&&r<=e));return this.clientRect=null,ki.getMaxLevelByMediaSize(r,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;var e=this.media,t={width:0,height:0};if(e){var r=e.getBoundingClientRect();t.width=r.width,t.height=r.height,t.width||t.height||(t.width=r.right-r.left||e.width||0,t.height=r.bottom-r.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*ki.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*ki.contentScaleFactor}static get contentScaleFactor(){var e=1;try{e=self.devicePixelRatio}catch(e){}return e}static isLevelAllowed(e,t){return void 0===t&&(t=[]),-1===t.indexOf(e)}static getMaxLevelByMediaSize(e,t,r){if(!e||!e.length)return-1;for(var i,a,s=e.length-1,n=0;n<e.length;n+=1){var o=e[n];if((o.width>=t||o.height>=r)&&(i=o,!(a=e[n+1])||i.width!==a.width||i.height!==a.height)){s=n;break}}return s}}!function(e){e.WIDEVINE="com.widevine.alpha",e.PLAYREADY="com.microsoft.playready"}(vi||(vi={}));var Ci="undefined"!=typeof self&&self.navigator&&self.navigator.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null,_i=/^age:\s*[\d.]+\s*$/m;class Ii{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=void 0,this.loader=null,this.stats=void 0,this.xhrSetup=e?e.xhrSetup:null,this.stats=new v,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null}abortInternal(){var e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,4!==e.readyState&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),null!==(e=this.callbacks)&&void 0!==e&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,r){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=r,this.retryDelay=t.retryDelay,this.loadInternal()}loadInternal(){var{config:e,context:t}=this;if(e){var r=this.loader=new self.XMLHttpRequest,i=this.stats;i.loading.first=0,i.loaded=0;var a=this.xhrSetup;try{if(a)try{a(r,t.url)}catch(e){r.open("GET",t.url,!0),a(r,t.url)}r.readyState||r.open("GET",t.url,!0)}catch(e){return void this.callbacks.onError({code:r.status,text:e.message},t,r)}t.rangeEnd&&r.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),r.onreadystatechange=this.readystatechange.bind(this),r.onprogress=this.loadprogress.bind(this),r.responseType=t.responseType,self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),e.timeout),r.send()}}readystatechange(){var{context:e,loader:t,stats:r}=this;if(e&&t){var i=t.readyState,a=this.config;if(!r.aborted&&i>=2)if(self.clearTimeout(this.requestTimeout),0===r.loading.first&&(r.loading.first=Math.max(self.performance.now(),r.loading.start)),4===i){t.onreadystatechange=null,t.onprogress=null;var s=t.status;if(s>=200&&s<300){var n,o;if(r.loading.end=Math.max(self.performance.now(),r.loading.first),o="arraybuffer"===e.responseType?(n=t.response).byteLength:(n=t.responseText).length,r.loaded=r.total=o,!this.callbacks)return;var l=this.callbacks.onProgress;if(l&&l(r,e,n,t),!this.callbacks)return;var h={url:t.responseURL,data:n};this.callbacks.onSuccess(h,r,e,t)}else r.retry>=a.maxRetry||s>=400&&s<499?(c.error(s+" while loading "+e.url),this.callbacks.onError({code:s,text:t.statusText},e,t)):(c.warn(s+" while loading "+e.url+", retrying in "+this.retryDelay+"..."),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,a.maxRetryDelay),r.retry++)}else self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),a.timeout)}}loadtimeout(){c.warn("timeout while loading "+this.context.url);var e=this.callbacks;e&&(this.abortInternal(),e.onTimeout(this.stats,this.context,this.loader))}loadprogress(e){var t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){var e=null;if(this.loader&&_i.test(this.loader.getAllResponseHeaders())){var t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}}class wi{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=void 0,this.response=void 0,this.controller=void 0,this.context=void 0,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||xi,this.controller=new self.AbortController,this.stats=new v}destroy(){this.loader=this.callbacks=null,this.abortInternal()}abortInternal(){var e=this.response;e&&e.ok||(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),null!==(e=this.callbacks)&&void 0!==e&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,r){var i=this.stats;if(i.loading.start)throw new Error("Loader can only be used once.");i.loading.start=self.performance.now();var a=function(e,t){var r={method:"GET",mode:"cors",credentials:"same-origin",signal:t};e.rangeEnd&&(r.headers=new self.Headers({Range:"bytes="+e.rangeStart+"-"+String(e.rangeEnd-1)}));return r}(e,this.controller.signal),s=r.onProgress,n="arraybuffer"===e.responseType,o=n?"byteLength":"length";this.context=e,this.config=t,this.callbacks=r,this.request=this.fetchSetup(e,a),self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout((()=>{this.abortInternal(),r.onTimeout(i,e,this.response)}),t.timeout),self.fetch(this.request).then((r=>{if(this.response=this.loader=r,!r.ok){var{status:a,statusText:o}=r;throw new Oi(o||"fetch, bad network response",a,r)}return i.loading.first=Math.max(self.performance.now(),i.loading.start),i.total=parseInt(r.headers.get("Content-Length")||"0"),s&&Number.isFinite(t.highWaterMark)?this.loadProgressively(r,i,e,t.highWaterMark,s):n?r.arrayBuffer():r.text()})).then((a=>{var{response:n}=this;self.clearTimeout(this.requestTimeout),i.loading.end=Math.max(self.performance.now(),i.loading.first),i.loaded=i.total=a[o];var l={url:n.url,data:a};s&&!Number.isFinite(t.highWaterMark)&&s(i,e,a,n),r.onSuccess(l,i,e,n)})).catch((t=>{if(self.clearTimeout(this.requestTimeout),!i.aborted){var a=t.code||0;r.onError({code:a,text:t.message},e,t.details)}}))}getCacheAge(){var e=null;if(this.response){var t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}loadProgressively(e,t,r,i,a){void 0===i&&(i=0);var s=new mr,n=e.body.getReader(),o=()=>n.read().then((n=>{if(n.done)return s.dataLength&&a(t,r,s.flush(),e),Promise.resolve(new ArrayBuffer(0));var l=n.value,h=l.length;return t.loaded+=h,h<i||s.dataLength?(s.push(l),s.dataLength>=i&&a(t,r,s.flush(),e)):a(t,r,l,e),o()})).catch((()=>Promise.reject()));return o()}}function xi(e,t){return new self.Request(e.url,t)}class Oi extends Error{constructor(e,t,r){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=r}}var Pi=/\s/,Fi={newCue(e,t,r,i){for(var a,s,n,o,l,h=[],d=self.VTTCue||self.TextTrackCue,u=0;u<i.rows.length;u++)if(n=!0,o=0,l="",!(a=i.rows[u]).isEmpty()){for(var c=0;c<a.chars.length;c++)Pi.test(a.chars[c].uchar)&&n?o++:(l+=a.chars[c].uchar,n=!1);a.cueStartTime=t,t===r&&(r+=1e-4),o>=16?o--:o++;var f=li(l.trim()),g=fi(t,r,f);e&&e.cues&&e.cues.getCueById(g)||((s=new d(t,r,f)).id=g,s.line=u+1,s.align="left",s.position=10+Math.min(80,10*Math.floor(8*o/32)),h.push(s))}return e&&h.length&&(h.sort(((e,t)=>"auto"===e.line||"auto"===t.line?0:e.line>8&&t.line>8?t.line-e.line:e.line-t.line)),h.forEach((t=>z(e,t)))),h}},Mi=Te(Te({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,enableSoftwareAES:!0,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,startLevel:void 0,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:Ii,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:class{constructor(e){this.hls=void 0,this.lastLoadedFragLevel=0,this._nextAutoLevel=-1,this.timer=void 0,this.onCheck=this._abandonRulesCheck.bind(this),this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this.hls=e;var t=e.config;this.bwEstimator=new Ir(t.abrEwmaSlowVoD,t.abrEwmaFastVoD,t.abrEwmaDefaultEstimate),this.registerListeners()}registerListeners(){var{hls:e}=this;e.on(r.FRAG_LOADING,this.onFragLoading,this),e.on(r.FRAG_LOADED,this.onFragLoaded,this),e.on(r.FRAG_BUFFERED,this.onFragBuffered,this),e.on(r.LEVEL_LOADED,this.onLevelLoaded,this),e.on(r.ERROR,this.onError,this)}unregisterListeners(){var{hls:e}=this;e.off(r.FRAG_LOADING,this.onFragLoading,this),e.off(r.FRAG_LOADED,this.onFragLoaded,this),e.off(r.FRAG_BUFFERED,this.onFragBuffered,this),e.off(r.LEVEL_LOADED,this.onLevelLoaded,this),e.off(r.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this.onCheck=null,this.fragCurrent=this.partCurrent=null}onFragLoading(e,t){var r,i=t.frag;i.type===F.MAIN&&(this.timer||(this.fragCurrent=i,this.partCurrent=null!=(r=t.part)?r:null,this.timer=self.setInterval(this.onCheck,100)))}onLevelLoaded(e,t){var r=this.hls.config;t.details.live?this.bwEstimator.update(r.abrEwmaSlowLive,r.abrEwmaFastLive):this.bwEstimator.update(r.abrEwmaSlowVoD,r.abrEwmaFastVoD)}_abandonRulesCheck(){var{fragCurrent:e,partCurrent:t,hls:i}=this,{autoLevelEnabled:a,config:s,media:n}=i;if(e&&n){var o=t?t.stats:e.stats,l=t?t.duration:e.duration;if(o.aborted)return c.warn("frag loader destroy or aborted, disarm abandonRules"),this.clearTimer(),void(this._nextAutoLevel=-1);if(a&&!n.paused&&n.playbackRate&&n.readyState){var h=performance.now()-o.loading.start,d=Math.abs(n.playbackRate);if(!(h<=500*l/d)){var{levels:u,minAutoLevel:f}=i,g=u[e.level],v=o.total||Math.max(o.loaded,Math.round(l*g.maxBitrate/8)),m=Math.max(1,o.bwEstimate?o.bwEstimate/8:1e3*o.loaded/h),p=(v-o.loaded)/m,T=n.currentTime,y=(Ue.bufferInfo(n,T,s.maxBufferHole).end-T)/d;if(!(y>=2*l/d||p<=y)){var E,S=Number.POSITIVE_INFINITY;for(E=e.level-1;E>f;E--){if((S=l*u[E].maxBitrate/(6.4*m))<y)break}if(!(S>=p)){var L=this.bwEstimator.getEstimate();c.warn("Fragment "+e.sn+(t?" part "+t.index:"")+" of level "+e.level+" is loading too slowly and will cause an underbuffer; aborting and switching to level "+E+"\n      Current BW estimate: "+(Number.isFinite(L)?(L/1024).toFixed(3):"Unknown")+" Kb/s\n      Estimated load time for current fragment: "+p.toFixed(3)+" s\n      Estimated load time for the next fragment: "+S.toFixed(3)+" s\n      Time to underbuffer: "+y.toFixed(3)+" s"),i.nextLoadLevel=E,this.bwEstimator.sample(h,o.loaded),this.clearTimer(),e.loader&&(this.fragCurrent=this.partCurrent=null,e.loader.abort()),i.trigger(r.FRAG_LOAD_EMERGENCY_ABORTED,{frag:e,part:t,stats:o})}}}}}}onFragLoaded(e,t){var{frag:i,part:a}=t;if(i.type===F.MAIN&&Number.isFinite(i.sn)){var s=a?a.stats:i.stats,n=a?a.duration:i.duration;if(this.clearTimer(),this.lastLoadedFragLevel=i.level,this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){var o=this.hls.levels[i.level],l=(o.loaded?o.loaded.bytes:0)+s.loaded,h=(o.loaded?o.loaded.duration:0)+n;o.loaded={bytes:l,duration:h},o.realBitrate=Math.round(8*l/h)}if(i.bitrateTest){var d={stats:s,frag:i,part:a,id:i.type};this.onFragBuffered(r.FRAG_BUFFERED,d),i.bitrateTest=!1}}}onFragBuffered(e,t){var{frag:r,part:i}=t,a=i?i.stats:r.stats;if(!a.aborted&&r.type===F.MAIN&&"initSegment"!==r.sn){var s=a.parsing.end-a.loading.start;this.bwEstimator.sample(s,a.loaded),a.bwEstimate=this.bwEstimator.getEstimate(),r.bitrateTest?this.bitrateTestDelay=s/1e3:this.bitrateTestDelay=0}}onError(e,t){switch(t.details){case a.FRAG_LOAD_ERROR:case a.FRAG_LOAD_TIMEOUT:this.clearTimer()}}clearTimer(){self.clearInterval(this.timer),this.timer=void 0}get nextAutoLevel(){var e=this._nextAutoLevel,t=this.bwEstimator;if(!(-1===e||t&&t.canEstimate()))return e;var r=this.getNextABRAutoLevel();return-1!==e&&(r=Math.min(e,r)),r}getNextABRAutoLevel(){var{fragCurrent:e,partCurrent:t,hls:r}=this,{maxAutoLevel:i,config:a,minAutoLevel:s,media:n}=r,o=t?t.duration:e?e.duration:0,l=n?n.currentTime:0,h=n&&0!==n.playbackRate?Math.abs(n.playbackRate):1,d=this.bwEstimator?this.bwEstimator.getEstimate():a.abrEwmaDefaultEstimate,u=(Ue.bufferInfo(n,l,a.maxBufferHole).end-l)/h,f=this.findBestLevel(d,s,i,u,a.abrBandWidthFactor,a.abrBandWidthUpFactor);if(f>=0)return f;c.trace((u?"rebuffering expected":"buffer is empty")+", finding optimal quality level");var g=o?Math.min(o,a.maxStarvationDelay):a.maxStarvationDelay,v=a.abrBandWidthFactor,m=a.abrBandWidthUpFactor;if(!u){var p=this.bitrateTestDelay;if(p)g=(o?Math.min(o,a.maxLoadingDelay):a.maxLoadingDelay)-p,c.trace("bitrate test took "+Math.round(1e3*p)+"ms, set first fragment max fetchDuration to "+Math.round(1e3*g)+" ms"),v=m=1}return f=this.findBestLevel(d,s,i,u+g,v,m),Math.max(f,0)}findBestLevel(e,t,r,i,a,s){for(var n,{fragCurrent:o,partCurrent:l,lastLoadedFragLevel:h}=this,{levels:d}=this.hls,u=d[h],f=!(null==u||null===(n=u.details)||void 0===n||!n.live),g=null==u?void 0:u.codecSet,v=l?l.duration:o?o.duration:0,m=r;m>=t;m--){var p=d[m];if(p&&(!g||p.codecSet===g)){var T=p.details,y=(l?null==T?void 0:T.partTarget:null==T?void 0:T.averagetargetduration)||v,E=void 0;E=m<=h?a*e:s*e;var S=d[m].maxBitrate,L=S*y/E;if(c.trace("level/adjustedbw/bitrate/avgDuration/maxFetchDuration/fetchDuration: "+m+"/"+Math.round(E)+"/"+S+"/"+y+"/"+i+"/"+L),E>S&&(!L||f&&!this.bitrateTestDelay||L<i))return m}}return-1}set nextAutoLevel(e){this._nextAutoLevel=e}},bufferController:class{constructor(e){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.appendError=0,this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this._onMediaSourceOpen=()=>{var{hls:e,media:t,mediaSource:i}=this;c.log("[buffer-controller]: Media source opened"),t&&(this.updateMediaElementDuration(),e.trigger(r.MEDIA_ATTACHED,{media:t})),i&&i.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{c.log("[buffer-controller]: Media source closed")},this._onMediaSourceEnded=()=>{c.log("[buffer-controller]: Media source ended")},this.hls=e,this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null}registerListeners(){var{hls:e}=this;e.on(r.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(r.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(r.MANIFEST_PARSED,this.onManifestParsed,this),e.on(r.BUFFER_RESET,this.onBufferReset,this),e.on(r.BUFFER_APPENDING,this.onBufferAppending,this),e.on(r.BUFFER_CODECS,this.onBufferCodecs,this),e.on(r.BUFFER_EOS,this.onBufferEos,this),e.on(r.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(r.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(r.FRAG_PARSED,this.onFragParsed,this),e.on(r.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){var{hls:e}=this;e.off(r.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(r.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(r.MANIFEST_PARSED,this.onManifestParsed,this),e.off(r.BUFFER_RESET,this.onBufferReset,this),e.off(r.BUFFER_APPENDING,this.onBufferAppending,this),e.off(r.BUFFER_CODECS,this.onBufferCodecs,this),e.off(r.BUFFER_EOS,this.onBufferEos,this),e.off(r.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(r.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(r.FRAG_PARSED,this.onFragParsed,this),e.off(r.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new xr(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]}}onManifestParsed(e,t){var r=2;(t.audio&&!t.video||!t.altAudio)&&(r=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=r,this.details=null,c.log(this.bufferCodecEventsExpected+" bufferCodec event(s) expected")}onMediaAttaching(e,t){var r=this.media=t.media;if(r&&Or){var i=this.mediaSource=new Or;i.addEventListener("sourceopen",this._onMediaSourceOpen),i.addEventListener("sourceended",this._onMediaSourceEnded),i.addEventListener("sourceclose",this._onMediaSourceClose),r.src=self.URL.createObjectURL(i),this._objectUrl=r.src}}onMediaDetaching(){var{media:e,mediaSource:t,_objectUrl:i}=this;if(t){if(c.log("[buffer-controller]: media source detaching"),"open"===t.readyState)try{t.endOfStream()}catch(e){c.warn("[buffer-controller]: onMediaDetaching: "+e.message+" while calling endOfStream")}this.onBufferReset(),t.removeEventListener("sourceopen",this._onMediaSourceOpen),t.removeEventListener("sourceended",this._onMediaSourceEnded),t.removeEventListener("sourceclose",this._onMediaSourceClose),e&&(i&&self.URL.revokeObjectURL(i),e.src===i?(e.removeAttribute("src"),e.load()):c.warn("[buffer-controller]: media.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(r.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach((e=>{var t=this.sourceBuffer[e];try{t&&(this.removeBufferListeners(e),this.mediaSource&&this.mediaSource.removeSourceBuffer(t),this.sourceBuffer[e]=void 0)}catch(t){c.warn("[buffer-controller]: Failed to reset the "+e+" buffer",t)}})),this._initSourceBuffer()}onBufferCodecs(e,t){var r=this.getSourceBufferTypes().length;Object.keys(t).forEach((e=>{if(r){var i=this.tracks[e];if(i&&"function"==typeof i.buffer.changeType){var{codec:a,levelCodec:s,container:n}=t[e];if((i.levelCodec||i.codec).replace(Pr,"$1")!==(s||a).replace(Pr,"$1")){var o=n+";codecs="+(s||a);this.appendChangeType(e,o)}}}else this.pendingTracks[e]=t[e]})),r||(this.bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks())}appendChangeType(e,t){var{operationQueue:r}=this,i={execute:()=>{var i=this.sourceBuffer[e];i&&(c.log("[buffer-controller]: changing "+e+" sourceBuffer type to "+t),i.changeType(t)),r.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:t=>{c.warn("[buffer-controller]: Failed to change "+e+" SourceBuffer type",t)}};r.append(i,e)}onBufferAppending(e,t){var{hls:s,operationQueue:n,tracks:o}=this,{data:l,type:h,frag:d,part:u,chunkMeta:f}=t,g=f.buffering[h],v=self.performance.now();g.start=v;var m=d.stats.buffering,p=u?u.stats.buffering:null;0===m.start&&(m.start=v),p&&0===p.start&&(p.start=v);var T=o.audio,y="audio"===h&&1===f.id&&"audio/mpeg"===(null==T?void 0:T.container),E={execute:()=>{if(g.executeStart=self.performance.now(),y){var e=this.sourceBuffer[h];if(e){var t=d.start-e.timestampOffset;Math.abs(t)>=.1&&(c.log("[buffer-controller]: Updating audio SourceBuffer timestampOffset to "+d.start+" (delta: "+t+") sn: "+d.sn+")"),e.timestampOffset=d.start)}}this.appendExecutor(l,h)},onStart:()=>{},onComplete:()=>{var e=self.performance.now();g.executeEnd=g.end=e,0===m.first&&(m.first=e),p&&0===p.first&&(p.first=e);var{sourceBuffer:t}=this,i={};for(var a in t)i[a]=Ue.getBuffered(t[a]);this.appendError=0,this.hls.trigger(r.BUFFER_APPENDED,{type:h,frag:d,part:u,chunkMeta:f,parent:d.type,timeRanges:i})},onError:e=>{c.error("[buffer-controller]: Error encountered while trying to append to the "+h+" SourceBuffer",e);var t={type:i.MEDIA_ERROR,parent:d.type,details:a.BUFFER_APPEND_ERROR,err:e,fatal:!1};e.code===DOMException.QUOTA_EXCEEDED_ERR?t.details=a.BUFFER_FULL_ERROR:(this.appendError++,t.details=a.BUFFER_APPEND_ERROR,this.appendError>s.config.appendErrorMaxRetry&&(c.error("[buffer-controller]: Failed "+s.config.appendErrorMaxRetry+" times to append segment in sourceBuffer"),t.fatal=!0)),s.trigger(r.ERROR,t)}};n.append(E,h)}onBufferFlushing(e,t){var{operationQueue:i}=this,a=e=>({execute:this.removeExecutor.bind(this,e,t.startOffset,t.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(r.BUFFER_FLUSHED,{type:e})},onError:t=>{c.warn("[buffer-controller]: Failed to remove from "+e+" SourceBuffer",t)}});t.type?i.append(a(t.type),t.type):this.getSourceBufferTypes().forEach((e=>{i.append(a(e),e)}))}onFragParsed(e,t){var{frag:i,part:a}=t,s=[],n=a?a.elementaryStreams:i.elementaryStreams;n[u.AUDIOVIDEO]?s.push("audiovideo"):(n[u.AUDIO]&&s.push("audio"),n[u.VIDEO]&&s.push("video"));0===s.length&&c.warn("Fragments must have at least one ElementaryStreamType set. type: "+i.type+" level: "+i.level+" sn: "+i.sn),this.blockBuffers((()=>{var e=self.performance.now();i.stats.buffering.end=e,a&&(a.stats.buffering.end=e);var t=a?a.stats:i.stats;this.hls.trigger(r.FRAG_BUFFERED,{frag:i,part:a,stats:t,id:i.type})}),s)}onFragChanged(e,t){this.flushBackBuffer()}onBufferEos(e,t){this.getSourceBufferTypes().reduce(((e,r)=>{var i=this.sourceBuffer[r];return t.type&&t.type!==r||i&&!i.ended&&(i.ended=!0,c.log("[buffer-controller]: "+r+" sourceBuffer now EOS")),e&&!(i&&!i.ended)}),!0)&&this.blockBuffers((()=>{var{mediaSource:e}=this;e&&"open"===e.readyState&&e.endOfStream()}))}onLevelUpdated(e,t){var{details:r}=t;r.fragments.length&&(this.details=r,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}flushBackBuffer(){var{hls:e,details:t,media:i,sourceBuffer:a}=this;if(i&&null!==t){var s=this.getSourceBufferTypes();if(s.length){var n=t.live&&null!==e.config.liveBackBufferLength?e.config.liveBackBufferLength:e.config.backBufferLength;if(Number.isFinite(n)&&!(n<0)){var o=i.currentTime,l=t.levelTargetDuration,h=Math.max(n,l),d=Math.floor(o/l)*l-h;s.forEach((i=>{var s=a[i];if(s){var n=Ue.getBuffered(s);n.length>0&&d>n.start(0)&&(e.trigger(r.BACK_BUFFER_REACHED,{bufferEnd:d}),t.live&&e.trigger(r.LIVE_BACK_BUFFER_REACHED,{bufferEnd:d}),e.trigger(r.BUFFER_FLUSHING,{startOffset:0,endOffset:d,type:i}))}}))}}}}updateMediaElementDuration(){if(this.details&&this.media&&this.mediaSource&&"open"===this.mediaSource.readyState){var{details:e,hls:t,media:r,mediaSource:i}=this,a=e.fragments[0].start+e.totalduration,s=r.duration,n=Number.isFinite(i.duration)?i.duration:0;e.live&&t.config.liveDurationInfinity?(c.log("[buffer-controller]: Media Source duration is set to Infinity"),i.duration=1/0,this.updateSeekableRange(e)):(a>n&&a>s||!Number.isFinite(s))&&(c.log("[buffer-controller]: Updating Media Source duration to "+a.toFixed(3)),i.duration=a)}}updateSeekableRange(e){var t=this.mediaSource,r=e.fragments;if(r.length&&e.live&&null!=t&&t.setLiveSeekableRange){var i=Math.max(0,r[0].start),a=Math.max(i,i+e.totalduration);t.setLiveSeekableRange(i,a)}}checkPendingTracks(){var{bufferCodecEventsExpected:e,operationQueue:t,pendingTracks:s}=this,n=Object.keys(s).length;if(n&&!e||2===n){this.createSourceBuffers(s),this.pendingTracks={};var o=this.getSourceBufferTypes();if(0===o.length)return void this.hls.trigger(r.ERROR,{type:i.MEDIA_ERROR,details:a.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,reason:"could not create source buffer for media codec(s)"});o.forEach((e=>{t.executeNext(e)}))}}createSourceBuffers(e){var{sourceBuffer:t,mediaSource:s}=this;if(!s)throw Error("createSourceBuffers called when mediaSource was null");var n=0;for(var o in e)if(!t[o]){var l=e[o];if(!l)throw Error("source buffer exists for track "+o+", however track does not");var h=l.levelCodec||l.codec,d=l.container+";codecs="+h;c.log("[buffer-controller]: creating sourceBuffer("+d+")");try{var u=t[o]=s.addSourceBuffer(d),f=o;this.addBufferListener(f,"updatestart",this._onSBUpdateStart),this.addBufferListener(f,"updateend",this._onSBUpdateEnd),this.addBufferListener(f,"error",this._onSBUpdateError),this.tracks[o]={buffer:u,codec:h,container:l.container,levelCodec:l.levelCodec,id:l.id},n++}catch(e){c.error("[buffer-controller]: error while trying to add sourceBuffer: "+e.message),this.hls.trigger(r.ERROR,{type:i.MEDIA_ERROR,details:a.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:e,mimeType:d})}}n&&this.hls.trigger(r.BUFFER_CREATED,{tracks:this.tracks})}_onSBUpdateStart(e){var{operationQueue:t}=this;t.current(e).onStart()}_onSBUpdateEnd(e){var{operationQueue:t}=this;t.current(e).onComplete(),t.shiftAndExecuteNext(e)}_onSBUpdateError(e,t){c.error("[buffer-controller]: "+e+" SourceBuffer error",t),this.hls.trigger(r.ERROR,{type:i.MEDIA_ERROR,details:a.BUFFER_APPENDING_ERROR,fatal:!1});var s=this.operationQueue.current(e);s&&s.onError(t)}removeExecutor(e,t,r){var{media:i,mediaSource:a,operationQueue:s,sourceBuffer:n}=this,o=n[e];if(!i||!a||!o)return c.warn("[buffer-controller]: Attempting to remove from the "+e+" SourceBuffer, but it does not exist"),void s.shiftAndExecuteNext(e);var l=Number.isFinite(i.duration)?i.duration:1/0,h=Number.isFinite(a.duration)?a.duration:1/0,d=Math.max(0,t),u=Math.min(r,l,h);u>d?(c.log("[buffer-controller]: Removing ["+d+","+u+"] from the "+e+" SourceBuffer"),console.assert(!o.updating,e+" sourceBuffer must not be updating"),o.remove(d,u)):s.shiftAndExecuteNext(e)}appendExecutor(e,t){var{operationQueue:r,sourceBuffer:i}=this,a=i[t];if(!a)return c.warn("[buffer-controller]: Attempting to append to the "+t+" SourceBuffer, but it does not exist"),void r.shiftAndExecuteNext(t);a.ended=!1,console.assert(!a.updating,t+" sourceBuffer must not be updating"),a.appendBuffer(e)}blockBuffers(e,t){if(void 0===t&&(t=this.getSourceBufferTypes()),!t.length)return c.log("[buffer-controller]: Blocking operation requested, but no SourceBuffers exist"),void Promise.resolve(e);var{operationQueue:r}=this,i=t.map((e=>r.appendBlocker(e)));Promise.all(i).then((()=>{e(),t.forEach((e=>{var t=this.sourceBuffer[e];t&&t.updating||r.shiftAndExecuteNext(e)}))}))}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(e,t,r){var i=this.sourceBuffer[e];if(i){var a=r.bind(this,e);this.listeners[e].push({event:t,listener:a}),i.addEventListener(t,a)}}removeBufferListeners(e){var t=this.sourceBuffer[e];t&&this.listeners[e].forEach((e=>{t.removeEventListener(e.event,e.listener)}))}},capLevelController:ki,fpsController:class{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(r.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(r.MEDIA_ATTACHING,this.onMediaAttaching)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){var r=this.hls.config;if(r.capLevelOnFPSDrop){var i=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=i,i&&"function"==typeof i.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),r.fpsDroppedMonitoringPeriod)}}checkFPS(e,t,i){var a=performance.now();if(t){if(this.lastTime){var s=a-this.lastTime,n=i-this.lastDroppedFrames,o=t-this.lastDecodedFrames,l=1e3*n/s,h=this.hls;if(h.trigger(r.FPS_DROP,{currentDropped:n,currentDecoded:o,totalDroppedFrames:i}),l>0&&n>h.config.fpsDroppedMonitoringThreshold*o){var d=h.currentLevel;c.warn("drop FPS ratio greater than max allowed value for currentLevel: "+d),d>0&&(-1===h.autoLevelCapping||h.autoLevelCapping>=d)&&(d-=1,h.trigger(r.FPS_DROP_LEVEL_CAPPING,{level:d,droppedLevel:h.currentLevel}),h.autoLevelCapping=d,this.streamController.nextLevelSwitch())}}this.lastTime=a,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){var e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){var t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}},stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystemOptions:{},requestMediaKeySystemAccessFunc:Ci,testBandwidth:!0,progressive:!1,lowLatencyMode:!0},{cueHandler:Fi,enableCEA708Captions:!0,enableWebVTT:!0,enableIMSC1:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{},{subtitleStreamController:class extends vt{constructor(e,t){super(e,t,"[subtitle-stream-controller]"),this.levels=[],this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),this.mainDetails=null}_registerListeners(){var{hls:e}=this;e.on(r.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(r.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(r.MANIFEST_LOADING,this.onManifestLoading,this),e.on(r.LEVEL_LOADED,this.onLevelLoaded,this),e.on(r.ERROR,this.onError,this),e.on(r.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(r.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(r.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(r.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(r.BUFFER_FLUSHING,this.onBufferFlushing,this)}_unregisterListeners(){var{hls:e}=this;e.off(r.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(r.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(r.MANIFEST_LOADING,this.onManifestLoading,this),e.off(r.LEVEL_LOADED,this.onLevelLoaded,this),e.off(r.ERROR,this.onError,this),e.off(r.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(r.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(r.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(r.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(r.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(){this.stopLoad(),this.state=st,this.setInterval(500),this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){var{frag:r,success:i}=t;if(this.fragPrevious=r,this.state=st,i){var a=this.tracksBuffered[this.currentTrackId];if(a){for(var s,n=r.start,o=0;o<a.length;o++)if(n>=a[o].start&&n<=a[o].end){s=a[o];break}var l=r.start+r.duration;s?s.end=l:(s={start:n,end:l},a.push(s)),this.fragmentTracker.fragBuffered(r)}}}onBufferFlushing(e,t){var{startOffset:r,endOffset:i}=t;if(0===r&&i!==Number.POSITIVE_INFINITY){var{currentTrackId:a,levels:s}=this;if(!s.length||!s[a]||!s[a].details)return;var n=i-s[a].details.targetduration;if(n<=0)return;t.endOffsetSubtitles=Math.max(0,n),this.tracksBuffered.forEach((e=>{for(var t=0;t<e.length;)if(e[t].end<=n)e.shift();else{if(!(e[t].start<n))break;e[t].start=n,t++}})),this.fragmentTracker.removeFragmentsInRange(r,n,F.SUBTITLE)}}onError(e,t){var r,i=t.frag;i&&i.type===F.SUBTITLE&&(null!==(r=this.fragCurrent)&&void 0!==r&&r.loader&&this.fragCurrent.loader.abort(),this.state=st)}onSubtitleTracksUpdated(e,t){var{subtitleTracks:r}=t;this.tracksBuffered=[],this.levels=r.map((e=>new Le(e))),this.fragmentTracker.removeAllFragments(),this.fragPrevious=null,this.levels.forEach((e=>{this.tracksBuffered[e.id]=[]})),this.mediaBuffer=null}onSubtitleTrackSwitch(e,t){if(this.currentTrackId=t.id,this.levels.length&&-1!==this.currentTrackId){var r=this.levels[this.currentTrackId];null!=r&&r.details?(this.mediaBuffer=this.mediaBufferTimeRanges,this.setInterval(500)):this.mediaBuffer=null}else this.clearInterval()}onSubtitleTrackLoaded(e,t){var r,{details:i,id:a}=t,{currentTrackId:s,levels:n}=this;if(n.length){var o=n[s];if(!(a>=n.length||a!==s)&&o){if(this.mediaBuffer=this.mediaBufferTimeRanges,i.live||null!==(r=o.details)&&void 0!==r&&r.live){var l=this.mainDetails;if(i.deltaUpdateFailed||!l)return;var h=l.fragments[0];if(o.details)0===this.alignPlaylists(i,o.details)&&h&&_e(i,h.start);else i.hasProgramDateTime&&l.hasProgramDateTime?function(e,t){if(t.fragments.length&&e.hasProgramDateTime&&t.hasProgramDateTime){var r=t.fragments[0].programDateTime-1e3*t.fragments[0].start;e.fragments.forEach((e=>{Ve(e,r)})),e.fragmentHint&&Ve(e.fragmentHint,r),e.alignedSliding=!0}}(i,l):h&&_e(i,h.start)}if(o.details=i,this.levelLastLoaded=a,this.tick(),i.live&&!this.fragCurrent&&this.media&&this.state===st)qe(null,i.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),o.details=void 0)}}}_handleFragmentLoadComplete(e){var{frag:t,payload:i}=e,a=t.decryptdata,s=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&a&&a.key&&a.iv&&"AES-128"===a.method){var n=performance.now();this.decrypter.webCryptoDecrypt(new Uint8Array(i),a.key.buffer,a.iv.buffer).then((e=>{var i=performance.now();s.trigger(r.FRAG_DECRYPTED,{frag:t,payload:e,stats:{tstart:n,tdecrypt:i}})}))}}doTick(){if(this.media){if(this.state===st){var e,{currentTrackId:t,levels:i}=this;if(!i.length||!i[t]||!i[t].details)return;var a=i[t].details,s=a.targetduration,{config:n,media:o}=this,l=Ue.bufferedInfo(this.mediaBufferTimeRanges,o.currentTime-s,n.maxBufferHole),{end:h,len:d}=l;if(d>this.getMaxBufferLength()+s)return;console.assert(a,"Subtitle track details are defined on idle subtitle stream controller tick");var u,f=a.fragments,g=f.length,v=a.edge,m=this.fragPrevious;if(h<v){var{maxFragLookUpTolerance:p}=n;m&&a.hasProgramDateTime&&(u=We(f,m.endProgramDateTime,p)),u||!(u=qe(m,f,h,p))&&m&&m.start<f[0].start&&(u=f[0])}else u=f[g-1];null!==(e=u)&&void 0!==e&&e.encrypted?(c.log("Loading key for "+u.sn),this.state=nt,this.hls.trigger(r.KEY_LOADING,{frag:u})):u&&this.fragmentTracker.getState(u)===we.NOT_LOADED&&this.loadFragment(u,a,h)}}else this.state=st}loadFragment(e,t,r){this.fragCurrent=e,super.loadFragment(e,t,r)}get mediaBufferTimeRanges(){return this.tracksBuffered[this.currentTrackId]||[]}},subtitleTrackController:class extends Ie{constructor(e){super(e,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.trackChangeListener=()=>this.onTextTracksChanged(),this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this.subtitleDisplay=!0,this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.trackChangeListener=this.asyncPollTrackChange=null,super.destroy()}registerListeners(){var{hls:e}=this;e.on(r.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(r.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(r.MANIFEST_LOADING,this.onManifestLoading,this),e.on(r.MANIFEST_PARSED,this.onManifestParsed,this),e.on(r.LEVEL_LOADING,this.onLevelLoading,this),e.on(r.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(r.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(r.ERROR,this.onError,this)}unregisterListeners(){var{hls:e}=this;e.off(r.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(r.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(r.MANIFEST_LOADING,this.onManifestLoading,this),e.off(r.MANIFEST_PARSED,this.onManifestParsed,this),e.off(r.LEVEL_LOADING,this.onLevelLoading,this),e.off(r.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(r.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(r.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.trackChangeListener,e)}onMediaDetaching(){this.media&&(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),wr(this.media.textTracks).forEach((e=>{Q(e)})),this.subtitleTrack=-1,this.media=null)}onManifestLoading(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){var{id:r,details:i}=t,{trackId:a}=this,s=this.tracksInGroup[a];if(s){var n=s.details;s.details=t.details,this.log("subtitle track "+r+" loaded ["+i.startSN+"-"+i.endSN+"]"),r===this.trackId&&(this.retryCount=0,this.playlistLoaded(r,t,n))}else this.warn("Invalid subtitle track id "+r)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){var t=this.hls.levels[e];if(null!=t&&t.textGroupIds){var i=t.textGroupIds[t.urlId];if(this.groupId!==i){var a=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0,s=this.tracks.filter((e=>!i||e.groupId===i));this.tracksInGroup=s;var n=this.findTrackId(null==a?void 0:a.name)||this.findTrackId();this.groupId=i;var o={subtitleTracks:s};this.log("Updating subtitle tracks, "+s.length+' track(s) found in "'+i+'" group-id'),this.hls.trigger(r.SUBTITLE_TRACKS_UPDATED,o),-1!==n&&this.setSubtitleTrack(n,a)}}}findTrackId(e){for(var t=this.tracksInGroup,r=0;r<t.length;r++){var i=t[r];if((!this.selectDefaultTrack||i.default)&&(!e||e===i.name))return i.id}return-1}onError(e,t){super.onError(e,t),!t.fatal&&t.context&&t.context.type===P.SUBTITLE_TRACK&&t.context.id===this.trackId&&t.context.groupId===this.groupId&&this.retryLoadingOrFail(t)}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1;var t=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0;this.setSubtitleTrack(e,t)}loadPlaylist(e){var t=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(t)){var i=t.id,a=t.groupId,s=t.url;if(e)try{s=e.addDirectives(s)}catch(e){this.warn("Could not construct new URL with HLS Delivery Directives: "+e)}this.log("Loading subtitle playlist for id "+i),this.hls.trigger(r.SUBTITLE_TRACK_LOADING,{url:s,id:i,groupId:a,deliveryDirectives:e||null})}}toggleTrackModes(e){var{media:t,subtitleDisplay:r,trackId:i}=this;if(t){var a=wr(t.textTracks),s=a.filter((e=>e.groupId===this.groupId));if(-1===e)[].slice.call(a).forEach((e=>{e.mode="disabled"}));else{var n=s[i];n&&(n.mode="disabled")}var o=s[e];o&&(o.mode=r?"showing":"hidden")}}setSubtitleTrack(e,t){var i,a=this.tracksInGroup;if(this.media){if(this.trackId!==e&&this.toggleTrackModes(e),!(this.trackId===e&&(-1===e||null!==(i=a[e])&&void 0!==i&&i.details)||e<-1||e>=a.length)){this.clearTimer();var s=a[e];if(this.log("Switching to subtitle track "+e),this.trackId=e,s){var{id:n,groupId:o="",name:l,type:h,url:d}=s;this.hls.trigger(r.SUBTITLE_TRACK_SWITCH,{id:n,groupId:o,name:l,type:h,url:d});var u=this.switchParams(s.url,null==t?void 0:t.details);this.loadPlaylist(u)}else this.hls.trigger(r.SUBTITLE_TRACK_SWITCH,{id:e})}}else this.queuedDefaultTrack=e}onTextTracksChanged(){if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),this.media&&this.hls.config.renderTextTracksNatively){for(var e=-1,t=wr(this.media.textTracks),r=0;r<t.length;r++)if("hidden"===t[r].mode)e=r;else if("showing"===t[r].mode){e=r;break}this.subtitleTrack!==e&&(this.subtitleTrack=e)}}},timelineController:class{constructor(e){if(this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.timescale=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastSn=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!1}},this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},this.config.enableCEA708Captions){var t=new Jr(this,"textTrack1"),i=new Jr(this,"textTrack2"),a=new Jr(this,"textTrack3"),s=new Jr(this,"textTrack4");this.cea608Parser1=new Qr(1,t,i),this.cea608Parser2=new Qr(3,a,s)}e.on(r.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(r.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(r.MANIFEST_LOADING,this.onManifestLoading,this),e.on(r.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(r.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(r.FRAG_LOADING,this.onFragLoading,this),e.on(r.FRAG_LOADED,this.onFragLoaded,this),e.on(r.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(r.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(r.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(r.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(r.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){var{hls:e}=this;e.off(r.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(r.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(r.MANIFEST_LOADING,this.onManifestLoading,this),e.off(r.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(r.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(r.FRAG_LOADING,this.onFragLoading,this),e.off(r.FRAG_LOADED,this.onFragLoaded,this),e.off(r.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(r.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(r.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(r.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(r.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.cea608Parser1=this.cea608Parser2=null}addCues(e,t,i,a,s){for(var n,o,l,h,d=!1,u=s.length;u--;){var c=s[u],f=(n=c[0],o=c[1],l=t,h=i,Math.min(o,h)-Math.max(n,l));if(f>=0&&(c[0]=Math.min(c[0],t),c[1]=Math.max(c[1],i),d=!0,f/(i-t)>.5))return}if(d||s.push([t,i]),this.config.renderTextTracksNatively){var g=this.captionsTracks[e];this.Cues.newCue(g,t,i,a)}else{var v=this.Cues.newCue(null,t,i,a);this.hls.trigger(r.CUES_PARSED,{type:"captions",cues:v,track:e})}}onInitPtsFound(e,t){var{frag:i,id:a,initPTS:s,timescale:n}=t,{unparsedVttFrags:o}=this;"main"===a&&(this.initPTS[i.cc]=s,this.timescale[i.cc]=n),o.length&&(this.unparsedVttFrags=[],o.forEach((e=>{this.onFragLoaded(r.FRAG_LOADED,e)})))}getExistingTrack(e){var{media:t}=this;if(t)for(var r=0;r<t.textTracks.length;r++){var i=t.textTracks[r];if(i[e])return i}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(!this.captionsTracks[e]){var{captionsProperties:t,captionsTracks:r,media:i}=this,{label:a,languageCode:s}=t[e],n=this.getExistingTrack(e);if(n)r[e]=n,Q(r[e]),Y(r[e],i);else{var o=this.createTextTrack("captions",a,s);o&&(o[e]=!0,r[e]=o)}}}createNonNativeTrack(e){if(!this.nonNativeCaptionsTracks[e]){var t=this.captionsProperties[e];if(t){var i={_id:e,label:t.label,kind:"captions",default:!!t.media&&!!t.media.default,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=i,this.hls.trigger(r.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[i]})}}}createTextTrack(e,t,r){var i=this.media;if(i)return i.addTextTrack(e,t,r)}onMediaAttaching(e,t){this.media=t.media,this._cleanTracks()}onMediaDetaching(){var{captionsTracks:e}=this;Object.keys(e).forEach((t=>{Q(e[t]),delete e[t]})),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastSn=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!1}},this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=this.unparsedVttFrags||[],this.initPTS=[],this.timescale=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){var{media:e}=this;if(e){var t=e.textTracks;if(t)for(var r=0;r<t.length;r++)Q(t[r])}}onSubtitleTracksUpdated(e,t){this.textTracks=[];var i=t.subtitleTracks||[],a=i.some((e=>"stpp.ttml.im1t"===e.textCodec));if(this.config.enableWebVTT||a&&this.config.enableIMSC1){var s=this.tracks&&i&&this.tracks.length===i.length;if(this.tracks=i||[],this.config.renderTextTracksNatively){var n=this.media?this.media.textTracks:[];this.tracks.forEach(((e,t)=>{var r;if(t<n.length){for(var i=null,a=0;a<n.length;a++)if(Di(n[a],e)){i=n[a];break}i&&(r=i)}r?Q(r):(r=this.createTextTrack("subtitles",e.name,e.lang))&&(r.mode="disabled"),r&&(r.groupId=e.groupId,this.textTracks.push(r))}))}else if(!s&&this.tracks&&this.tracks.length){var o=this.tracks.map((e=>({label:e.name,kind:e.type.toLowerCase(),default:e.default,subtitleTrack:e})));this.hls.trigger(r.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:o})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach((e=>{var t=/(?:CC|SERVICE)([1-4])/.exec(e.instreamId);if(t){var r="textTrack"+t[1],i=this.captionsProperties[r];i&&(i.label=e.name,e.lang&&(i.languageCode=e.lang),i.media=e)}}))}onFragLoading(e,t){var{cea608Parser1:r,cea608Parser2:i,lastSn:a}=this;if(this.enabled&&r&&i&&t.frag.type===F.MAIN){var s=t.frag.sn;s!==a+1&&(r.reset(),i.reset()),this.lastSn=s}}onFragLoaded(e,t){var{frag:i,payload:a}=t,{initPTS:s,unparsedVttFrags:n}=this;if(i.type===F.SUBTITLE)if(a.byteLength){if(!Number.isFinite(s[i.cc]))return n.push(t),void(s.length&&this.hls.trigger(r.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Missing initial subtitle PTS")}));var o=i.decryptdata;if(null==o||null==o.key||"AES-128"!==o.method){var l=this.tracks[i.level],h=this.vttCCs;h[i.cc]||(h[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),l&&"stpp.ttml.im1t"===l.textCodec?this._parseIMSC1(i,a):this._parseVTTs(i,a,h)}}else this.hls.trigger(r.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){var i=this.hls;yi(t,this.initPTS[e.cc],this.timescale[e.cc],(t=>{this._appendCues(t,e.level),i.trigger(r.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})}),(t=>{c.log("Failed to parse IMSC1: "+t),i.trigger(r.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:t})}))}_parseVTTs(e,t,i){var a=this.hls;gi(t,this.initPTS[e.cc],this.timescale[e.cc],i,e.cc,e.start,(t=>{this._appendCues(t,e.level),a.trigger(r.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})}),(i=>{this._fallbackToIMSC1(e,t),c.log("Failed to parse VTT cue: "+i),a.trigger(r.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:i})}))}_fallbackToIMSC1(e,t){var r=this.tracks[e.level];r.textCodec||yi(t,this.initPTS[e.cc],this.timescale[e.cc],(()=>{r.textCodec="stpp.ttml.im1t",this._parseIMSC1(e,t)}),(()=>{r.textCodec="wvtt"}))}_appendCues(e,t){var i=this.hls;if(this.config.renderTextTracksNatively){var a=this.textTracks[t];if("disabled"===a.mode)return;e.forEach((e=>z(a,e)))}else{var s=this.tracks[t].default?"default":"subtitles"+t;i.trigger(r.CUES_PARSED,{type:"subtitles",cues:e,track:s})}}onFragDecrypted(e,t){var{frag:i}=t;if(i.type===F.SUBTITLE){if(!Number.isFinite(this.initPTS[i.cc]))return void this.unparsedVttFrags.push(t);this.onFragLoaded(r.FRAG_LOADED,t)}}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){var{cea608Parser1:r,cea608Parser2:i}=this;if(this.enabled&&r&&i)for(var a=0;a<t.samples.length;a++){var s=t.samples[a].bytes;if(s){var n=this.extractCea608Data(s);r.addData(t.samples[a].pts,n[0]),i.addData(t.samples[a].pts,n[1])}}}onBufferFlushing(e,t){var{startOffset:r,endOffset:i,endOffsetSubtitles:a,type:s}=t,{media:n}=this;if(n&&!(n.currentTime<i)){if(!s||"video"===s){var{captionsTracks:o}=this;Object.keys(o).forEach((e=>$(o[e],r,i)))}if(this.config.renderTextTracksNatively&&0===r&&void 0!==a){var{textTracks:l}=this;Object.keys(l).forEach((e=>$(l[e],r,a)))}}}extractCea608Data(e){for(var t=31&e[0],r=2,i=[[],[]],a=0;a<t;a++){var s=e[r++],n=127&e[r++],o=127&e[r++],l=3&s;0===n&&0===o||0!=(4&s)&&(0!==l&&1!==l||(i[l].push(n),i[l].push(o)))}return i}},audioStreamController:void 0,audioTrackController:void 0,emeController:void 0});function Ni(e){var t=e.loader;t!==wi&&t!==Ii?(c.log("[config]: Custom loader detected, cannot enable progressive streaming"),e.progressive=!1):function(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(e){}return!1}()&&(e.loader=wi,e.progressive=!0,e.enableSoftwareAES=!0,c.log("[config]: Progressive streaming enabled, using FetchLoader"))}class Ui{static get version(){return custom}static isSupported(){return function(){var e=mt();if(!e)return!1;var t=pt(),r=e&&"function"==typeof e.isTypeSupported&&e.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),i=!t||t.prototype&&"function"==typeof t.prototype.appendBuffer&&"function"==typeof t.prototype.remove;return!!r&&!!i}()}static get Events(){return r}static get ErrorTypes(){return i}static get ErrorDetails(){return a}static get DefaultConfig(){return Ui.defaultConfig?Ui.defaultConfig:Mi}static set DefaultConfig(e){Ui.defaultConfig=e}constructor(e){void 0===e&&(e={}),this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new Ar.EventEmitter,this._autoLevelCapping=void 0,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this._media=null,this.url=null;var t=this.config=function(e,t){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==t.liveMaxLatencyDurationCount&&(void 0===t.liveSyncDurationCount||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==t.liveMaxLatencyDuration&&(void 0===t.liveSyncDuration||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');return Ee({},e,t)}(Ui.DefaultConfig,e);this.userConfig=e,d(t.debug),this._autoLevelCapping=-1,t.progressive&&Ni(t);var{abrController:r,bufferController:i,capLevelController:a,fpsController:s}=t,n=this.abrController=new r(this),o=this.bufferController=new i(this),l=this.capLevelController=new a(this),h=new s(this),u=new q(this),c=new X(this),f=new ve(this),g=this.levelController=new Oe(this),v=new Pe(this),m=this.streamController=new Cr(this,v);l.setStreamController(m),h.setStreamController(m);var p=[g,m];this.networkControllers=p;var T=[u,c,n,o,l,h,f,v];this.audioTrackController=this.createController(t.audioTrackController,null,p),this.createController(t.audioStreamController,v,p),this.subtitleTrackController=this.createController(t.subtitleTrackController,null,p),this.createController(t.subtitleStreamController,v,p),this.createController(t.timelineController,null,T),this.emeController=this.createController(t.emeController,null,T),this.latencyController=this.createController(me,null,T),this.coreComponents=T}createController(e,t,r){if(e){var i=t?new e(this,t):new e(this);return r&&r.push(i),i}return null}on(e,t,r){void 0===r&&(r=this),this._emitter.on(e,t,r)}once(e,t,r){void 0===r&&(r=this),this._emitter.once(e,t,r)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,r,i){void 0===r&&(r=this),this._emitter.off(e,t,r,i)}listeners(e){return this._emitter.listeners(e)}emit(e,t,r){return this._emitter.emit(e,t,r)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(t){c.error("An internal error happened while handling event "+e+'. Error message: "'+t.message+'". Here is a stacktrace:',t),this.trigger(r.ERROR,{type:i.OTHER_ERROR,details:a.INTERNAL_EXCEPTION,fatal:!1,event:e,error:t})}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){c.log("destroy"),this.trigger(r.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach((e=>e.destroy())),this.networkControllers.length=0,this.coreComponents.forEach((e=>e.destroy())),this.coreComponents.length=0}attachMedia(e){c.log("attachMedia"),this._media=e,this.trigger(r.MEDIA_ATTACHING,{media:e})}detachMedia(){c.log("detachMedia"),this.trigger(r.MEDIA_DETACHING,void 0),this._media=null}loadSource(e){this.stopLoad();var t=this.media,i=this.url,a=this.url=s.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});c.log("loadSource:"+a),t&&i&&i!==a&&this.bufferController.hasSourceTypes()&&(this.detachMedia(),this.attachMedia(t)),this.trigger(r.MANIFEST_LOADING,{url:e})}startLoad(e){void 0===e&&(e=-1),c.log("startLoad("+e+")"),this.networkControllers.forEach((t=>{t.startLoad(e)}))}stopLoad(){c.log("stopLoad"),this.networkControllers.forEach((e=>{e.stopLoad()}))}swapAudioCodec(){c.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){c.log("recoverMediaError");var e=this._media;this.detachMedia(),e&&this.attachMedia(e)}removeLevel(e,t){void 0===t&&(t=0),this.levelController.removeLevel(e,t)}get levels(){var e=this.levelController.levels;return e||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){c.log("set currentLevel:"+e),this.loadLevel=e,this.abrController.clearTimer(),this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){c.log("set nextLevel:"+e),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){c.log("set loadLevel:"+e),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){c.log("set firstLevel:"+e),this.levelController.firstLevel=e}get startLevel(){return this.levelController.startLevel}set startLevel(e){c.log("set startLevel:"+e),-1!==e&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){var t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){var{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(c.log("set autoLevelCapping:"+e),this._autoLevelCapping=e)}get autoLevelEnabled(){return-1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){var{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;for(var r=e.length,i=0;i<r;i++)if(e[i].maxBitrate>t)return i;return 0}get maxAutoLevel(){var{levels:e,autoLevelCapping:t}=this;return-1===t&&e&&e.length?e.length-1:t}get nextAutoLevel(){return Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.maxAutoLevel)}set nextAutoLevel(e){this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,e)}get audioTracks(){var e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){var e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){var t=this.audioTrackController;t&&(t.audioTrack=e)}get subtitleTracks(){var e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){var e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){var t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){var e=this.subtitleTrackController;return!!e&&e.subtitleDisplay}set subtitleDisplay(e){var t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}Ui.defaultConfig=void 0;export{Ui as default};
